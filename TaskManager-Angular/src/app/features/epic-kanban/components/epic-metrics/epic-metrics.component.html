<!-- T012 - Epic Metrics Dashboard Analytics - Accordion Layout -->
<div class="epic-metrics">

  <!-- ANALYTICS EPIC - Vue unique avec toggle interne -->
  <mat-expansion-panel class="analytics-panel"
    [expanded]="false">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>analytics</mat-icon>
        Analytics Epic
      </mat-panel-title>
      <mat-panel-description>
        <span class="current-view">{{ viewMode === 'overview' ? 'Vue d\'ensemble' : 'Analyse détaillée' }}</span>

        <!-- Toggle View Mode -->
        <button mat-icon-button
          (click)="toggleViewMode(); $event.stopPropagation()"
          [matTooltip]="viewMode === 'overview' ? 'Vue détaillée' : 'Vue synthèse'">
          <mat-icon>{{ viewMode === 'overview' ? 'view_list' : 'view_module' }}</mat-icon>
        </button>

        <!-- Export Menu -->
        <button mat-icon-button
          [matMenuTriggerFor]="exportMenu"
          matTooltip="Export"
          (click)="$event.stopPropagation()">
          <mat-icon>download</mat-icon>
        </button>
        <mat-menu #exportMenu="matMenu">
          <button mat-menu-item
            (click)="onExportMetrics()">
            <mat-icon>description</mat-icon>
            <span>Export JSON</span>
          </button>
        </mat-menu>

        <!-- Refresh -->
        <button mat-icon-button
          class="refresh-button"
          (click)="onRefresh(); $event.stopPropagation()"
          [class.refreshing]="isRefreshing"
          matTooltip="Actualiser">
          <mat-icon>refresh</mat-icon>
        </button>

        <span class="last-update">
          <mat-icon>access_time</mat-icon>
          {{ lastRefresh | date:'HH:mm:ss' }}
        </span>
      </mat-panel-description>
    </mat-expansion-panel-header>

    <!-- CONTENU CONDITIONNEL SELON LE MODE -->
    <div class="analytics-content">

      <!-- MODE OVERVIEW - Vue d'ensemble -->
      <div class="overview-section"
        *ngIf="viewMode === 'overview'">
        <div class="metrics-grid-overview">

          <!-- KPI Row -->
          <div class="kpi-row">
            <mat-card class="kpi-card progress-kpi">
              <div class="kpi-content">
                <div class="kpi-chart">
                  <canvas baseChart
                    [data]="progressChartData"
                    [type]="progressChartType"
                    [options]="progressChartOptions">
                  </canvas>
                  <div class="chart-center-value">
                    <span class="percentage">{{ taskMetrics().percentage }}%</span>
                  </div>
                </div>
                <div class="kpi-details">
                  <h3>Progression</h3>
                  <div class="kpi-breakdown">
                    <span class="completed">{{ taskMetrics().completed }} terminés</span> | <span class="remaining">{{ taskMetrics().remaining }} restants</span>
                  </div>
                </div>
              </div>
            </mat-card>

            <mat-card class="kpi-card team-kpi">
              <div class="kpi-content">
                <mat-icon class="kpi-icon">group</mat-icon>
                <div class="kpi-details">
                  <h3>Équipe</h3>
                  <div class="kpi-value">{{ teamMetrics().activeMembers }}/{{ teamMetrics().totalMembers }}</div>
                  <div class="kpi-label">membres actifs</div>
                </div>
              </div>
            </mat-card>

            <mat-card class="kpi-card velocity-kpi">
              <div class="kpi-content">
                <mat-icon class="kpi-icon">trending_up</mat-icon>
                <div class="kpi-details">
                  <h3>Vélocité</h3>
                  <div class="kpi-value">{{ velocityStats().tasksPerDay }}</div>
                  <div class="kpi-label">tâches/jour</div>
                </div>
              </div>
            </mat-card>

            <mat-card class="kpi-card time-kpi">
              <div class="kpi-content">
                <mat-icon class="kpi-icon"
                  [class.is-over-budget]="timeMetrics().isOverBudget"
                  [class.is-on-track]="!timeMetrics().isOverBudget">schedule</mat-icon>
                <div class="kpi-details">
                  <h3>Budget temps</h3>
                  <div class="kpi-value"
                    [class.is-over-budget]="timeMetrics().isOverBudget"
                    [class.is-on-track]="!timeMetrics().isOverBudget">
                    {{ (timeMetrics().efficiency * 100).toFixed(0) }}%
                  </div>
                  <div class="kpi-label">utilisé</div>
                </div>
              </div>
            </mat-card>
          </div>

          <!-- Velocity Chart -->
          <mat-card class="velocity-chart-card">
            <div class="chart-header">
              <h3><mat-icon>trending_up</mat-icon> Tendance vélocité</h3>
            </div>
            <div class="chart-container">
              <canvas baseChart
                [data]="velocityChartData"
                [type]="velocityChartType"
                [options]="velocityChartOptions">
              </canvas>
            </div>
          </mat-card>

        </div>
      </div>

      <!-- MODE DETAILED - Analyse détaillée -->
      <div class="detailed-section"
        *ngIf="viewMode === 'detailed'">
        <div class="metrics-grid-detailed">

          <!-- CARD 1: PROGRESSION DÉTAILLÉE -->
          <mat-card class="metric-card progress-card">
            <div class="card-header">
              <div class="card-title">
                <h3><mat-icon class="card-icon icon-progress">donut_small</mat-icon> Progression détaillée</h3>
                <div class="card-subtitle">Répartition par statut</div>
              </div>
              <div class="card-percentage text-progress">{{ taskMetrics().percentage }}%</div>
            </div>
            <mat-card-content>
              <mat-progress-bar class="main-progress"
                [value]="taskMetrics().percentage"
                color="primary">
              </mat-progress-bar>

              <div class="progress-breakdown">
                <div class="breakdown-item completed">
                  <span class="count">{{ taskMetrics().completed }}</span>
                  <span class="label">Terminé</span>
                </div>
                <div class="breakdown-item in-progress">
                  <span class="count">{{ taskMetrics().inProgress }}</span>
                  <span class="label">En cours</span>
                </div>
                <div class="breakdown-item review">
                  <span class="count">{{ taskMetrics().review }}</span>
                  <span class="label">Révision</span>
                </div>
                <div class="breakdown-item pending">
                  <span class="count">{{ taskMetrics().pending }}</span>
                  <span class="label">En attente</span>
                </div>
              </div>

              <!-- Alertes tâches -->
              <div class="progress-alerts"
                *ngIf="taskMetrics().overdue > 0">
                <mat-chip color="warn"
                  selected>
                  {{ taskMetrics().overdue }} en retard
                </mat-chip>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- CARD 2: FEATURES AVANCÉES -->
          <mat-card class="metric-card feature-card">
            <div class="card-header">
              <div class="card-title">
                <h3><mat-icon class="card-icon icon-features">view_module</mat-icon> Features Analytics</h3>
                <div class="card-subtitle">Métriques avancées</div>
              </div>
            </div>
            <mat-card-content>
              <div class="feature-stats">
                <div class="stat-item">
                  <div class="stat-value">{{ featureMetrics().total }}</div>
                  <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value completed">{{ featureMetrics().completed }}</div>
                  <div class="stat-label">Terminées</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value in-progress">{{ featureMetrics().inProgress }}</div>
                  <div class="stat-label">En cours</div>
                </div>
              </div>

              <mat-divider class="my-3"></mat-divider>

              <div class="feature-metrics">
                <div class="metric-row">
                  <span class="metric-label">Moyenne tâches/feature</span>
                  <span class="metric-value">{{ featureMetrics().avgTasksPerFeature }}</span>
                </div>
                <div class="metric-row"
                  *ngIf="featureMetrics().blockedFeatures > 0">
                  <span class="metric-label">Features bloquées</span>
                  <span class="metric-value text-red-600">{{ featureMetrics().blockedFeatures }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- CARD 3: TEMPS & BUDGET -->
          <mat-card class="metric-card time-card">
            <div class="card-header">
              <div class="card-title">
                <h3>Budget & Performance</h3>
                <div class="card-subtitle">Gestion du temps</div>
              </div>
            </div>
            <mat-card-content>
              <div class="time-metrics">
                <div class="metric-row">
                  <span class="metric-label">Heures estimées</span>
                  <span class="metric-value">{{ timeMetrics().estimatedHours }}h</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Heures réelles</span>
                  <span class="metric-value">{{ timeMetrics().actualHours }}h</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Efficacité</span>
                  <span class="metric-value"
                    [class.text-green-600]="timeMetrics().efficiency <= 1"
                    [class.text-red-600]="timeMetrics().efficiency > 1">
                    {{ (timeMetrics().efficiency * 100).toFixed(0) }}%
                  </span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- CARD 4: ANALYTICS ÉQUIPE -->
          <mat-card class="metric-card team-card">
            <div class="card-header">
              <div class="card-title">
                <h3>Analytics Équipe</h3>
                <div class="card-subtitle">Performance collective</div>
              </div>
            </div>
            <mat-card-content>
              <div class="team-stats">
                <div class="stat-item">
                  <div class="stat-value">{{ teamMetrics().totalMembers }}</div>
                  <div class="stat-label">Membres</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">{{ teamMetrics().activeMembers }}</div>
                  <div class="stat-label">Actifs</div>
                </div>
                <div class="stat-item"
                  *ngIf="teamMetrics().topPerformer">
                  <div class="stat-value">{{ teamMetrics().topPerformer }}</div>
                  <div class="stat-label">Top Performer</div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

        </div>
      </div>

      <!-- RÉSUMÉ & PROJECTIONS - Visible dans les deux modes -->
      <div class="summary-section">
        <mat-divider class="summary-divider"></mat-divider>
        <mat-card class="summary-card">
          <mat-card-header>
            <div class="summary-header">
              <mat-icon>insights</mat-icon>
              <h3>Résumé & Projections</h3>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="summary-stats">
              <div class="summary-item">
                <div class="summary-value">{{ taskMetrics().remaining }}</div>
                <div class="summary-label">tâches restantes à terminer</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">{{ velocityStats().daysRemaining }}</div>
                <div class="summary-label">jours estimés pour terminer</div>
              </div>
              <div class="summary-item"
                *ngIf="velocityStats().projectedCompletion">
                <div class="summary-value">{{ velocityStats().projectedCompletion | date:'dd/MM' }}</div>
                <div class="summary-label">fin projetée</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">{{ velocityStats().sprintVelocity }}</div>
                <div class="summary-label">pts vélocité sprint</div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

    </div>
  </mat-expansion-panel>

  <!-- ALERTES SYSTÈME -->
  <mat-expansion-panel class="alerts-panel"
    *ngIf="alerts().length > 0">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon class="alert-icon"
          [class.text-red-600]="hasAlertType('danger')"
          [class.text-orange-500]="hasAlertType('warning')"
          [class.text-blue-500]="hasOnlyInfoAlerts()">
          warning
        </mat-icon>
        Alertes Système
        <mat-chip class="alert-count">{{ alerts().length }}</mat-chip>
      </mat-panel-title>
      <mat-panel-description>
        Notifications et alertes importantes
      </mat-panel-description>
    </mat-expansion-panel-header>

    <div class="alerts-list">
      <mat-card class="alert-card"
        *ngFor="let alert of alerts(); trackBy: trackAlert"
        [class]="'alert-' + alert.type">
        <mat-card-content>
          <div class="alert-content">
            <div class="alert-info">
              <mat-icon [class]="'text-' + getAlertIconColor(alert.type)">
                {{ getAlertIcon(alert.type) }}
              </mat-icon>
              <div class="alert-text">
                <h4>{{ alert.title }}</h4>
                <p>{{ alert.message }}</p>
                <span class="alert-time">{{ alert.timestamp | date:'medium' }}</span>
              </div>
            </div>
            <div class="alert-actions"
              *ngIf="alert.actionable">
              <button mat-icon-button
                color="primary"
                (click)="onAlertAction(alert.id, 'dismiss')"
                matTooltip="Marquer comme lu">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-expansion-panel>

</div>
