<div class="search-filters">
  
  <!-- 1. RECHERCHE GLOBALE (toujours visible et prioritaire) -->
  <div class="search-section">
    <div class="form-group">
      <label for="search-input">Rechercher features et tâches</label>
      <div class="search-input-container">
        <mat-icon class="search-icon">search</mat-icon>
        <input 
          id="search-input"
          type="text"
          [value]="searchText()"
          (input)="onSearchChange($any($event.target).value)"
          placeholder="Titre, numéro (#T123), tags..."
          aria-label="Rechercher dans les features et tâches">
        <button 
          *ngIf="searchText()"
          type="button"
          class="clear-search"
          (click)="clearSearch()"
          aria-label="Effacer la recherche">
          <mat-icon>clear</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- 2. FILTRES RAPIDES VISUELS (toujours visibles) -->
  <div class="quick-filters-section">
    <h3 class="quick-filters-title">
      <mat-icon>tune</mat-icon>
      Filtres rapides
    </h3>
    
    <div class="quick-filters-grid">
      <!-- Filtres Priorité -->
      <div class="filter-group">
        <span class="filter-group-label">Priorité</span>
        <div class="filter-buttons">
          <button 
            *ngFor="let option of quickPriorityFilters()" 
            mat-stroked-button
            [color]="option.isActive ? 'primary' : ''"
            [class.active]="option.isActive"
            (click)="onQuickPriorityFilter(option.value)"
            [title]="option.label">
            <mat-icon [style.color]="option.color">{{ option.icon }}</mat-icon>
            <span>{{ option.label }}</span>
          </button>
        </div>
      </div>

      <!-- Filtres Statut -->
      <div class="filter-group">
        <span class="filter-group-label">Statut</span>
        <div class="filter-buttons">
          <button 
            *ngFor="let option of quickStatusFilters()" 
            mat-stroked-button
            [color]="option.isActive ? 'primary' : ''"
            [class.active]="option.isActive"
            (click)="onQuickStatusFilter(option.value)"
            [title]="option.label">
            <mat-icon [style.color]="option.color">{{ option.icon }}</mat-icon>
            <span>{{ option.label }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. FILTRES AVANCÉS (expandable) -->
  <mat-expansion-panel 
    class="advanced-filters-panel"
    [expanded]="isExpanded()"
    (expandedChange)="toggleExpanded()">
    
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>filter_list</mat-icon>
        <span>Filtres avancés</span>
        <mat-chip 
          *ngIf="hasAdvancedFilters()" 
          class="filters-count-chip">
          {{ advancedFiltersCount() }}
        </mat-chip>
      </mat-panel-title>
    </mat-expansion-panel-header>

    <!-- Contenu des filtres avancés -->
    <div class="advanced-filters-content">
      <form class="advanced-filters-form">
        <div class="form-row advanced-inline-row">
          <!-- Filtre par assigné -->
          <div class="form-group">
            <label for="assigned-filter">
              <mat-icon>person</mat-icon>
              Assigné à
            </label>
            <select 
              id="assigned-filter"
              [value]="assigneeFilter()"
              (change)="onAssigneeChange($any($event.target).value)">
              <option value="">Tous les utilisateurs</option>
              <option value="unassigned">Non assigné</option>
              <option *ngFor="let user of availableUsers()" [value]="user.id">
                {{ user.email }}
              </option>
            </select>
          </div>

          <!-- Filtre par environnement -->
          <div class="form-group">
            <label for="environment-filter">
              <mat-icon>cloud</mat-icon>
              Environnement
            </label>
            <select 
              id="environment-filter"
              [value]="environmentFilter()"
              (change)="onEnvironmentChange($any($event.target).value)">
              <option value="">Tous les environnements</option>
              <option *ngFor="let option of environmentOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>

          <!-- Gestion des tags -->
          <div class="form-group">
            <label for="tag-filter">
              <mat-icon>label</mat-icon>
              Tags
            </label>
            <select 
              id="tag-filter"
              (change)="onTagAdd($any($event.target).value); $any($event.target).value = ''">
              <option value="">Ajouter un tag...</option>
              <option *ngFor="let tag of uniqueTags()" [value]="tag">
                {{ tag }}
              </option>
            </select>
          </div>

          <!-- Tags actifs sur la même ligne -->
          <div class="tags-active-section" *ngIf="tagsFilter().length > 0">
            <div class="tags-container">
              <mat-chip 
                *ngFor="let tag of tagsFilter()" 
                class="tag-chip"
                (removed)="onTagRemove(tag)">
                {{ tag }}
                <mat-icon matChipRemove>cancel</mat-icon>
              </mat-chip>
            </div>
          </div>
        </div>
      </form>
    </div>

  </mat-expansion-panel>

  <!-- 4. RÉSUMÉ DES FILTRES ACTIFS -->
  <div class="active-filters-summary" *ngIf="hasActiveFilters()">
    <div class="summary-header">
      <div class="summary-info">
        <mat-icon>filter_alt</mat-icon>
        <span class="summary-count">{{ activeFiltersCount() }} filtre(s) actif(s)</span>
      </div>
      <button 
        mat-button 
        color="warn"
        class="btn-clear-all"
        (click)="clearAllFilters()">
        <mat-icon>clear_all</mat-icon>
        Tout effacer
      </button>
    </div>
    
    <div class="summary-items">
      <mat-chip 
        *ngIf="searchText()"
        class="summary-chip"
        (removed)="clearSearch()">
        <mat-icon>search</mat-icon>
        Recherche: "{{ searchText() }}"
        <mat-icon matChipRemove>cancel</mat-icon>
      </mat-chip>
      
      <mat-chip 
        *ngIf="priorityFilter()"
        class="summary-chip"
        (removed)="onQuickPriorityFilter('')">
        <mat-icon [style.color]="getPriorityColor(priorityFilter())">
          {{ getPriorityIcon(priorityFilter()) }}
        </mat-icon>
        Priorité: {{ activePriorityLabel() }}
        <mat-icon matChipRemove>cancel</mat-icon>
      </mat-chip>
      
      <mat-chip 
        *ngIf="statusFilter()"
        class="summary-chip"
        (removed)="onQuickStatusFilter('')">
        <mat-icon [style.color]="getStatusColor(statusFilter())">
          {{ getStatusIcon(statusFilter()) }}
        </mat-icon>
        Statut: {{ activeStatusLabel() }}
        <mat-icon matChipRemove>cancel</mat-icon>
      </mat-chip>
      
      <mat-chip 
        *ngIf="assigneeFilter()"
        class="summary-chip"
        (removed)="onAssigneeChange('')">
        <mat-icon>person</mat-icon>
        Assigné: {{ activeAssigneeLabel() }}
        <mat-icon matChipRemove>cancel</mat-icon>
      </mat-chip>
      
      <mat-chip 
        *ngIf="environmentFilter()"
        class="summary-chip"
        (removed)="onEnvironmentChange('')">
        <mat-icon>cloud</mat-icon>
        Environnement: {{ activeEnvironmentLabel() }}
        <mat-icon matChipRemove>cancel</mat-icon>
      </mat-chip>
      
      <mat-chip 
        *ngFor="let tag of tagsFilter()"
        class="summary-chip"
        (removed)="onTagRemove(tag)">
        <mat-icon>label</mat-icon>
        Tag: {{ tag }}
        <mat-icon matChipRemove>cancel</mat-icon>
      </mat-chip>
    </div>
  </div>

</div> 