<mat-card 
  class="feature-card"
  [class.dragging]="isDragging"
  [class.overdue]="isOverdue"
  [class.has-active-tasks]="hasActiveTasks"
  (click)="onCardClick()"
  [attr.aria-label]="'Feature: ' + feature.title"
  role="button"
  tabindex="0">

  <mat-card-header>
    <div class="w-full flex items-start justify-between">
      
      <div class="flex items-center gap-2">
        <span class="feature-card__type-badge"
              [style.color]="typeConfig.color" 
              [style.backgroundColor]="typeConfig.bgColor" 
              [style.borderColor]="typeConfig.borderColor"
              [matTooltip]="typeConfig.label">
          {{ feature.type.toUpperCase() }}
        </span>
        <span *ngIf="feature.task_number" 
              class="feature-card__task-number"
              [matTooltip]="'Numéro de tâche'">
          #{{ feature.task_number }}
        </span>
      </div>

      <button mat-icon-button
              [matMenuTriggerFor]="actionsMenu"
              class="feature-card__actions-btn"
              (click)="$event.stopPropagation()"
              [matTooltip]="'Actions'"
              aria-label="Menu d'actions">
        <mat-icon>more_vert</mat-icon>
      </button>

      <mat-menu #actionsMenu="matMenu">
        <button mat-menu-item (click)="onEditClick($event)" [attr.aria-label]="'Modifier ' + feature.title">
          <mat-icon>edit</mat-icon>
          <span>Modifier</span>
        </button>
        <button mat-menu-item (click)="onAddTaskClick($event)" [attr.aria-label]="'Ajouter une tâche à ' + feature.title">
          <mat-icon>add_task</mat-icon>
          <span>Ajouter une tâche</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item 
                (click)="onDeleteClick($event)" 
                class="text-red-600"
                [attr.aria-label]="'Supprimer ' + feature.title">
          <mat-icon>delete</mat-icon>
          <span>Supprimer</span>
        </button>
      </mat-menu>

    </div>
  </mat-card-header>

  <mat-card-content>
    
    <h4 class="feature-card__title line-clamp-2" 
        [matTooltip]="feature.title.length > 60 ? feature.title : null">
      {{ feature.title }}
    </h4>

    <p *ngIf="feature.description" 
       class="feature-card__description line-clamp-2"
       [matTooltip]="feature.description.length > 100 ? feature.description : null">
      {{ feature.description }}
    </p>

    <div class="feature-card__metadata">
      
      <div class="flex items-center gap-3">
        <div class="meta-item" [style.color]="statusConfig.color" [matTooltip]="statusConfig.label">
          <mat-icon>{{ statusConfig.icon }}</mat-icon>
          <span class="sr-only">{{ statusConfig.label }}</span>
        </div>
        
        <div class="meta-item" [style.color]="priorityConfig.color" [matTooltip]="'Priorité: ' + priorityConfig.label">
          <mat-icon>{{ priorityConfig.icon }}</mat-icon>
          <span class="sr-only">Priorité {{ priorityConfig.label }}</span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <span *ngIf="feature.assigned_to"
              class="meta-item max-w-20 truncate"
              [matTooltip]="'Assigné à: ' + feature.assigned_to">
          <mat-icon>person</mat-icon>
          <span class="truncate">{{ formatAssignee(feature.assigned_to) }}</span>
        </span>
        
        <span *ngIf="feature.due_date"
              class="meta-item"
              [class.meta-item--overdue]="isOverdue"
              [matTooltip]="'Échéance: ' + formatDate(feature.due_date)">
          <mat-icon>event</mat-icon>
          <span>{{ formatDate(feature.due_date) }}</span>
        </span>
      </div>
    </div>

    <div *ngIf="showProgress && tasks.length > 0" class="progress-section">
      <div class="progress-header">
        <span class="progress-label">Progression</span>
        <div class="progress-actions">
          <span class="progress-count" [matTooltip]="completionRate">
            {{ featureProgress.completed }}/{{ featureProgress.total }} 
            ({{ featureProgress.percentage }}%)
          </span>
          <button mat-icon-button 
                  class="expand-button"
                  (click)="onToggleExpansion($event)"
                  [matTooltip]="isExpanded ? 'Réduire les tâches' : 'Voir les tâches (' + tasks.length + ')'"
                  [attr.aria-label]="isExpanded ? 'Réduire les tâches' : 'Développer les tâches'"
                  [attr.aria-expanded]="isExpanded">
            <mat-icon class="expand-icon" [class.expanded]="isExpanded">
              {{ isExpanded ? 'expand_less' : 'expand_more' }}
            </mat-icon>
          </button>
        </div>
      </div>
      <mat-progress-bar 
        mode="determinate" 
        [value]="featureProgress.percentage"
        class="progress-bar"
        [class.progress-completed]="featureProgress.percentage === 100"
        [class.progress-active]="hasActiveTasks"
        [attr.aria-label]="'Progression: ' + featureProgress.percentage + '%'">
      </mat-progress-bar>
    </div>

    <div *ngIf="feature.tags && feature.tags.length > 0" class="feature-card__tags">
      <mat-chip *ngFor="let tag of feature.tags.slice(0, 3); trackBy: trackTag" 
                class="tag-chip"
                [matTooltip]="tag">
        {{ tag }}
      </mat-chip>
      <span *ngIf="feature.tags.length > 3" 
            class="more-tags-indicator"
            [matTooltip]="'Tags supplémentaires: ' + feature.tags.slice(3).join(', ')">
        +{{ feature.tags.length - 3 }}
      </span>
    </div>

  </mat-card-content>

  <div class="feature-card__tasks" [@expandCollapse]="isExpanded ? 'expanded' : 'collapsed'">
    <div class="feature-card__tasks-header">
      <h4 class="feature-card__tasks-title">
        <mat-icon>assignment</mat-icon>
        Tâches associées ({{ tasks.length }})
      </h4>
      <p class="feature-card__tasks-subtitle">Cliquez sur une tâche pour voir les détails</p>
    </div>
    
    <div class="feature-card__tasks-list" *ngIf="tasks.length > 0; else noTasks">
      <app-task-badge
        *ngFor="let task of tasks; trackBy: trackTask"
        [task]="task"
        [showQuickActions]="true"
        [enableNavigation]="true"
        (taskClick)="onTaskClick($event)"
        (statusChange)="onTaskStatusChange($event)"
        (priorityChange)="onTaskPriorityChange($event)"
        (taskEdit)="onTaskEdit($event)"
        (taskDelete)="onTaskDelete($event)"
        class="feature-card__task-item"
        [ngClass]="{'highlighted-task': highlightedTaskIds.includes(task.id || '')}">
      </app-task-badge>
    </div>

    <ng-template #noTasks>
      <div class="feature-card__no-tasks">
        <mat-icon class="feature-card__no-tasks-icon">inbox</mat-icon>
        <p class="feature-card__no-tasks-text">Aucune tâche associée à cette feature</p>
      </div>
    </ng-template>
  </div>

</mat-card> 