<div class="epic-kanban-container">

  @if (currentEpicItem(); as epic) {
  <app-item-header [item]="epic"
    [metrics]="(metrics$ | async)!"
    [canEdit]="true"
    (navigateBack)="onNavigateBack()"
    (refreshBoard)="onRefreshBoard()"
    (editItem)="onEditItem($event)"
    (saveItem)="onSaveItem($event)"
    (deleteItem)="onDeleteItem($event)"
    (exportBoard)="onExportBoard()"
    (shareBoard)="onShareBoard()">
  </app-item-header>
  }

  <!-- Navigation Button -->
  <div class="navigation-buttons mb-4 flex gap-2">
    <button mat-raised-button 
            color="primary"
            (click)="onNavigateToDashboard()"
            class="nav-button">
      <mat-icon>dashboard</mat-icon>
      Retour au Dashboard
    </button>
  </div>

  <!-- Section des filtres -->
  <app-search-filters></app-search-filters>

  <!-- Métriques en haut -->
  <app-epic-metrics *ngIf="(currentEpic$ | async) && (metrics$ | async)"
    [epic]="(currentEpic$ | async)!"
    [features]="(features$ | async) || []"
    [tasks]="(tasks$ | async) || []"
    [metrics]="(metrics$ | async)!">
  </app-epic-metrics>

  <!-- État de chargement -->
  <div *ngIf="loading$ | async"
    class="loading-state">
    <div class="loading-content">
      <mat-icon class="loading-spinner">hourglass_empty</mat-icon>
      <span>Chargement du tableau Kanban...</span>
    </div>
  </div>

  <!-- État d'erreur -->
  <div *ngIf="error$ | async"
    class="error-state">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h3>Erreur de chargement</h3>
    <p>{{ error$ | async }}</p>
    <button mat-raised-button
      color="primary"
      (click)="retryLoad()">
      <mat-icon>refresh</mat-icon>
      Réessayer
    </button>
  </div>

  <!-- Tableau Kanban -->
  @if (!(loading$ | async) && !(error$ | async) && (columns$ | async); as columns) {
  <app-generic-kanban [columns]="columns"
    [items]="(featuresAsKanbanItems$ | async) || []"
    [loading]="(loading$ | async) || false"
    [error]="(error$ | async)"
    (itemDropped)="onFeatureMove($event)"
    (itemEdited)="onFeatureEdit($event)"
    (itemDeleted)="onFeatureDelete($event)"
    (retryLoad)="onRefreshBoard()"></app-generic-kanban>
  }

</div>
