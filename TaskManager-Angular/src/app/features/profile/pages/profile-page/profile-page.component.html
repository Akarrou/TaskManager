<div class="c-profile-layout">
  <div class="c-profile-container">
    <!-- Header avec bouton retour -->
    <div class="c-profile-header">
      <button class="c-back-btn" (click)="goBack()" type="button">
        <span class="material-icons-outlined">arrow_back</span>
        <span>Retour</span>
      </button>
      <h1 class="c-profile-title">Mon profil</h1>
    </div>

    <!-- Loading state -->
    <div class="c-loading" *ngIf="loading()">
      <span class="c-spinner c-spinner--large"></span>
      <span>Chargement...</span>
    </div>

    <!-- Content -->
    <div class="c-profile-content" *ngIf="!loading()">
      <!-- Card Informations du profil -->
      <div class="c-profile-card">
        <div class="c-profile-card__header">
          <span class="material-icons-outlined c-card-icon">person</span>
          <h2 class="c-card-title">Informations personnelles</h2>
        </div>
        <div class="c-profile-card__content">
          <!-- Email (readonly) -->
          <div class="c-form-group">
            <label class="c-label" for="email">Adresse Email</label>
            <div class="c-input-wrapper">
              <span class="material-icons-outlined c-input-icon">email</span>
              <input
                class="c-input c-input--readonly"
                id="email"
                type="email"
                [value]="profile()?.email"
                readonly
                disabled
              />
            </div>
            <span class="c-hint">L'adresse email ne peut pas être modifiée</span>
          </div>

          <!-- Nom complet -->
          <div class="c-form-group">
            <label class="c-label" for="fullName">Nom complet</label>
            <div class="c-input-wrapper">
              <span class="material-icons-outlined c-input-icon">badge</span>
              <input
                class="c-input"
                id="fullName"
                type="text"
                [ngModel]="fullName()"
                (ngModelChange)="fullName.set($event)"
                placeholder="Votre nom complet"
                [disabled]="profileLoading()"
              />
            </div>
          </div>

          <!-- Messages -->
          <div class="c-success-message" *ngIf="success()">
            <span class="material-icons-outlined">check_circle</span>
            <span>{{ success() }}</span>
          </div>

          <div class="c-error-message" *ngIf="error()">
            <span class="material-icons-outlined">error_outline</span>
            <span>{{ error() }}</span>
          </div>

          <!-- Action -->
          <div class="c-form-actions">
            <button
              class="c-btn c-btn--primary"
              type="button"
              (click)="updateProfile()"
              [disabled]="profileLoading()"
            >
              @if (profileLoading()) {
                <span class="c-spinner"></span>
                <span>Enregistrement...</span>
              } @else {
                <span class="material-icons-outlined">save</span>
                <span>Enregistrer</span>
              }
            </button>
          </div>
        </div>
      </div>

      <!-- Card Changement de mot de passe -->
      <div class="c-profile-card">
        <div class="c-profile-card__header">
          <span class="material-icons-outlined c-card-icon">lock</span>
          <h2 class="c-card-title">Changer le mot de passe</h2>
        </div>
        <div class="c-profile-card__content">
          <!-- Nouveau mot de passe -->
          <div class="c-form-group">
            <label class="c-label" for="newPassword">Nouveau mot de passe</label>
            <div class="c-input-wrapper">
              <span class="material-icons-outlined c-input-icon">lock</span>
              <input
                class="c-input"
                id="newPassword"
                type="password"
                [ngModel]="newPassword()"
                (ngModelChange)="newPassword.set($event)"
                placeholder="••••••••"
                [disabled]="passwordLoading()"
                autocomplete="new-password"
              />
            </div>
          </div>

          <!-- Confirmation -->
          <div class="c-form-group">
            <label class="c-label" for="confirmPassword">Confirmer le mot de passe</label>
            <div class="c-input-wrapper">
              <span class="material-icons-outlined c-input-icon">lock_reset</span>
              <input
                class="c-input"
                id="confirmPassword"
                type="password"
                [ngModel]="confirmPassword()"
                (ngModelChange)="confirmPassword.set($event)"
                placeholder="••••••••"
                [disabled]="passwordLoading()"
                autocomplete="new-password"
              />
            </div>
          </div>

          <!-- Messages -->
          <div class="c-success-message" *ngIf="passwordSuccess()">
            <span class="material-icons-outlined">check_circle</span>
            <span>{{ passwordSuccess() }}</span>
          </div>

          <div class="c-error-message" *ngIf="passwordError()">
            <span class="material-icons-outlined">error_outline</span>
            <span>{{ passwordError() }}</span>
          </div>

          <!-- Action -->
          <div class="c-form-actions">
            <button
              class="c-btn c-btn--primary"
              type="button"
              (click)="changePassword()"
              [disabled]="passwordLoading() || !newPassword() || !confirmPassword()"
            >
              @if (passwordLoading()) {
                <span class="c-spinner"></span>
                <span>Modification...</span>
              } @else {
                <span class="material-icons-outlined">lock_reset</span>
                <span>Changer le mot de passe</span>
              }
            </button>
          </div>
        </div>
      </div>

      <!-- Intégrations -->
      <div class="c-profile-card c-profile-card--integrations">
        <div class="c-profile-card__header">
          <span class="material-icons-outlined c-card-icon">sync</span>
          <h2 class="c-card-title">Intégrations</h2>
        </div>
        <div class="c-profile-card__content">
          <app-google-calendar-connect></app-google-calendar-connect>
          @if (gcalStore.isConnected()) {
            <app-google-calendar-settings></app-google-calendar-settings>
          }
        </div>
      </div>

      <!-- Informations du compte -->
      <div class="c-profile-card c-profile-card--info">
        <div class="c-profile-card__header">
          <span class="material-icons-outlined c-card-icon">info</span>
          <h2 class="c-card-title">Informations du compte</h2>
        </div>
        <div class="c-profile-card__content">
          <div class="c-info-grid">
            <div class="c-info-item">
              <span class="c-info-label">Compte créé le</span>
              <span class="c-info-value">{{ profile()?.created_at | date:'dd/MM/yyyy à HH:mm' }}</span>
            </div>
            <div class="c-info-item">
              <span class="c-info-label">Dernière mise à jour</span>
              <span class="c-info-value">{{ profile()?.updated_at | date:'dd/MM/yyyy à HH:mm' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration MCP Server -->
      <div class="c-profile-card c-profile-card--mcp">
        <div class="c-profile-card__header">
          <span class="material-icons-outlined c-card-icon">terminal</span>
          <h2 class="c-card-title">Configuration MCP Server</h2>
        </div>
        <div class="c-profile-card__content">
          <p class="c-mcp-description">
            Connectez Claude Code au serveur MCP Kodo pour gérer vos projets, documents et tâches directement depuis l'assistant IA.
          </p>

          <!-- Email (readonly) -->
          <div class="c-form-group">
            <label class="c-label">Email (identifiant)</label>
            <div class="c-input-wrapper">
              <span class="material-icons-outlined c-input-icon">email</span>
              <input
                class="c-input c-input--readonly"
                type="text"
                [value]="profile()?.email"
                readonly
              />
            </div>
            <span class="c-hint">Votre email sert d'identifiant pour l'authentification MCP</span>
          </div>

          <!-- Password input for token generation -->
          <div class="c-form-group">
            <label class="c-label" for="mcpPassword">Mot de passe (pour générer le token)</label>
            <div class="c-input-wrapper">
              <span class="material-icons-outlined c-input-icon">lock</span>
              <input
                class="c-input"
                id="mcpPassword"
                [type]="showMcpPassword() ? 'text' : 'password'"
                [ngModel]="mcpPassword()"
                (ngModelChange)="mcpPassword.set($event)"
                placeholder="Entrez votre mot de passe Kodo"
                autocomplete="current-password"
              />
              <button
                class="c-visibility-btn"
                type="button"
                (click)="toggleMcpPasswordVisibility()"
                title="Afficher/masquer le mot de passe"
              >
                <span class="material-icons-outlined">
                  {{ showMcpPassword() ? 'visibility_off' : 'visibility' }}
                </span>
              </button>
            </div>
            <span class="c-hint">Entrez votre mot de passe pour générer automatiquement le token d'authentification. Le mot de passe n'est pas stocké.</span>
          </div>

          <!-- Generated Basic Auth Token -->
          @if (getMcpBasicAuthToken()) {
            <div class="c-form-group">
              <label class="c-label">Token d'authentification</label>
              <div class="c-input-wrapper c-input-wrapper--copyable">
                <span class="material-icons-outlined c-input-icon">key</span>
                <input
                  class="c-input c-input--readonly c-input--mono"
                  type="text"
                  [value]="'Basic ' + getMcpBasicAuthToken()"
                  readonly
                />
                <button
                  class="c-copy-btn"
                  type="button"
                  (click)="copyToClipboard('Basic ' + getMcpBasicAuthToken(), 'authToken')"
                  title="Copier le token"
                >
                  <span class="material-icons-outlined">
                    {{ copiedField() === 'authToken' ? 'check' : 'content_copy' }}
                  </span>
                </button>
              </div>
            </div>
          }

          <!-- Configuration mcp.json -->
          <div class="c-form-group">
            <label class="c-label">Configuration MCP</label>
            <div class="c-code-block">
              <div class="c-code-block__header">
                <span class="c-code-block__filename">.mcp.json</span>
                <button
                  class="c-copy-btn"
                  type="button"
                  (click)="copyToClipboard(getMcpJsonConfig(), 'mcpConfig')"
                  title="Copier la configuration"
                  [disabled]="!getMcpBasicAuthToken()"
                >
                  <span class="material-icons-outlined">
                    {{ copiedField() === 'mcpConfig' ? 'check' : 'content_copy' }}
                  </span>
                </button>
              </div>
              <pre class="c-code-block__content"><code>{{ getMcpJsonConfig() }}</code></pre>
            </div>
            @if (!getMcpBasicAuthToken()) {
              <span class="c-hint c-hint--warning">
                <span class="material-icons-outlined">warning</span>
                Entrez votre mot de passe ci-dessus pour générer une configuration valide
              </span>
            }
          </div>

          <!-- Instructions -->
          <div class="c-mcp-instructions">
            <h3 class="c-mcp-instructions__title">
              <span class="material-icons-outlined">help_outline</span>
              Instructions
            </h3>
            <ol class="c-mcp-instructions__list">
              <li>Entrez votre mot de passe Kodo ci-dessus pour générer le token d'authentification</li>
              <li>Copiez la configuration générée</li>
              <li>Collez-la dans votre fichier <code>.mcp.json</code> (Claude Code) ou <code>claude_desktop_config.json</code> (Claude Desktop)</li>
              <li>Redémarrez Claude Code pour appliquer les changements</li>
            </ol>
            <div class="c-mcp-instructions__note">
              <span class="material-icons-outlined">security</span>
              <span>Le serveur MCP utilise votre compte Kodo pour l'authentification. Vos données restent privées et associées à votre compte.</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Tokens API (Alternative plus securisee) -->
      <div class="c-profile-card c-profile-card--tokens">
        <div class="c-profile-card__header">
          <span class="material-icons-outlined c-card-icon">vpn_key</span>
          <h2 class="c-card-title">Tokens API (Alternative)</h2>
        </div>
        <div class="c-profile-card__content">
          <p class="c-mcp-description">
            Creez des tokens d'acces personnels pour vous authentifier au serveur MCP sans exposer votre mot de passe.
            Les tokens sont plus securises car ils peuvent etre revoques individuellement et avoir une date d'expiration.
          </p>

          <!-- Token Creation -->
          <app-api-token-create (tokenCreated)="onTokenCreated()"></app-api-token-create>

          <!-- Token List -->
          <app-api-token-list></app-api-token-list>

          <!-- Usage Instructions -->
          <div class="c-mcp-instructions">
            <h3 class="c-mcp-instructions__title">
              <span class="material-icons-outlined">help_outline</span>
              Utilisation du token
            </h3>
            <p class="c-mcp-instructions__text">
              Remplacez l'en-tete <code>Authorization</code> dans votre configuration MCP par:
            </p>
            <div class="c-code-block">
              <div class="c-code-block__header">
                <span class="c-code-block__filename">Bearer Token</span>
              </div>
              <pre class="c-code-block__content"><code>"Authorization": "Bearer kodo_votre_token_ici"</code></pre>
            </div>
            <div class="c-mcp-instructions__note">
              <span class="material-icons-outlined">info</span>
              <span>Les tokens API offrent une alternative plus securisee au Basic Auth. Vous pouvez utiliser l'une ou l'autre methode.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
