<div class="recurrence-picker">
  <!-- Toggle: enabled / disabled -->
  <mat-button-toggle-group
    [value]="enabled() ? 'enabled' : 'disabled'"
    (change)="onEnabledChange($event.value)"
    [disabled]="isDisabled()"
    class="recurrence-toggle"
  >
    <mat-button-toggle value="disabled">Ne se répète pas</mat-button-toggle>
    <mat-button-toggle value="enabled">Se répète</mat-button-toggle>
  </mat-button-toggle-group>

  @if (enabled()) {
    <div class="recurrence-options">
      <!-- Frequency selector -->
      <div class="recurrence-row">
        <label class="recurrence-label" for="recurrenceFrequency">Fréquence</label>
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="recurrence-select">
          <mat-select
            id="recurrenceFrequency"
            [value]="frequency()"
            (selectionChange)="onFrequencyChange($event.value)"
            [disabled]="isDisabled()"
          >
            @for (option of frequencyChoices; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Interval -->
      <div class="recurrence-row recurrence-row--inline">
        <span class="recurrence-text">Tous les</span>
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="recurrence-number">
          <input
            matInput
            type="number"
            min="1"
            [value]="interval()"
            (input)="onIntervalChange($event)"
            [disabled]="isDisabled()"
          />
        </mat-form-field>
        <span class="recurrence-text">{{ currentUnitLabel() }}</span>
      </div>

      <!-- Weekly: day checkboxes -->
      @if (frequency() === 'weekly') {
        <div class="recurrence-days">
          @for (day of dayLabels; track day; let i = $index) {
            <mat-checkbox
              [checked]="weekDays()[i]"
              (change)="onWeekDayToggle(i)"
              [disabled]="isDisabled()"
              class="recurrence-day"
            >
              {{ day }}
            </mat-checkbox>
          }
        </div>
      }

      <!-- End condition -->
      <div class="recurrence-end">
        <label class="recurrence-label" for="recurrenceEndType">Fin de la récurrence</label>

        <mat-radio-group
          id="recurrenceEndType"
          [value]="endType()"
          (change)="onEndTypeChange($event.value)"
          [disabled]="isDisabled()"
          class="recurrence-end-options"
        >
          <mat-radio-button value="never">
            <span class="recurrence-text">Jamais</span>
          </mat-radio-button>

          <div class="recurrence-end-row">
            <mat-radio-button value="count">
              <span class="recurrence-text">Après</span>
            </mat-radio-button>
            @if (endType() === 'count') {
              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="recurrence-number">
                <input
                  matInput
                  type="number"
                  min="1"
                  [value]="endCount()"
                  (input)="onEndCountChange($event)"
                  [disabled]="isDisabled()"
                />
              </mat-form-field>
              <span class="recurrence-text">occurrences</span>
            }
          </div>

          <div class="recurrence-end-row">
            <mat-radio-button value="until">
              <span class="recurrence-text">À une date</span>
            </mat-radio-button>
            @if (endType() === 'until') {
              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="recurrence-date">
                <input
                  matInput
                  [matDatepicker]="endDatePicker"
                  [value]="endDate()"
                  (dateChange)="onEndDateChange($event.value)"
                  [disabled]="isDisabled()"
                  placeholder="Date de fin"
                />
                <mat-datepicker-toggle matIconSuffix [for]="endDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #endDatePicker></mat-datepicker>
              </mat-form-field>
            }
          </div>
        </mat-radio-group>
      </div>
    </div>
  }
</div>
