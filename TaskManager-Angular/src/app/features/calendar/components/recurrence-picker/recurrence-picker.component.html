<div class="recurrence-picker flex flex-col gap-3">
  <!-- Toggle: enabled / disabled -->
  <mat-button-toggle-group
    [value]="enabled() ? 'enabled' : 'disabled'"
    (change)="onEnabledChange($event.value)"
    [disabled]="isDisabled()"
    class="recurrence-toggle"
  >
    <mat-button-toggle value="disabled">Ne se répète pas</mat-button-toggle>
    <mat-button-toggle value="enabled">Se répète</mat-button-toggle>
  </mat-button-toggle-group>

  @if (enabled()) {
    <div class="flex flex-col gap-3 pl-2 border-l-2 border-indigo-200">
      <!-- Frequency selector -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Fréquence</mat-label>
        <mat-select
          [value]="frequency()"
          (selectionChange)="onFrequencyChange($event.value)"
          [disabled]="isDisabled()"
        >
          @for (option of frequencyChoices; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Interval -->
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600 whitespace-nowrap">Tous les</span>
        <mat-form-field appearance="outline" class="interval-field">
          <input
            matInput
            type="number"
            min="1"
            [value]="interval()"
            (input)="onIntervalChange($event)"
            [disabled]="isDisabled()"
          />
        </mat-form-field>
        <span class="text-sm text-gray-600 whitespace-nowrap">{{ currentUnitLabel() }}</span>
      </div>

      <!-- Weekly: day checkboxes -->
      @if (frequency() === 'weekly') {
        <div class="flex flex-wrap gap-2">
          @for (day of dayLabels; track day; let i = $index) {
            <mat-checkbox
              [checked]="weekDays()[i]"
              (change)="onWeekDayToggle(i)"
              [disabled]="isDisabled()"
              class="day-checkbox"
            >
              {{ day }}
            </mat-checkbox>
          }
        </div>
      }

      <!-- End condition -->
      <div class="flex flex-col gap-2">
        <span class="text-sm font-medium text-gray-700">Fin de la récurrence</span>

        <mat-radio-group
          [value]="endType()"
          (change)="onEndTypeChange($event.value)"
          [disabled]="isDisabled()"
          class="flex flex-col gap-2"
        >
          <!-- Never -->
          <mat-radio-button value="never">
            <span class="text-sm">Jamais</span>
          </mat-radio-button>

          <!-- After N occurrences -->
          <div class="flex items-center gap-2">
            <mat-radio-button value="count">
              <span class="text-sm">Après</span>
            </mat-radio-button>
            @if (endType() === 'count') {
              <mat-form-field appearance="outline" class="count-field">
                <input
                  matInput
                  type="number"
                  min="1"
                  [value]="endCount()"
                  (input)="onEndCountChange($event)"
                  [disabled]="isDisabled()"
                />
              </mat-form-field>
              <span class="text-sm text-gray-600">occurrences</span>
            }
          </div>

          <!-- Until date -->
          <div class="flex items-center gap-2">
            <mat-radio-button value="until">
              <span class="text-sm">À une date</span>
            </mat-radio-button>
            @if (endType() === 'until') {
              <mat-form-field appearance="outline" class="date-field">
                <input
                  matInput
                  [matDatepicker]="endDatePicker"
                  [value]="endDate()"
                  (dateChange)="onEndDateChange($event.value)"
                  [disabled]="isDisabled()"
                  placeholder="Date de fin"
                />
                <mat-datepicker-toggle matIconSuffix [for]="endDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #endDatePicker></mat-datepicker>
              </mat-form-field>
            }
          </div>
        </mat-radio-group>
      </div>
    </div>
  }
</div>
