<!-- Search Input with Autocomplete -->
<mat-form-field appearance="outline" subscriptSizing="dynamic" class="picker-search-field">
  <input
    matInput
    [formControl]="searchControl"
    [matAutocomplete]="auto"
    placeholder="Rechercher un élément à lier..." />
  <mat-icon matPrefix class="picker-search-icon">search</mat-icon>
  @if (isSearching()) {
    <mat-spinner matSuffix diameter="18"></mat-spinner>
  }
  <mat-autocomplete #auto="matAutocomplete" class="linked-items-autocomplete">
    <!-- Tab Bar inside autocomplete -->
    @if (searchControl.value && searchControl.value.length >= 2) {
      <div class="autocomplete-tabs">
        @for (tab of tabs; track tab.value) {
          <button
            type="button"
            class="autocomplete-tabs__btn"
            [class.autocomplete-tabs__btn--active]="activeTab() === tab.value"
            (click)="$event.stopPropagation(); setActiveTab(tab.value)">
            {{ tab.label }}
          </button>
        }
      </div>
    }

    <!-- Loading state -->
    @if (isSearching()) {
      <mat-option disabled>
        <span class="autocomplete-msg">Recherche en cours...</span>
      </mat-option>
    }

    <!-- Results -->
    @if (!isSearching() && filteredResults().length > 0) {
      @for (result of filteredResults(); track result.id) {
        <mat-option [value]="result.label" (onSelectionChange)="addItem(result)">
          <div class="autocomplete-result">
            <mat-icon
              class="autocomplete-result__icon"
              [class.autocomplete-result__icon--task]="result.type === 'task'"
              [class.autocomplete-result__icon--document]="result.type === 'document'"
              [class.autocomplete-result__icon--database]="result.type === 'database'">
              {{ getItemIcon(result.type) }}
            </mat-icon>
            <div class="autocomplete-result__text">
              <span class="autocomplete-result__label">{{ result.label }}</span>
              <span class="autocomplete-result__type">{{ getItemTypeLabel(result.type) }}</span>
            </div>
          </div>
        </mat-option>
      }
    } @else if (!isSearching() && searchControl.value && searchControl.value.length >= 2) {
      <mat-option disabled>
        <span class="autocomplete-msg">Aucun résultat trouvé</span>
      </mat-option>
    }
  </mat-autocomplete>
</mat-form-field>

<!-- Selected Items as Cards -->
@if (selectedItems().length > 0) {
  <div class="linked-items-list">
    @for (item of selectedItems(); track item.id) {
      <div class="linked-item-card"
        [class.linked-item-card--task]="item.type === 'task'"
        [class.linked-item-card--document]="item.type === 'document'"
        [class.linked-item-card--database]="item.type === 'database'">
        <div class="linked-item-card__content">
          <mat-icon
            class="linked-item-card__icon"
            [class.linked-item-card__icon--task]="item.type === 'task'"
            [class.linked-item-card__icon--document]="item.type === 'document'"
            [class.linked-item-card__icon--database]="item.type === 'database'">
            {{ getItemIcon(item.type) }}
          </mat-icon>
          <div class="linked-item-card__info">
            <span class="linked-item-card__label">{{ item.label }}</span>
            <span class="linked-item-card__badge"
              [class.linked-item-card__badge--task]="item.type === 'task'"
              [class.linked-item-card__badge--document]="item.type === 'document'"
              [class.linked-item-card__badge--database]="item.type === 'database'">
              {{ getItemTypeLabel(item.type) }}
            </span>
          </div>
          @if (!isDisabled()) {
            <button
              type="button"
              class="linked-item-card__remove"
              (click)="removeItem(item)">
              <mat-icon>close</mat-icon>
            </button>
          }
        </div>
      </div>
    }
  </div>
} @else {
  <!-- Empty state -->
  <div class="linked-items-empty">
    <mat-icon class="linked-items-empty__icon">link_off</mat-icon>
    <span class="linked-items-empty__text">Aucun élément lié</span>
  </div>
}
