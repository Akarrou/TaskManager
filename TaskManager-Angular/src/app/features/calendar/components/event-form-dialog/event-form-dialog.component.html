<h2 mat-dialog-title class="dialog-title-default">
  <mat-icon>event</mat-icon>
  <span>{{ dialogTitle }}</span>
</h2>

<mat-dialog-content class="dialog-content">
  <form [formGroup]="form" class="event-form event-form--two-col">

    <!-- Left Column: Form Fields -->
    <div class="event-form__left">

      <!-- Title -->
      <div class="form-group">
        <label class="form-label">Titre <span class="required">*</span></label>
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <input matInput formControlName="title" placeholder="Titre de l'événement" />
          @if (form.controls.title.hasError('required') && form.controls.title.touched) {
            <mat-error>Le titre est obligatoire</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Database selector (only shown if multiple event databases exist) -->
      @if (showDatabaseSelector()) {
        <div class="form-group">
          <label class="form-label">Calendrier</label>
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-select formControlName="databaseId">
              @for (db of eventDatabases(); track db.database_id) {
                <mat-option [value]="db.database_id">{{ db.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      }

      <!-- All Day toggle -->
      <div class="form-group form-group--inline">
        <mat-checkbox formControlName="allDay">
          Journée entière
        </mat-checkbox>
      </div>

      <!-- Date/Time Row: Start -->
      <div class="form-group">
        <label class="form-label">Date de début <span class="required">*</span></label>
        <div class="form-row">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="date-field">
            <input matInput [matDatepicker]="startPicker" formControlName="startDate" placeholder="Choisir une date" />
            <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>
          @if (!isAllDay) {
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="time-field">
              <input matInput type="time" formControlName="startTime" />
            </mat-form-field>
          }
        </div>
      </div>

      <!-- Date/Time Row: End -->
      <div class="form-group">
        <label class="form-label">Date de fin <span class="required">*</span></label>
        <div class="form-row">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="date-field">
            <input matInput [matDatepicker]="endPicker" formControlName="endDate" placeholder="Choisir une date" />
            <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
          @if (!isAllDay) {
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="time-field">
              <input matInput type="time" formControlName="endTime" />
            </mat-form-field>
          }
        </div>
      </div>

      <!-- Category + Location -->
      <div class="form-row">
        <div class="form-group flex-1">
          <label class="form-label">Catégorie</label>
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-select formControlName="category">
              @for (option of categoryOptions; track option.value) {
                <mat-option [value]="option.value">
                  <span class="flex items-center gap-2">
                    <span class="inline-block w-2.5 h-2.5 rounded-full" [ngClass]="option.colors.bg"></span>
                    <span>{{ option.label }}</span>
                  </span>
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
        <div class="form-group flex-1">
          <label class="form-label">Lieu</label>
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-icon matPrefix class="location-icon">location_on</mat-icon>
            <input matInput formControlName="location" placeholder="Ajouter un lieu" />
          </mat-form-field>
        </div>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label class="form-label">Description</label>
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <textarea
            matInput
            formControlName="description"
            placeholder="Ajouter une description..."
            rows="3"
            cdkTextareaAutosize
            cdkAutosizeMinRows="2"
            cdkAutosizeMaxRows="5"
          ></textarea>
        </mat-form-field>
      </div>

      <!-- Recurrence -->
      <div class="form-group">
        <label class="form-label">Récurrence</label>
        <app-recurrence-picker formControlName="recurrence"></app-recurrence-picker>
      </div>

      <!-- Reminders -->
      <div class="form-group">
        <label class="form-label">Rappels</label>
        <div class="reminders-list">
          @for (reminder of form.controls.reminders.value; track $index) {
            <div class="reminder-row">
              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="reminder-method-field">
                <mat-select [value]="reminder.method" (selectionChange)="updateReminderMethod($index, $event.value)">
                  <mat-option value="popup">Notification</mat-option>
                  <mat-option value="email">Email</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="reminder-time-field">
                <mat-select [value]="reminder.minutes" (selectionChange)="updateReminderMinutes($index, $event.value)">
                  <mat-option [value]="5">5 minutes</mat-option>
                  <mat-option [value]="15">15 minutes</mat-option>
                  <mat-option [value]="30">30 minutes</mat-option>
                  <mat-option [value]="60">1 heure</mat-option>
                  <mat-option [value]="120">2 heures</mat-option>
                  <mat-option [value]="1440">1 jour</mat-option>
                  <mat-option [value]="2880">2 jours</mat-option>
                </mat-select>
              </mat-form-field>
              <button mat-icon-button type="button" (click)="removeReminder($index)" class="reminder-remove-btn">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          }
          @if (form.controls.reminders.value.length < 5) {
            <button mat-stroked-button type="button" (click)="addReminder()" class="reminder-add-btn">
              <mat-icon>add</mat-icon>
              Ajouter un rappel
            </button>
          }
        </div>
      </div>

    </div>

    <!-- Right Column: Linked Items -->
    <div class="event-form__right">
      <div class="linked-items-panel">
        <h3 class="linked-items-panel__title">
          <mat-icon class="linked-items-panel__icon">link</mat-icon>
          Éléments liés
        </h3>
        <app-linked-items-picker formControlName="linkedItems"></app-linked-items-picker>
      </div>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions class="dialog-actions">
  <span></span>
  <div class="flex gap-3">
    <button
      mat-button
      (click)="onCancel()"
      [disabled]="isLoading()"
      class="dialog-btn-secondary">
      Annuler
    </button>
    <button
      mat-flat-button
      (click)="onSubmit()"
      [disabled]="isLoading() || form.invalid"
      class="dialog-btn-primary">
      @if (isLoading()) {
        <mat-spinner diameter="18" class="!inline-block !mr-2"></mat-spinner>
      }
      {{ isEditMode ? 'Enregistrer' : 'Créer l\'événement' }}
    </button>
  </div>
</mat-dialog-actions>
