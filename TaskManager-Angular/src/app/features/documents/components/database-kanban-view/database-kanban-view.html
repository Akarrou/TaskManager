<!-- Empty State: No select column exists -->
@if (!hasSelectColumn()) {
  <div class="empty-state">
    <mat-icon class="empty-icon">view_kanban</mat-icon>
    <p class="empty-text">Ajoutez une colonne 'Sélection' pour utiliser la vue kanban</p>
    <button mat-raised-button color="primary" (click)="onAddSelectColumn()">
      <mat-icon>add</mat-icon>
      Ajouter une colonne Sélection
    </button>
  </div>
}

<!-- Empty State: No groupBy configured -->
@else if (!groupByColumnId()) {
  <div class="empty-state">
    <mat-icon class="empty-icon">view_kanban</mat-icon>
    <p class="empty-text">Sélectionnez une colonne pour afficher la vue kanban</p>
    <button mat-raised-button color="primary" [matMenuTriggerFor]="emptyStateColumnMenu">
      <mat-icon>view_column</mat-icon>
      Choisir une colonne
    </button>
    <mat-menu #emptyStateColumnMenu="matMenu">
      @for (col of availableSelectColumns(); track col.id) {
        <button mat-menu-item (click)="onSelectColumn(col)">
          <mat-icon>{{ col.type === 'multi-select' ? 'checklist' : 'list' }}</mat-icon>
          <span>{{ col.name }}</span>
        </button>
      }
    </mat-menu>
  </div>
}

<!-- Empty State: No kanban columns generated -->
@else if (kanbanColumns().length === 0) {
  <div class="empty-state">
    <mat-icon class="empty-icon">view_kanban</mat-icon>
    <p class="empty-text">La colonne sélectionnée n'a pas de choix disponibles</p>
    @if (availableSelectColumns().length > 1) {
      <button mat-raised-button color="primary" [matMenuTriggerFor]="noChoicesColumnMenu">
        <mat-icon>view_column</mat-icon>
        Changer de colonne
      </button>
      <mat-menu #noChoicesColumnMenu="matMenu">
        @for (col of availableSelectColumns(); track col.id) {
          <button
            mat-menu-item
            (click)="onSelectColumn(col)"
            [class.selected]="isColumnSelected(col.id)">
            <mat-icon>{{ col.type === 'multi-select' ? 'checklist' : 'list' }}</mat-icon>
            <span>{{ col.name }}</span>
            @if (isColumnSelected(col.id)) {
              <mat-icon class="check-icon">check</mat-icon>
            }
          </button>
        }
      </mat-menu>
    } @else {
      <p class="empty-hint">Ajoutez des options à la colonne "{{ selectedColumnName() }}" pour afficher le kanban</p>
    }
  </div>
}

<!-- Kanban Board -->
@else {
  <!-- Kanban Header with Column Selector -->
  <div class="kanban-header">
    <h3 class="kanban-header__title">Vue Kanban</h3>
    <div class="kanban-header__controls">
      <!-- Column Selector - Always show to allow changing column -->
      <button
        mat-stroked-button
        [matMenuTriggerFor]="columnSelectorMenu"
        matTooltip="Changer la colonne de regroupement">
        <mat-icon>view_column</mat-icon>
        {{ selectedColumnName() }}
        <mat-icon class="dropdown-icon">arrow_drop_down</mat-icon>
      </button>
      <mat-menu #columnSelectorMenu="matMenu">
        @for (col of availableSelectColumns(); track col.id) {
          <button
            mat-menu-item
            (click)="onSelectColumn(col)"
            [class.selected]="isColumnSelected(col.id)">
            <mat-icon>{{ col.type === 'multi-select' ? 'checklist' : 'list' }}</mat-icon>
            <span>{{ col.name }}</span>
            @if (isColumnSelected(col.id)) {
              <mat-icon class="check-icon">check</mat-icon>
            }
          </button>
        }
      </mat-menu>
    </div>
  </div>

  <div class="kanban-board" cdkDropListGroup>
    @for (column of kanbanColumns(); track column.id) {
      <div class="kanban-column">
        <!-- Column Header -->
        <div class="kanban-column-header" [style.background-color]="getChoiceColor(column.color)">
          <div class="column-header-content">
            <h3 class="column-title">{{ column.title }}</h3>
            <span class="row-count">{{ column.rows.length }}</span>
          </div>
        </div>

        <!-- Column Content -->
        <div
          class="kanban-column-content"
          cdkDropList
          [cdkDropListData]="column.rows"
          (cdkDropListDropped)="onDrop($event, column.id)">

          @for (row of column.rows; track row.id) {
            <mat-card class="kanban-card" cdkDrag>
              <mat-card-content>
                <!-- Display visible fields (max 3) -->
                @for (col of visibleColumns(); track col.id) {
                  @if (shouldShowField(col.id)) {
                    <div class="card-field">
                      <span class="field-label">{{ col.name }}</span>
                      <span class="field-value">{{ getCellDisplayValue(row, col) }}</span>
                    </div>
                  }
                }
              </mat-card-content>
            </mat-card>
          }

          <!-- Empty column placeholder -->
          @if (column.rows.length === 0) {
            <div class="empty-column-placeholder">
              <mat-icon>inbox</mat-icon>
              <p>Aucune ligne</p>
            </div>
          }
        </div>
      </div>
    }
  </div>
}
