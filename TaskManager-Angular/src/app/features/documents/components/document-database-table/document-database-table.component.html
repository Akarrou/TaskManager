<div class="database-container">
  <!-- Loading State -->
  @if (isInitializing() || isCreatingDatabase()) {
    <div class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="loading-text">
        {{ isCreatingDatabase() ? 'Création de la base de données...' : 'Chargement...' }}
      </p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <div class="error-state">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <p class="error-text">{{ error() }}</p>
      <button mat-stroked-button (click)="initializeDatabase()">
        <mat-icon>refresh</mat-icon>
        Réessayer
      </button>
    </div>
  }

  <!-- Database Content -->
  @else {
    <!-- Header: Title and Actions -->
    <div class="database-header">
      <div class="database-title">
        <mat-icon class="database-icon">table_view</mat-icon>
        @if (isEditingName()) {
          <input
            type="text"
            class="database-name-input"
            [value]="tempDatabaseName()"
            (input)="tempDatabaseName.set($any($event.target).value)"
            (blur)="onSaveDatabaseName()"
            (keydown)="onNameInputKeydown($event)"
            autofocus />
        } @else {
          <button
            type="button"
            (click)="onStartEditingName()"
            class="database-name-editable"
            matTooltip="Cliquer pour modifier le nom">
            {{ databaseConfig().name }}
          </button>
        }
        <span class="database-stats">
          {{ rowCount() }} ligne(s) • {{ columnCount() }} colonne(s)
        </span>
      </div>

      <div class="database-actions">
        <!-- View Switcher -->
        <div class="view-switcher">
          <button
            mat-icon-button
            [class.active]="currentView() === 'table'"
            (click)="onSwitchView('table')"
            matTooltip="Vue tableau">
            <mat-icon>table_chart</mat-icon>
          </button>
          <button
            mat-icon-button
            [class.active]="currentView() === 'kanban'"
            (click)="onSwitchView('kanban')"
            matTooltip="Vue kanban"
            disabled>
            <mat-icon>view_kanban</mat-icon>
          </button>
          <button
            mat-icon-button
            [class.active]="currentView() === 'calendar'"
            (click)="onSwitchView('calendar')"
            matTooltip="Vue calendrier"
            disabled>
            <mat-icon>calendar_month</mat-icon>
          </button>
          <button
            mat-icon-button
            [class.active]="currentView() === 'timeline'"
            (click)="onSwitchView('timeline')"
            matTooltip="Vue timeline"
            disabled>
            <mat-icon>timeline</mat-icon>
          </button>
        </div>

        <!-- Bulk Actions (shown when rows are selected) -->
        @if (selectedCount() > 0) {
          <div class="bulk-actions">
            <span class="selected-count">{{ selectedCount() }} sélectionnée(s)</span>
            <button mat-stroked-button color="warn" (click)="onDeleteSelectedRows()">
              <mat-icon>delete</mat-icon>
              Supprimer
            </button>
          </div>
        }

        <!-- Add Row Button -->
        <button mat-raised-button color="primary" (click)="onAddRow()">
          <mat-icon>add</mat-icon>
          Nouvelle ligne
        </button>
      </div>
    </div>

    <!-- View Content -->
    <div class="database-content">
      @switch (currentView()) {
        @case ('table') {
          <!-- Table View -->
          <div class="table-view">
            @if (isLoading()) {
              <div class="flex items-center justify-center py-8">
                <mat-spinner diameter="32"></mat-spinner>
                <span class="ml-3 text-gray-500">Chargement des données...</span>
              </div>
            } @else if (rowCount() === 0) {
              <!-- Empty State -->
              <div class="empty-state">
                <mat-icon class="empty-icon">inbox</mat-icon>
                <p class="empty-text">Aucune ligne dans cette base de données</p>
                <button mat-raised-button color="primary" (click)="onAddRow()">
                  <mat-icon>add</mat-icon>
                  Ajouter la première ligne
                </button>
              </div>
            } @else {
              <!-- Data Table -->
              <div class="table-wrapper" (keydown)="onTableKeydown($event)">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th class="row-select-header">
                        <button
                          mat-icon-button
                          class="select-all-button"
                          (click)="onToggleSelectAll()"
                          matTooltip="Sélectionner tout">
                          @if (isAllSelected()) {
                            <mat-icon>check_box</mat-icon>
                          } @else if (isSomeSelected()) {
                            <mat-icon>indeterminate_check_box</mat-icon>
                          } @else {
                            <mat-icon>check_box_outline_blank</mat-icon>
                          }
                        </button>
                      </th>
                      @for (column of databaseConfig().columns; track column.id) {
                        <th class="column-header">
                          <div class="column-header-content">
                            <span class="column-name">{{ column.name }}</span>
                            <span class="column-type">{{ column.type }}</span>
                            <button
                              mat-icon-button
                              class="column-menu-button"
                              [matMenuTriggerFor]="columnMenu">
                              <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #columnMenu="matMenu">
                              <button mat-menu-item (click)="onEditColumn(column.id)">
                                <mat-icon>edit</mat-icon>
                                <span>Modifier</span>
                              </button>
                              <button mat-menu-item (click)="onDeleteColumn(column.id)">
                                <mat-icon>delete</mat-icon>
                                <span>Supprimer</span>
                              </button>
                            </mat-menu>
                          </div>
                        </th>
                      }
                      <th class="add-column-header">
                        <button
                          mat-icon-button
                          (click)="onAddColumn()"
                          matTooltip="Ajouter une colonne">
                          <mat-icon>add</mat-icon>
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of rows(); track row.id) {
                      <tr class="data-row" [class.selected]="isRowSelected(row.id)">
                        <td class="row-select-cell">
                          <button
                            mat-icon-button
                            class="row-select-button"
                            (click)="onToggleRowSelection(row.id)">
                            @if (isRowSelected(row.id)) {
                              <mat-icon>check_box</mat-icon>
                            } @else {
                              <mat-icon>check_box_outline_blank</mat-icon>
                            }
                          </button>
                        </td>
                        @for (column of databaseConfig().columns; track column.id) {
                          <td class="data-cell" (click)="onCellClick(row.id, column.id, $event)">
                            @if (column.type === 'checkbox') {
                              <!-- Checkbox type -->
                              <mat-checkbox
                                [checked]="row.cells[column.id] || false"
                                (change)="onUpdateCell(row.id, column.id, $event.checked)">
                              </mat-checkbox>
                            } @else if (column.type === 'select') {
                              <!-- Select type - Display as badge -->
                              <div class="select-cell">
                                @if (getSelectedChoice(row.cells[column.id], column); as selectedChoice) {
                                  <div class="selected-choice-container">
                                    <span class="choice-badge" [style.background-color]="getChoiceColor(selectedChoice.color)">
                                      {{ selectedChoice.label }}
                                      <button
                                        type="button"
                                        class="remove-choice"
                                        (click)="onUpdateCell(row.id, column.id, ''); $event.stopPropagation()">
                                        ×
                                      </button>
                                    </span>
                                    <select
                                      class="change-choice-select"
                                      [value]="''"
                                      (change)="onUpdateCell(row.id, column.id, $any($event.target).value); $any($event.target).value = ''; $event.stopPropagation()"
                                      (click)="$event.stopPropagation()">
                                      <option value="">⟳ Changer</option>
                                      @for (choice of column.options?.choices ?? []; track choice.id) {
                                        <option [value]="choice.id">{{ choice.label }}</option>
                                      }
                                    </select>
                                  </div>
                                } @else {
                                  <div class="empty-choice-container">
                                    <span class="empty-select">-</span>
                                    <select
                                      class="change-choice-select"
                                      [value]="''"
                                      (change)="onUpdateCell(row.id, column.id, $any($event.target).value); $any($event.target).value = ''; $event.stopPropagation()"
                                      (click)="$event.stopPropagation()">
                                      <option value="">+ Sélectionner</option>
                                      @for (choice of column.options?.choices ?? []; track choice.id) {
                                        <option [value]="choice.id">{{ choice.label }}</option>
                                      }
                                    </select>
                                  </div>
                                }
                              </div>
                            } @else if (column.type === 'multi-select') {
                              <!-- Multi-select type - Display as badges -->
                              <div class="multi-select-cell">
                                @if (getSelectedChoices(row.cells[column.id], column).length > 0) {
                                  <div class="selected-badges">
                                    @for (choice of getSelectedChoices(row.cells[column.id], column); track choice.id) {
                                      <span class="choice-badge" [style.background-color]="getChoiceColor(choice.color)">
                                        {{ choice.label }}
                                        <button
                                          type="button"
                                          class="remove-choice"
                                          (click)="removeChoiceFromCell(row.id, column.id, choice.id); $event.stopPropagation()">
                                          ×
                                        </button>
                                      </span>
                                    }
                                  </div>
                                } @else {
                                  <span class="empty-multi-select">-</span>
                                }
                                <select
                                  class="add-choice-select"
                                  (change)="addChoiceToCell(row.id, column.id, $any($event.target).value); $any($event.target).value = ''; $event.stopPropagation()"
                                  (click)="$event.stopPropagation()">
                                  <option value="">+ Ajouter</option>
                                  @for (choice of getAvailableChoices(row.cells[column.id], column); track choice.id) {
                                    <option [value]="choice.id">{{ choice.label }}</option>
                                  }
                                </select>
                              </div>
                            } @else {
                              <!-- Text, number, date, url, email types -->
                              <input
                                type="{{ getCellInputType(column.type) }}"
                                class="cell-input"
                                [value]="row.cells[column.id] || ''"
                                (blur)="onUpdateCell(row.id, column.id, $any($event.target).value)"
                                (keydown.enter)="$any($event.target).blur()"
                                (click)="$event.stopPropagation()"
                                placeholder="-" />
                            }
                          </td>
                        }
                        <td class="row-actions-cell">
                          <button
                            mat-icon-button
                            [matMenuTriggerFor]="rowMenu"
                            matTooltip="Actions">
                            <mat-icon>more_horiz</mat-icon>
                          </button>
                          <mat-menu #rowMenu="matMenu">
                            <button mat-menu-item (click)="onDeleteRows([row.id])">
                              <mat-icon>delete</mat-icon>
                              <span>Supprimer</span>
                            </button>
                          </mat-menu>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          </div>
        }
        @case ('kanban') {
          <div class="view-placeholder">
            <mat-icon class="placeholder-icon">view_kanban</mat-icon>
            <p>Vue kanban - Prochainement</p>
          </div>
        }
        @case ('calendar') {
          <div class="view-placeholder">
            <mat-icon class="placeholder-icon">calendar_month</mat-icon>
            <p>Vue calendrier - Prochainement</p>
          </div>
        }
        @case ('timeline') {
          <div class="view-placeholder">
            <mat-icon class="placeholder-icon">timeline</mat-icon>
            <p>Vue timeline - Prochainement</p>
          </div>
        }
      }
    </div>
  }
</div>
