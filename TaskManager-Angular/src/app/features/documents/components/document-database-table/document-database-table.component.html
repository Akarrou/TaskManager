<div class="database-container">
  <!-- Loading State -->
  @if (isInitializing() || isCreatingDatabase()) {
    <div class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="loading-text">
        {{ isCreatingDatabase() ? 'Création de la base de données...' : 'Chargement...' }}
      </p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <div class="error-state">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <p class="error-text">{{ error() }}</p>
      <button mat-stroked-button (click)="initializeDatabase()">
        <mat-icon>refresh</mat-icon>
        Réessayer
      </button>
    </div>
  }

  <!-- Database Content -->
  @else {
    <!-- Header: Title and Actions -->
    <div class="database-header">
      <div class="database-title">
        <mat-icon class="database-icon">table_view</mat-icon>
        @if (isEditingName()) {
          <input
            type="text"
            class="database-name-input"
            [value]="tempDatabaseName()"
            (input)="tempDatabaseName.set($any($event.target).value)"
            (blur)="onSaveDatabaseName()"
            (keydown)="onNameInputKeydown($event)"
            autofocus />
        } @else {
          <button
            type="button"
            (click)="onStartEditingName()"
            class="database-name-editable"
            matTooltip="Cliquer pour modifier le nom">
            {{ databaseConfig().name }}
          </button>
        }
        <span class="database-stats">
          {{ rowCount() }} ligne(s) • {{ columnCount() }} colonne(s)
        </span>
      </div>

      <div class="database-actions">
        <!-- View Switcher -->
        <div class="view-switcher">
          <button
            mat-icon-button
            [class.active]="currentView() === 'table'"
            (click)="onSwitchView('table')"
            matTooltip="Vue tableau">
            <mat-icon>table_chart</mat-icon>
          </button>
          <button
            mat-icon-button
            [class.active]="currentView() === 'kanban'"
            (click)="onSwitchView('kanban')"
            matTooltip="Vue kanban">
            <mat-icon>view_kanban</mat-icon>
          </button>
          <button
            mat-icon-button
            [class.active]="currentView() === 'calendar'"
            (click)="onSwitchView('calendar')"
            matTooltip="Vue calendrier">
            <mat-icon>calendar_month</mat-icon>
          </button>
          <button
            mat-icon-button
            [class.active]="currentView() === 'timeline'"
            (click)="onSwitchView('timeline')"
            matTooltip="Vue timeline">
            <mat-icon>timeline</mat-icon>
          </button>
        </div>

        <!-- Column visibility menu -->
        <button
          mat-stroked-button
          [matMenuTriggerFor]="columnVisibilityMenu"
          matTooltip="Gérer les colonnes">
          <mat-icon>view_column</mat-icon>
          Colonnes
        </button>

        <mat-menu #columnVisibilityMenu="matMenu">
          <div class="column-visibility-menu" (click)="$event.stopPropagation()">
            <div class="menu-header">
              <span>Colonnes visibles</span>
            </div>
            @for (column of databaseConfig().columns; track column.id) {
              <button mat-menu-item (click)="onToggleColumnVisibility(column.id)">
                <mat-checkbox
                  [checked]="column.visible"
                  (click)="$event.stopPropagation()"
                  (change)="onToggleColumnVisibility(column.id)">
                  {{ column.name }}
                </mat-checkbox>
              </button>
            }
          </div>
        </mat-menu>

        <!-- Delete Database Button -->
        <button
          mat-icon-button
          (click)="onDeleteDatabase()"
          matTooltip="Supprimer la base de données"
          class="delete-database-btn">
          <mat-icon>delete</mat-icon>
        </button>

        <!-- Bulk Actions (shown when rows are selected) -->
        @if (selectedCount() > 0) {
          <div class="bulk-actions">
            <span class="selected-count">{{ selectedCount() }} sélectionnée(s)</span>
            <button mat-stroked-button color="warn" (click)="onDeleteSelectedRows()">
              <mat-icon>delete</mat-icon>
              Supprimer
            </button>
          </div>
        }

        <!-- Import CSV Button (only for empty tables) -->
        @if (canImportCsv()) {
          <button
            mat-stroked-button
            (click)="openCsvImportDialog()"
            matTooltip="Importer des données depuis un fichier CSV">
            <mat-icon>upload_file</mat-icon>
            Importer CSV
          </button>
        }

        <!-- Add Row Button (only if there are columns) -->
        @if (columnCount() > 0) {
          <button mat-raised-button color="primary" (click)="onAddRow()">
            <mat-icon>add</mat-icon>
            Nouvelle ligne
          </button>
        }
      </div>
    </div>

    <!-- Database Filters -->
    <app-database-filters
      [columns]="databaseConfig().columns"
      [activeFilters]="activeFilters()"
      (filterChange)="onFilterChange($event)"
      (clearAll)="onClearAllFilters()">
    </app-database-filters>

    <!-- View Content -->
    <div class="database-content">
      @switch (currentView()) {
        @case ('table') {
          <!-- Table View -->
          <div class="table-view">
            @if (isLoading()) {
              <div class="flex items-center justify-center py-8">
                <mat-spinner diameter="32"></mat-spinner>
                <span class="ml-3 text-gray-500">Chargement des données...</span>
              </div>
            } @else if (columnCount() === 0) {
              <!-- No Columns State -->
              <div class="empty-state">
                <mat-icon class="empty-icon">view_column</mat-icon>
                <p class="empty-text">Aucune colonne dans cette base de données</p>
                <p class="empty-hint">Commencez par ajouter une colonne ou importer un fichier CSV</p>
                <div class="empty-actions">
                  <button mat-raised-button color="primary" (click)="onAddColumn()">
                    <mat-icon>add</mat-icon>
                    Ajouter une colonne
                  </button>
                  @if (canImportCsv()) {
                    <button mat-stroked-button (click)="openCsvImportDialog()">
                      <mat-icon>upload_file</mat-icon>
                      Importer CSV
                    </button>
                  }
                </div>
              </div>
            } @else if (rowCount() === 0) {
              <!-- Empty Rows State -->
              <div class="empty-state">
                <mat-icon class="empty-icon">inbox</mat-icon>
                <p class="empty-text">Aucune ligne dans cette base de données</p>
                <button mat-raised-button color="primary" (click)="onAddRow()">
                  <mat-icon>add</mat-icon>
                  Ajouter la première ligne
                </button>
              </div>
            } @else {
              <!-- Pagination Controls -->
              <mat-paginator
                [length]="totalCount()"
                [pageSize]="pageSize()"
                [pageIndex]="pageIndex()"
                [pageSizeOptions]="pageSizeOptions"
                (page)="onPageChange($event)"
                showFirstLastButtons
                class="database-paginator">
              </mat-paginator>

              <!-- Data Table -->
              <div class="table-wrapper" (keydown)="onTableKeydown($event)">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th class="row-select-header">
                        <button
                          mat-icon-button
                          class="select-all-button"
                          (click)="onToggleSelectAll()"
                          matTooltip="Sélectionner tout">
                          @if (isAllSelected()) {
                            <mat-icon>check_box</mat-icon>
                          } @else if (isSomeSelected()) {
                            <mat-icon>indeterminate_check_box</mat-icon>
                          } @else {
                            <mat-icon>check_box_outline_blank</mat-icon>
                          }
                        </button>
                      </th>
                      @for (column of sortedColumns(); track column.id) {
                        @if (column.visible !== false) {
                          <th class="column-header" (click)="onColumnHeaderClick(column.id)" (keydown.enter)="onColumnHeaderClick(column.id)" (keydown.space)="onColumnHeaderClick(column.id)" tabindex="0">
                            <div class="column-header-content">
                            <span class="column-name">{{ column.name }}</span>

                            <!-- Indicateur de tri -->
                            @if (activeSort()?.columnId === column.id) {
                              <mat-icon class="sort-indicator">
                                {{ activeSort()?.order === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                              </mat-icon>
                            }

                            <span class="column-type">{{ column.type }}</span>
                            <button
                              mat-icon-button
                              class="column-menu-button"
                              [matMenuTriggerFor]="columnMenu"
                              (click)="$event.stopPropagation()">
                              <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #columnMenu="matMenu">
                              @if (!isColumnReadonly(column.id)) {
                                <button mat-menu-item (click)="onEditColumn(column.id)">
                                  <mat-icon>edit</mat-icon>
                                  <span>Modifier</span>
                                </button>
                              }
                              @if (isColumnReadonly(column.id) && canManageOptions(column.id)) {
                                <button mat-menu-item (click)="onManageOptions(column.id)">
                                  <mat-icon>tune</mat-icon>
                                  <span>Gérer les options</span>
                                </button>
                              }
                              <button mat-menu-item (click)="onToggleColumnVisibility(column.id)">
                                <mat-icon>visibility_off</mat-icon>
                                <span>Masquer</span>
                              </button>
                              @if (!isColumnReadonly(column.id)) {
                                <button mat-menu-item (click)="onDeleteColumn(column.id)">
                                  <mat-icon>delete</mat-icon>
                                  <span>Supprimer</span>
                                </button>
                              }
                            </mat-menu>
                          </div>
                        </th>
                        }
                      }
                      <th class="add-column-header">
                        <button
                          mat-icon-button
                          (click)="onAddColumn()"
                          matTooltip="Ajouter une colonne">
                          <mat-icon>add</mat-icon>
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of rows(); track row.id) {
                      <tr class="data-row" [class.selected]="isRowSelected(row.id)">
                        <td class="row-select-cell">
                          <button
                            mat-icon-button
                            class="row-select-button"
                            (click)="onToggleRowSelection(row.id)">
                            @if (isRowSelected(row.id)) {
                              <mat-icon>check_box</mat-icon>
                            } @else {
                              <mat-icon>check_box_outline_blank</mat-icon>
                            }
                          </button>
                        </td>
                        @for (column of sortedColumns(); track column.id) {
                          @if (column.visible !== false) {
                            <td class="data-cell" (click)="onCellClick(row.id, column.id, $event)">
                            @if (column.type === 'checkbox') {
                              <!-- Checkbox type -->
                              <mat-checkbox
                                [checked]="row.cells[column.id] || false"
                                (change)="onUpdateCell(row.id, column.id, $event.checked)">
                              </mat-checkbox>
                            } @else if (column.type === 'select') {
                              <!-- Select type - Display as badge -->
                              <div class="select-cell">
                                @if (getSelectedChoice(row.cells[column.id], column); as selectedChoice) {
                                  <div class="selected-choice-container">
                                    <span class="choice-badge" [style.background-color]="getChoiceColor(selectedChoice.color)">
                                      {{ selectedChoice.label }}
                                      <button
                                        type="button"
                                        class="remove-choice"
                                        (click)="onUpdateCell(row.id, column.id, ''); $event.stopPropagation()">
                                        ×
                                      </button>
                                    </span>
                                    <select
                                      class="change-choice-select"
                                      [value]="''"
                                      (change)="onUpdateCell(row.id, column.id, $any($event.target).value); $any($event.target).value = ''; $event.stopPropagation()"
                                      (click)="$event.stopPropagation()">
                                      <option value="">⟳ Changer</option>
                                      @for (choice of column.options?.choices ?? []; track choice.id) {
                                        <option [value]="choice.id">{{ choice.label }}</option>
                                      }
                                    </select>
                                  </div>
                                } @else {
                                  <div class="empty-choice-container">
                                    <span class="empty-select">-</span>
                                    <select
                                      class="change-choice-select"
                                      [value]="''"
                                      (change)="onUpdateCell(row.id, column.id, $any($event.target).value); $any($event.target).value = ''; $event.stopPropagation()"
                                      (click)="$event.stopPropagation()">
                                      <option value="">+ Sélectionner</option>
                                      @for (choice of column.options?.choices ?? []; track choice.id) {
                                        <option [value]="choice.id">{{ choice.label }}</option>
                                      }
                                    </select>
                                  </div>
                                }
                              </div>
                            } @else if (column.type === 'multi-select') {
                              <!-- Multi-select type - Display as badges -->
                              <div class="multi-select-cell">
                                @if (getSelectedChoices(row.cells[column.id], column).length > 0) {
                                  <div class="selected-badges">
                                    @for (choice of getSelectedChoices(row.cells[column.id], column); track choice.id) {
                                      <span class="choice-badge" [style.background-color]="getChoiceColor(choice.color)">
                                        {{ choice.label }}
                                        <button
                                          type="button"
                                          class="remove-choice"
                                          (click)="removeChoiceFromCell(row.id, column.id, choice.id); $event.stopPropagation()">
                                          ×
                                        </button>
                                      </span>
                                    }
                                  </div>
                                } @else {
                                  <span class="empty-multi-select">-</span>
                                }
                                <select
                                  class="add-choice-select"
                                  (change)="$any($event.target).value === '__create_new__' ? onCreateNewOption(row.id, column.id) : addChoiceToCell(row.id, column.id, $any($event.target).value); $any($event.target).value = ''; $event.stopPropagation()"
                                  (click)="$event.stopPropagation()">
                                  <option value="">+ Ajouter</option>
                                  @for (choice of getAvailableChoices(row.cells[column.id], column); track choice.id) {
                                    <option [value]="choice.id">{{ choice.label }}</option>
                                  }
                                  <option value="__create_new__">✨ Créer une nouvelle option</option>
                                </select>
                              </div>
                            } @else if (column.type === 'date-range') {
                              <!-- Date Range type -->
                              <button
                                type="button"
                                class="date-range-cell"
                                (click)="onOpenDateRangePicker(row.id, column.id); $event.stopPropagation()">
                                @if (getDateRangeValue(row.cells[column.id]); as rangeValue) {
                                  <span class="date-range-value">
                                    {{ rangeValue | dateRangeFormat:columnHasIncludeTime(column) }}
                                  </span>
                                } @else {
                                  <span class="date-range-empty">
                                    <mat-icon>date_range</mat-icon>
                                    Définir
                                  </span>
                                }
                              </button>
                            } @else {
                              <!-- Text, number, date, url, email types -->
                              <input
                                type="{{ getCellInputType(column.type) }}"
                                class="cell-input"
                                [value]="row.cells[column.id] || ''"
                                (blur)="onUpdateCell(row.id, column.id, $any($event.target).value)"
                                (keydown.enter)="$any($event.target).blur()"
                                (click)="$event.stopPropagation()"
                                placeholder="-" />
                            }
                          </td>
                          }
                        }
                        <td class="row-actions-cell">
                          <button
                            mat-icon-button
                            [matMenuTriggerFor]="rowMenu"
                            matTooltip="Actions">
                            <mat-icon>more_horiz</mat-icon>
                          </button>
                          <mat-menu #rowMenu="matMenu">
                            <button mat-menu-item (click)="onOpenRowDocument(row.id)">
                              <mat-icon>open_in_new</mat-icon>
                              <span>Ouvrir</span>
                            </button>
                            <button mat-menu-item (click)="onDeleteRows([row.id])">
                              <mat-icon>delete</mat-icon>
                              <span>Supprimer</span>
                            </button>
                          </mat-menu>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <!-- Bottom Pagination Controls -->
              <mat-paginator
                [length]="totalCount()"
                [pageSize]="pageSize()"
                [pageIndex]="pageIndex()"
                [pageSizeOptions]="pageSizeOptions"
                (page)="onPageChange($event)"
                showFirstLastButtons
                class="database-paginator">
              </mat-paginator>
            }
          </div>
        }
        @case ('kanban') {
          <!-- Kanban View -->
          <app-database-kanban-view
            [rows]="rows()"
            [columns]="databaseConfig().columns"
            [groupByColumnId]="kanbanGroupByColumnId()"
            (cellUpdate)="onKanbanCellUpdate($event)"
            (addSelectColumn)="onKanbanAddSelectColumn()"
            (configureGroupBy)="onKanbanConfigureGroupBy()">
          </app-database-kanban-view>
        }
        @case ('calendar') {
          <!-- Calendar View -->
          <app-database-calendar-view
            [rows]="rows()"
            [columns]="databaseConfig().columns"
            [dateColumnId]="calendarDateColumnId()"
            [dateRangeColumnId]="calendarDateRangeColumnId()"
            (rowClick)="onCalendarRowClick($event)"
            (addDateColumn)="onCalendarAddDateColumn()"
            (configureDateColumn)="onCalendarConfigureDateColumn()"
            (selectDateColumn)="onCalendarSelectDateColumn($event)">
          </app-database-calendar-view>
        }
        @case ('timeline') {
          <app-database-timeline-view
            [rows]="rows()"
            [columns]="databaseConfig().columns"
            [startDateColumnId]="timelineStartDateColumnId()"
            [endDateColumnId]="timelineEndDateColumnId()"
            [dateRangeColumnId]="timelineDateRangeColumnId()"
            (rowClick)="onTimelineRowClick($event)"
            (addDateColumn)="onTimelineAddDateColumn()"
            (configureDateColumns)="onTimelineConfigureDateColumns()"
            (selectDateColumn)="onTimelineSelectDateColumn($event)">
          </app-database-timeline-view>
        }
      }
    </div>
  }
</div>
