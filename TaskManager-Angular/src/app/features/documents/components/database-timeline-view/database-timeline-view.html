<!-- Empty State: No date column exists -->
@if (!hasDateColumn()) {
  <div class="empty-state">
    <mat-icon class="empty-icon">timeline</mat-icon>
    <p class="empty-text">Ajoutez une colonne 'Date' pour utiliser la vue timeline</p>
    <button mat-raised-button color="primary" (click)="onAddDateColumn()">
      <mat-icon>add</mat-icon>
      Ajouter une colonne Date
    </button>
  </div>
}

<!-- Empty State: No date column configured -->
@else if (!startDateColumnId && !dateRangeColumnId) {
  <div class="empty-state">
    <mat-icon class="empty-icon">timeline</mat-icon>
    <p class="empty-text">Sélectionnez une colonne date pour afficher la timeline</p>
    @if (availableDateColumns().length > 0) {
      <button mat-raised-button color="primary" [matMenuTriggerFor]="emptyStateColumnMenu">
        <mat-icon>calendar_today</mat-icon>
        Choisir une colonne
      </button>
      <mat-menu #emptyStateColumnMenu="matMenu">
        @for (col of availableDateColumns(); track col.id) {
          <button mat-menu-item (click)="onSelectColumn(col)">
            <mat-icon>{{ col.type === 'date-range' ? 'date_range' : 'event' }}</mat-icon>
            <span>{{ col.name }}</span>
            <span class="column-type-badge">{{ col.type === 'date-range' ? 'Plage' : 'Date' }}</span>
          </button>
        }
      </mat-menu>
    } @else {
      <button mat-raised-button color="primary" (click)="onAddDateColumn()">
        <mat-icon>add</mat-icon>
        Ajouter une colonne Date
      </button>
    }
  </div>
}

<!-- Empty State: No data with dates -->
@else if (timelineItems().length === 0) {
  <div class="empty-state">
    <mat-icon class="empty-icon">timeline</mat-icon>
    <p class="empty-text">Aucune ligne avec une date à afficher</p>
  </div>
}

<!-- Timeline View -->
@else {
  <div class="timeline-view">
    <!-- Header with Controls -->
    <div class="timeline-header">
      <h3 class="timeline-header__title">Vue Timeline</h3>
      <div class="timeline-header__controls">
        <!-- Granularity Selector -->
        <button
          mat-stroked-button
          [matMenuTriggerFor]="granularityMenu"
          matTooltip="Changer la granularité temporelle">
          <mat-icon>{{ currentGranularityIcon() }}</mat-icon>
          {{ currentGranularityLabel() }}
          <mat-icon class="dropdown-icon">arrow_drop_down</mat-icon>
        </button>
        <mat-menu #granularityMenu="matMenu">
          <button
            mat-menu-item
            (click)="onSelectGranularity('auto')"
            [class.selected]="isGranularitySelected('auto')">
            <mat-icon>auto_fix_high</mat-icon>
            <span>Auto</span>
            @if (isGranularitySelected('auto')) {
              <mat-icon class="check-icon">check</mat-icon>
            }
          </button>
          <mat-divider></mat-divider>
          @for (option of granularityOptions; track option.value) {
            <button
              mat-menu-item
              (click)="onSelectGranularity(option.value)"
              [class.selected]="isGranularitySelected(option.value)">
              <mat-icon>{{ option.icon }}</mat-icon>
              <span>{{ option.label }}</span>
              @if (isGranularitySelected(option.value)) {
                <mat-icon class="check-icon">check</mat-icon>
              }
            </button>
          }
        </mat-menu>

        <!-- Column Selector - Always show to allow changing column -->
        <button
          mat-stroked-button
          [matMenuTriggerFor]="columnSelectorMenu"
          matTooltip="Changer la colonne date">
          <mat-icon>{{ isUsingDateRange() ? 'date_range' : 'event' }}</mat-icon>
          {{ selectedColumnName() }}
          <mat-icon class="dropdown-icon">arrow_drop_down</mat-icon>
        </button>
        <mat-menu #columnSelectorMenu="matMenu">
          @for (col of availableDateColumns(); track col.id) {
            <button
              mat-menu-item
              (click)="onSelectColumn(col)"
              [class.selected]="isColumnSelected(col.id)">
              <mat-icon>{{ col.type === 'date-range' ? 'date_range' : 'event' }}</mat-icon>
              <span>{{ col.name }}</span>
              @if (isColumnSelected(col.id)) {
                <mat-icon class="check-icon">check</mat-icon>
              }
            </button>
          }
        </mat-menu>
      </div>
    </div>

    <!-- Timeline Content with horizontal scroll -->
    <div class="timeline-content">
      <div class="timeline-grid" [style.min-width.px]="timelineWidth()">
        <!-- Header row with time markers -->
        <div class="timeline-grid__header">
          <div class="timeline-grid__task-column">Lignes</div>
          <div class="timeline-grid__dates" [style.width.px]="datesAreaWidth()">
            @for (marker of timeMarkers(); track marker.x) {
              <div class="timeline-grid__date-header" [style.left.px]="marker.x">
                {{ marker.label }}
              </div>
            }
          </div>
        </div>

        <!-- Background grid with vertical lines -->
        <div class="timeline-grid__background">
          <div class="timeline-grid__task-column-bg"></div>
          <div class="timeline-grid__days-bg" [style.width.px]="datesAreaWidth()">
            @for (marker of timeMarkers(); track marker.x) {
              <div class="timeline-grid__day-column" [style.left.px]="marker.x"></div>
            }
          </div>
        </div>

        <!-- Timeline rows with data -->
        <div class="timeline-grid__tasks">
          @for (item of timelineItems(); track item.id) {
            <div class="timeline-row">
              <!-- Task info (fixed left column) -->
              <div class="timeline-row__info">
                <div class="timeline-row__task-title" [matTooltip]="item.title">
                  {{ item.title }}
                </div>
              </div>

              <!-- Bar container -->
              <div class="timeline-row__bar-container" [style.width.px]="datesAreaWidth()">
                @if (item.endDate && item.width > 10) {
                  <!-- Duration bar -->
                  <div
                    class="timeline-bar"
                    role="button"
                    tabindex="0"
                    [style.left.px]="item.x"
                    [style.width.px]="item.width"
                    [style.background-color]="item.color"
                    (click)="onItemClick(item.id)"
                    (keydown.enter)="onItemClick(item.id)"
                    (keydown.space)="onItemClick(item.id)"
                    [matTooltip]="item.title">
                    <span class="timeline-bar__label">{{ item.title }}</span>
                  </div>
                } @else {
                  <!-- Single point -->
                  <div
                    class="timeline-point"
                    role="button"
                    tabindex="0"
                    [style.left.px]="item.x"
                    [style.background-color]="item.color"
                    (click)="onItemClick(item.id)"
                    (keydown.enter)="onItemClick(item.id)"
                    (keydown.space)="onItemClick(item.id)"
                    [matTooltip]="item.title">
                  </div>
                }
              </div>
            </div>
          } @empty {
            <div class="timeline-empty">
              <mat-icon>event_busy</mat-icon>
              <p>Aucune ligne avec une date à afficher</p>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
}
