<div
  class="section-card"
  [class.collapsed]="section.is_collapsed"
  [style.--section-color]="section.color || '#6366f1'">

  <!-- Header -->
  <div class="section-card__header">
    <!-- Collapse/Expand Button -->
    <button
      mat-icon-button
      class="collapse-btn"
      (click)="onToggleCollapse()"
      [matTooltip]="section.is_collapsed ? 'Développer' : 'Réduire'">
      <mat-icon>{{ section.is_collapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
    </button>

    <!-- Section Icon -->
    <mat-icon class="section-icon" [style.color]="section.color || '#6366f1'">
      {{ section.icon || 'folder_open' }}
    </mat-icon>

    <!-- Section Title -->
    <div class="section-title-container" (dblclick)="onDoubleClick()">
      @if (isEditing()) {
        <input
          type="text"
          class="title-input"
          [ngModel]="editTitle()"
          (ngModelChange)="editTitle.set($event)"
          (blur)="onTitleBlur()"
          (keydown)="onTitleKeydown($event)"
          maxlength="100"
          />
      } @else {
        <span class="section-title">{{ section.title }}</span>
        <span class="item-count">({{ itemCount }})</span>
      }
    </div>

    <!-- Actions -->
    <div class="section-actions">
      <button
        mat-icon-button
        class="add-btn"
        (click)="onAddDocument()"
        matTooltip="Ajouter un document">
        <mat-icon>add</mat-icon>
      </button>
      <button
        mat-icon-button
        class="edit-btn"
        (click)="onEdit()"
        matTooltip="Modifier la section">
        <mat-icon>edit</mat-icon>
      </button>
      <button
        mat-icon-button
        class="delete-btn"
        [disabled]="itemCount > 0"
        (click)="onDelete()"
        [matTooltip]="itemCount > 0
          ? 'Déplacez d\'abord les documents pour supprimer cette section'
          : 'Supprimer la section'">
        <mat-icon>delete_outline</mat-icon>
      </button>
    </div>
  </div>

  <!-- Content with Drop Zone -->
  @if (!section.is_collapsed) {
    <div
      class="section-card__content"
      cdkDropList
      [id]="dropListId"
      [cdkDropListData]="items"
      [cdkDropListConnectedTo]="connectedDropListIds"
      (cdkDropListDropped)="onDrop($event)">

      @if (items.length === 0) {
        <div class="drop-zone-empty">
          <mat-icon>drag_indicator</mat-icon>
          <span>Glissez des documents ici</span>
        </div>
      } @else {
        <div class="documents-grid">
          @for (item of items; track trackItem($index, item)) {
            @if (getDocumentForItem(item); as doc) {
              <div cdkDrag [cdkDragData]="item">
                <!-- Drag Preview -->
                <div *cdkDragPreview class="document-drag-preview">
                  <mat-icon>description</mat-icon>
                  <span>{{ doc.title || 'Sans titre' }}</span>
                </div>

                <!-- Drag Placeholder -->
                <div *cdkDragPlaceholder class="document-placeholder"></div>

                <!-- Document Card Component -->
                <app-document-card
                  [document]="doc"
                  [item]="item"
                  [isPinned]="item.is_pinned"
                  [childDocuments]="getChildDocuments(doc.id)"
                  [storageFiles]="getStorageFilesForDocument(doc.id)"
                  [databases]="getDatabasesForDocument(doc.id)"
                  [sectionColor]="section.color || '#6366f1'"
                  (documentClick)="onDocumentClick($event)"
                  (documentDelete)="documentDelete.emit($event)"
                  (documentUnpin)="documentUnpin.emit($event)"
                  (databaseClick)="onDatabaseClick($event)">
                </app-document-card>
              </div>
            }
          }
        </div>
      }
    </div>
  }
</div>
