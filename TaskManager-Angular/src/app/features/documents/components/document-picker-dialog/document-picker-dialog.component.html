<h2 mat-dialog-title class="dialog-title-default">
  <mat-icon>link</mat-icon>
  Épingler un document
</h2>

<mat-dialog-content class="picker-content">
  <div class="picker-search-group">
    <label class="picker-search-label">Rechercher</label>
    <div class="picker-search-wrapper">
      <mat-icon class="picker-search-icon">search</mat-icon>
      <input
        type="text"
        class="picker-search-input"
        [value]="searchQuery()"
        (input)="onSearchInput($event)"
        cdkFocusInitial
        placeholder="Documents, tâches, événements..."
      />
      @if (loading()) {
        <mat-spinner class="picker-search-spinner" diameter="18"></mat-spinner>
      }
    </div>
  </div>

  @if (resolveError()) {
    <div class="resolve-error">
      <mat-icon>error_outline</mat-icon>
      {{ resolveError() }}
    </div>
  }

  <div class="picker-results">
    @if (isSearchMode()) {
      <!-- Server search results grouped by type -->
      @if (loading()) {
        <div class="picker-empty">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Recherche en cours...</span>
        </div>
      } @else if (searchResults()!.total === 0) {
        <div class="picker-empty">
          <mat-icon>search_off</mat-icon>
          <span>Aucun résultat pour "{{ searchQuery() }}"</span>
        </div>
      } @else {
        <!-- Documents -->
        @if (searchResults()!.documents.length > 0) {
          <div class="picker-section-label">Documents</div>
          @for (result of searchResults()!.documents; track result.id) {
            <div
              class="picker-result-item"
              [class.is-selected]="isResultSelected(result)"
              (click)="selectResult(result)"
            >
              <div class="picker-result-icon icon-document">
                <mat-icon>{{ result.icon }}</mat-icon>
              </div>
              <div class="picker-result-body">
                <span class="picker-result-title">{{ result.title }}</span>
                @if (result.subtitle) {
                  <span class="picker-result-subtitle">{{ result.subtitle }}</span>
                }
              </div>
              @if (isResultSelected(result)) {
                <mat-icon class="picker-check-icon">check_circle</mat-icon>
              }
            </div>
          }
        }

        <!-- Tasks -->
        @if (searchResults()!.tasks.length > 0) {
          <div class="picker-section-label">Tâches</div>
          @for (result of searchResults()!.tasks; track result.id) {
            <div
              class="picker-result-item"
              [class.is-selected]="isResultSelected(result)"
              (click)="selectResult(result)"
            >
              <div class="picker-result-icon icon-task">
                <mat-icon>{{ result.icon }}</mat-icon>
              </div>
              <div class="picker-result-body">
                <span class="picker-result-title">{{ result.title }}</span>
                @if (result.subtitle) {
                  <span class="picker-result-subtitle picker-status">{{ result.subtitle }}</span>
                }
              </div>
              @if (isResultSelected(result)) {
                <mat-icon class="picker-check-icon">check_circle</mat-icon>
              }
            </div>
          }
        }

        <!-- Events -->
        @if (searchResults()!.events.length > 0) {
          <div class="picker-section-label">Événements</div>
          @for (result of searchResults()!.events; track result.id) {
            <div
              class="picker-result-item"
              [class.is-selected]="isResultSelected(result)"
              (click)="selectResult(result)"
            >
              <div class="picker-result-icon icon-event">
                <mat-icon>{{ result.icon }}</mat-icon>
              </div>
              <div class="picker-result-body">
                <span class="picker-result-title">{{ result.title }}</span>
                @if (result.subtitle) {
                  <span class="picker-result-subtitle">{{ result.subtitle }}</span>
                }
              </div>
              @if (isResultSelected(result)) {
                <mat-icon class="picker-check-icon">check_circle</mat-icon>
              }
            </div>
          }
        }
      }
    } @else {
      <!-- Initial display: local documents list -->
      @if (filteredDocuments().length === 0 && searchQuery().trim().length >= 2) {
        <div class="picker-empty">
          <mat-icon>search_off</mat-icon>
          <span>Aucun document trouvé</span>
        </div>
      } @else if (filteredDocuments().length === 0) {
        <div class="picker-empty">
          <mat-icon>info_outline</mat-icon>
          <span>Tous les documents sont déjà dans cet onglet</span>
        </div>
      } @else {
        <div class="picker-section-label">Documents disponibles</div>
        @for (doc of filteredDocuments(); track doc.id) {
          <div
            class="picker-result-item"
            [class.is-selected]="selectedDocument()?.id === doc.id"
            (click)="selectDocument(doc)"
          >
            <div class="picker-result-icon icon-document">
              <mat-icon>description</mat-icon>
            </div>
            <div class="picker-result-body">
              <span class="picker-result-title">{{ doc.title || 'Sans titre' }}</span>
            </div>
            @if (selectedDocument()?.id === doc.id) {
              <mat-icon class="picker-check-icon">check_circle</mat-icon>
            }
          </div>
        }
      }
    }
  </div>
</mat-dialog-content>

<mat-dialog-actions class="dialog-actions">
  <button mat-button class="dialog-btn-secondary" (click)="cancel()">
    Annuler
  </button>

  <button
    mat-raised-button
    class="dialog-btn-primary"
    [disabled]="!hasSelection() || resolving()"
    (click)="confirmSelection()">
    @if (resolving()) {
      <mat-spinner diameter="18"></mat-spinner>
    } @else {
      <mat-icon>push_pin</mat-icon>
    }
    Épingler
  </button>
</mat-dialog-actions>
