<h2 mat-dialog-title class="dialog-title-default">
  <mat-icon>{{ isEditMode() ? 'edit' : 'image' }}</mat-icon>
  {{ isEditMode() ? 'Éditer l\'image' : 'Insérer une image' }}
</h2>

<mat-dialog-content class="dialog-content">
  <form [formGroup]="imageForm" class="dialog-form image-form">

    <!-- Tabs pour la source de l'image -->
    <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="source-tabs">

      <!-- Tab URL -->
      <mat-tab label="URL">
        <div class="tab-content">
          <!-- URL de l'image -->
          <div class="c-form-group">
            <label class="c-label" for="imageUrl">URL de l'image</label>
            <div class="c-input-wrapper">
              <span class="material-icons-outlined c-input-icon">link</span>
              <input
                class="c-input"
                [class.c-input--error]="imageForm.get('src')?.hasError('required') && imageForm.get('src')?.touched || imageForm.get('src')?.hasError('invalidUrl') && imageForm.get('src')?.touched"
                id="imageUrl"
                type="url"
                formControlName="src"
                placeholder="https://exemple.com/image.jpg"
              />
            </div>
            @if (imageForm.get('src')?.hasError('required') && imageForm.get('src')?.touched) {
              <span class="c-error-text">L'URL est requise</span>
            }
            @if (imageForm.get('src')?.hasError('invalidUrl') && imageForm.get('src')?.touched) {
              <span class="c-error-text">URL invalide</span>
            }
          </div>

          <!-- Preview de l'image -->
          <div class="image-preview-container">
            @if (isLoadingPreview()) {
              <div class="preview-loading">
                <mat-spinner diameter="40"></mat-spinner>
                <span>Chargement de l'image...</span>
              </div>
            } @else if (imageLoadError()) {
              <div class="preview-error">
                <mat-icon>broken_image</mat-icon>
                <span>Impossible de charger l'image</span>
                <small>Vérifiez que l'URL est correcte et accessible</small>
              </div>
            } @else if (imagePreviewUrl()) {
              <img [src]="imagePreviewUrl()" [alt]="imageForm.get('alt')?.value || 'Preview'" />
            } @else {
              <div class="preview-placeholder">
                <mat-icon>image</mat-icon>
                <span>La prévisualisation apparaîtra ici</span>
              </div>
            }
          </div>
        </div>
      </mat-tab>

      <!-- Tab Upload -->
      <mat-tab label="Upload">
        <div class="tab-content">
          <app-file-dropzone
            [bucket]="'documents-assets'"
            [path]="'documents/images/'"
            [acceptedTypes]="'image/*'"
            [maxSize]="10485760"
            [instructionMessage]="'Glissez une image ici ou cliquez pour sélectionner'"
            (fileUploaded)="onFileUploaded($event)"
            (uploadError)="onUploadError($event)"
          />

          <!-- Preview de l'image uploadée -->
          @if (uploadedFileUrl()) {
            <div class="uploaded-preview">
              <div class="preview-header">
                <mat-icon class="success-icon">check_circle</mat-icon>
                <span>Image uploadée avec succès</span>
              </div>
              <div class="image-preview-container">
                <img [src]="uploadedFileUrl()" [alt]="imageForm.get('alt')?.value || 'Image uploadée'" />
              </div>
            </div>
          }
        </div>
      </mat-tab>

    </mat-tab-group>

    <!-- Texte alternatif -->
    <div class="c-form-group">
      <label class="c-label" for="imageAlt">Texte alternatif (pour l'accessibilité)</label>
      <div class="c-input-wrapper">
        <span class="material-icons-outlined c-input-icon">accessibility</span>
        <input
          class="c-input"
          [class.c-input--error]="imageForm.get('alt')?.hasError('required') && imageForm.get('alt')?.touched || imageForm.get('alt')?.hasError('minlength') && imageForm.get('alt')?.touched"
          id="imageAlt"
          type="text"
          formControlName="alt"
          placeholder="Décrivez l'image..."
        />
      </div>
      @if (imageForm.get('alt')?.hasError('required') && imageForm.get('alt')?.touched) {
        <span class="c-error-text">Le texte alternatif est requis</span>
      }
      @if (imageForm.get('alt')?.hasError('minlength') && imageForm.get('alt')?.touched) {
        <span class="c-error-text">Minimum 3 caractères</span>
      }
    </div>

    <!-- Alignement -->
    <div class="c-form-group">
      <span class="c-label">Alignement</span>
      <mat-radio-group formControlName="alignment" class="alignment-options">
        @for (option of alignmentOptions; track option.value) {
          <mat-radio-button
            [value]="option.value"
            [matTooltip]="option.label">
            <div class="alignment-option">
              <span class="material-icons-outlined">{{ option.icon }}</span>
            </div>
          </mat-radio-button>
        }
      </mat-radio-group>
    </div>

    <!-- Légende (optionnelle) -->
    <div class="c-form-group">
      <label class="c-label" for="imageCaption">Légende (optionnelle)</label>
      <div class="c-input-wrapper">
        <span class="material-icons-outlined c-input-icon">notes</span>
        <textarea
          class="c-textarea"
          id="imageCaption"
          formControlName="caption"
          placeholder="Ajoutez une légende à votre image..."
          rows="2"
          maxlength="500"
        ></textarea>
      </div>
      <span class="c-hint">{{ imageForm.get('caption')?.value?.length || 0 }} / 500</span>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions class="dialog-actions">
  <button mat-button class="dialog-btn-secondary" (click)="onCancel()">
    <mat-icon>cancel</mat-icon>
    Annuler
  </button>
  <button
    mat-raised-button
    class="dialog-btn-primary"
    (click)="onConfirm()"
    [disabled]="!isFormValid"
    cdkFocusInitial
  >
    <mat-icon>{{ isEditMode() ? 'check' : 'add_photo_alternate' }}</mat-icon>
    {{ isEditMode() ? 'Valider' : 'Insérer' }}
  </button>
</mat-dialog-actions>
