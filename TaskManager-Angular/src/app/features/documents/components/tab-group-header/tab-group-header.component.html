<div
  class="group-container"
  [class.collapsed]="group.is_collapsed"
  [class.drag-over]="isDragOver"
  [style.--group-color]="group.color">

  <!-- Group Header -->
  <div class="group-header" tabindex="0" (click)="onToggleCollapse()" (keydown.enter)="onToggleCollapse()" cdkDragHandle>
    <button mat-icon-button class="collapse-btn" [matTooltip]="group.is_collapsed ? 'Déplier' : 'Replier'">
      <mat-icon>{{ group.is_collapsed ? 'chevron_right' : 'expand_more' }}</mat-icon>
    </button>

    <span class="group-name">{{ group.name }}</span>
    <span class="group-count">{{ tabs.length }}</span>

    <!-- Group Menu -->
    <button
      mat-icon-button
      class="group-menu-btn"
      [matMenuTriggerFor]="groupMenu"
      (click)="$event.stopPropagation()">
      <mat-icon>more_vert</mat-icon>
    </button>

    <mat-menu #groupMenu="matMenu">
      <button mat-menu-item (click)="onEditGroup($event)">
        <mat-icon>edit</mat-icon>
        <span>Modifier</span>
      </button>
      <button mat-menu-item (click)="onDeleteGroup($event)" class="delete-option">
        <mat-icon color="warn">delete</mat-icon>
        <span>Dissoudre le groupe</span>
      </button>
    </mat-menu>
  </div>

  <!-- Grouped Tabs (collapsible) - This is the drop list for tabs -->
  @if (!group.is_collapsed) {
    <div
      class="grouped-tabs"
      cdkDropList
      [id]="getDropListId()"
      [cdkDropListData]="tabs"
      [cdkDropListConnectedTo]="connectedDropListIds"
      cdkDropListOrientation="horizontal"
      (cdkDropListDropped)="onDrop($event)"
      (cdkDropListEntered)="isDragOver = true"
      (cdkDropListExited)="isDragOver = false">
      @for (tab of tabs; track trackTab($index, tab)) {
        <div
          class="tab-item-wrapper"
          cdkDrag
          [cdkDragData]="tab"
          (cdkDragStarted)="onTabDragStart(tab)"
          (cdkDragEnded)="onTabDragEnd()">

          <!-- Drag Preview -->
          <div *cdkDragPreview class="tab-drag-preview" [style.border-color]="tab.color">
            <mat-icon [style.color]="tab.color">{{ tab.icon }}</mat-icon>
            <span>{{ tab.name }}</span>
          </div>

          <!-- Drag Placeholder -->
          <div *cdkDragPlaceholder class="tab-placeholder"></div>

          <div
            class="tab-item"
            tabindex="0"
            [class.selected]="isTabSelected(tab.id)"
            [style.--tab-color]="tab.color"
            (click)="onTabClick(tab.id, $event)"
            (keydown.enter)="onTabClick(tab.id, $event)">

            <mat-icon class="tab-icon" [style.color]="isTabSelected(tab.id) ? tab.color : null">
              {{ tab.icon }}
            </mat-icon>
            <span class="tab-name">{{ tab.name }}</span>

            <!-- Tab Menu -->
            <button
              mat-icon-button
              class="tab-menu-btn"
              [matMenuTriggerFor]="tabMenu"
              (click)="$event.stopPropagation()">
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #tabMenu="matMenu">
              <button mat-menu-item (click)="onTabEdit(tab, $event)">
                <mat-icon>edit</mat-icon>
                <span>Modifier</span>
              </button>
              <button mat-menu-item (click)="onRemoveFromGroup(tab.id, $event)">
                <mat-icon>logout</mat-icon>
                <span>Retirer du groupe</span>
              </button>
              <button
                mat-menu-item
                [disabled]="!canDeleteTab(tab.id)"
                (click)="onTabDelete(tab.id, $event)"
                class="delete-option"
                [matTooltip]="!canDeleteTab(tab.id) ? 'Déplacez d\'abord les documents' : ''">
                <mat-icon [color]="canDeleteTab(tab.id) ? 'warn' : ''">delete</mat-icon>
                <span>Supprimer</span>
              </button>
            </mat-menu>

            <!-- Selection Indicator -->
            @if (isTabSelected(tab.id)) {
              <div class="selection-indicator" [style.background-color]="tab.color"></div>
            }
          </div>
        </div>
      }
    </div>
  } @else {
    <!-- Collapsed state: still allow dropping tabs into the group -->
    <div
      class="grouped-tabs-collapsed"
      cdkDropList
      [id]="getDropListId()"
      [cdkDropListData]="tabs"
      [cdkDropListConnectedTo]="connectedDropListIds"
      (cdkDropListDropped)="onDrop($event)"
      (cdkDropListEntered)="isDragOver = true"
      (cdkDropListExited)="isDragOver = false">
    </div>
  }
</div>
