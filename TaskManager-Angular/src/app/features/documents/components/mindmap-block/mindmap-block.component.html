<div class="mindmap-container" tabindex="0">
  <!-- Toolbar -->
  <div class="mindmap-toolbar">
    <div class="toolbar-left">
      <span class="mindmap-title">{{ config().name }}</span>
    </div>

    <div class="toolbar-center">
      <!-- Undo/Redo -->
      <button
        mat-icon-button
        (click)="undo()"
        [disabled]="!canUndo()"
        matTooltip="Annuler (Ctrl+Z)"
      >
        <mat-icon>undo</mat-icon>
      </button>
      <button
        mat-icon-button
        (click)="redo()"
        [disabled]="!canRedo()"
        matTooltip="Refaire (Ctrl+Shift+Z)"
      >
        <mat-icon>redo</mat-icon>
      </button>

      <mat-divider vertical class="toolbar-divider"></mat-divider>

      <!-- Layout selector -->
      <button
        mat-icon-button
        [matMenuTriggerFor]="layoutMenu"
        matTooltip="Layout"
      >
        <mat-icon>account_tree</mat-icon>
      </button>
      <mat-menu #layoutMenu="matMenu">
        <button mat-menu-item (click)="setLayout('horizontal')">
          <mat-icon>arrow_forward</mat-icon>
          <span>Horizontal</span>
        </button>
        <button mat-menu-item (click)="setLayout('tree')">
          <mat-icon>arrow_downward</mat-icon>
          <span>Vertical</span>
        </button>
        <button mat-menu-item (click)="setLayout('radial')">
          <mat-icon>radio_button_unchecked</mat-icon>
          <span>Radial</span>
        </button>
      </mat-menu>

      <!-- Theme selector -->
      <button
        mat-icon-button
        [matMenuTriggerFor]="themeMenu"
        matTooltip="Theme"
      >
        <mat-icon>palette</mat-icon>
      </button>
      <mat-menu #themeMenu="matMenu">
        <button mat-menu-item (click)="setTheme('default')">
          <span class="theme-dot theme-default"></span>
          <span>Default (Blue)</span>
        </button>
        <button mat-menu-item (click)="setTheme('ocean')">
          <span class="theme-dot theme-ocean"></span>
          <span>Ocean</span>
        </button>
        <button mat-menu-item (click)="setTheme('forest')">
          <span class="theme-dot theme-forest"></span>
          <span>Forest</span>
        </button>
        <button mat-menu-item (click)="setTheme('sunset')">
          <span class="theme-dot theme-sunset"></span>
          <span>Sunset</span>
        </button>
        <button mat-menu-item (click)="setTheme('monochrome')">
          <span class="theme-dot theme-monochrome"></span>
          <span>Monochrome</span>
        </button>
      </mat-menu>

      <mat-divider vertical class="toolbar-divider"></mat-divider>

      <!-- Collapse/Expand -->
      <button
        mat-icon-button
        (click)="collapseAll()"
        matTooltip="Tout replier"
      >
        <mat-icon>unfold_less</mat-icon>
      </button>
      <button
        mat-icon-button
        (click)="expandAll()"
        matTooltip="Tout déplier"
      >
        <mat-icon>unfold_more</mat-icon>
      </button>

      <mat-divider vertical class="toolbar-divider"></mat-divider>

      <!-- Add child button -->
      <button
        mat-icon-button
        (click)="addChildToSelected()"
        [disabled]="!selectedNodeId()"
        matTooltip="Ajouter un enfant (Tab)"
      >
        <mat-icon>add_circle</mat-icon>
      </button>

      <mat-divider vertical class="toolbar-divider"></mat-divider>

      <!-- Add sticky note button -->
      <button
        mat-icon-button
        (click)="addStickyNote()"
        matTooltip="Ajouter une note (N)"
      >
        <mat-icon>sticky_note_2</mat-icon>
      </button>

      <!-- Node style (when node selected) -->
      @if (selectedNodeId()) {
        <button
          mat-icon-button
          [matMenuTriggerFor]="styleMenu"
          matTooltip="Style du noeud"
        >
          <mat-icon>format_paint</mat-icon>
        </button>
        <mat-menu #styleMenu="matMenu" class="style-menu">
          <div class="style-menu-content" (click)="$event.stopPropagation()">
            <div class="style-section">
              <label class="style-label">Forme</label>
              <app-shape-selector
                [selectedShape]="getSelectedNodeShape()"
                (shapeChange)="setNodeShape($event)"
              />
            </div>
            <mat-divider></mat-divider>
            <div class="style-section">
              <label class="style-label">Couleur</label>
              <app-color-picker
                [selectedColor]="getSelectedNodeColor()"
                [showTrigger]="false"
                (colorChange)="setNodeColor($event)"
              />
            </div>
          </div>
        </mat-menu>
      }
    </div>

    <div class="toolbar-right">
      <!-- Export menu -->
      <button
        mat-icon-button
        [matMenuTriggerFor]="exportMenu"
        matTooltip="Exporter"
      >
        <mat-icon>download</mat-icon>
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportPng()">
          <mat-icon>image</mat-icon>
          <span>Exporter PNG</span>
        </button>
        <button mat-menu-item (click)="exportSvg()">
          <mat-icon>code</mat-icon>
          <span>Exporter SVG</span>
        </button>
      </mat-menu>

      <!-- Navigator toggle -->
      <button
        mat-icon-button
        (click)="toggleNavigator()"
        [class.active]="showNavigator()"
        matTooltip="Minimap"
      >
        <mat-icon>map</mat-icon>
      </button>

      <mat-divider vertical class="toolbar-divider"></mat-divider>

      <!-- Zoom controls -->
      <button mat-icon-button (click)="zoomOut()" matTooltip="Zoom -">
        <mat-icon>remove</mat-icon>
      </button>
      <span class="zoom-level">{{ (currentZoom() * 100).toFixed(0) }}%</span>
      <button mat-icon-button (click)="zoomIn()" matTooltip="Zoom +">
        <mat-icon>add</mat-icon>
      </button>
      <button mat-icon-button (click)="resetZoom()" matTooltip="Recentrer">
        <mat-icon>center_focus_strong</mat-icon>
      </button>
      <button mat-icon-button (click)="fitToContent()" matTooltip="Ajuster">
        <mat-icon>fit_screen</mat-icon>
      </button>

      <mat-divider vertical class="toolbar-divider"></mat-divider>

      <!-- Delete mindmap -->
      <button
        mat-icon-button
        (click)="deleteMindmap()"
        matTooltip="Supprimer"
        class="delete-btn"
      >
        <mat-icon>delete</mat-icon>
      </button>
    </div>
  </div>

  <!-- Main content area -->
  <div class="mindmap-content" #mindmapContent>
    <!-- Cytoscape Container -->
    <div #cyContainer class="cy-container"></div>

    <!-- Navigator (Minimap) -->
    @if (showNavigator()) {
    <div #navigatorContainer class="navigator-container"></div>
    }
  </div>

  <!-- Sticky Notes Layer - Outside cy-container to avoid event capture -->
  <div class="sticky-notes-layer" #stickyNotesLayer>
    @for (note of stickyNotes(); track note.id) {
      <app-sticky-note
        [note]="note"
        [scale]="currentZoom()"
        [style.left.px]="getScreenPosition(note.position).x"
        [style.top.px]="getScreenPosition(note.position).y"
        [style.z-index]="note.zIndex + 1000"
        [style.transform]="'scale(' + currentZoom() + ')'"
        [style.transform-origin]="'top left'"
        (positionChange)="onStickyNotePositionChange(note.id, $event)"
        (contentChange)="updateStickyNote(note.id, { content: $event })"
        (colorChange)="updateStickyNote(note.id, { color: $event })"
        (deleteNote)="deleteStickyNote(note.id)"
      />
    }
  </div>

  <!-- Help text -->
  <div class="help-text">
    <span>Double-clic: éditer contenu</span>
    <span class="separator">|</span>
    <span>E: édition rapide</span>
    <span class="separator">|</span>
    <span>Tab: ajouter enfant</span>
    <span class="separator">|</span>
    <span>Espace: replier/déplier</span>
    <span class="separator">|</span>
    <span>Glisser: reparenter</span>
  </div>

  <!-- Inline editing overlay -->
  @if (editingNodeId()) {
  <div class="editing-overlay" (click)="saveLabel()">
    <div class="editing-input-container" (click)="$event.stopPropagation()">
      <input
        type="text"
        [(ngModel)]="editingLabel"
        (keydown.enter)="saveLabel()"
        (keydown.escape)="cancelEditing()"
        (blur)="onEditInputBlur($event)"
        class="editing-input"
        placeholder="Entrez le texte..."
        autofocus
        #editInput
      />
      <div class="editing-actions">
        <button mat-icon-button (click)="saveLabel()" color="primary">
          <mat-icon>check</mat-icon>
        </button>
        <button mat-icon-button (click)="cancelEditing()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Selected node actions -->
  @if (selectedNodeId() && selectedNodeId() !== mindmapData().rootId) {
  <div class="node-actions-bar">
    <button mat-stroked-button (click)="deleteSelectedNode()" color="warn">
      <mat-icon>delete</mat-icon>
      Supprimer le noeud
    </button>
  </div>
  }

  <!-- Rich content tooltip -->
  @if (tooltipVisible() && tooltipContent()) {
  <div
    class="node-tooltip"
    [style.left.px]="tooltipPosition().x"
    [style.top.px]="tooltipPosition().y"
    [innerHTML]="tooltipContent()"
  ></div>
  }
</div>
