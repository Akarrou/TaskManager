@if (tab) {
  <div class="tab-content">
    <!-- Unsectioned Documents Box (Left Sidebar) -->
    <div class="unsectioned-box" [class.has-sections]="tab.sections.length > 0">
      <div class="unsectioned-box__header">
        <mat-icon class="unsectioned-box__icon">inbox</mat-icon>
        <span class="unsectioned-box__title">Sans section</span>
        @if (tab.unsectionedItems.length > 0) {
          <span class="unsectioned-box__count">{{ tab.unsectionedItems.length }}</span>
        }
      </div>

      @if (tab.sections.length > 0 && tab.unsectionedItems.length > 0) {
        <p class="unsectioned-box__hint">Glissez vers une section pour organiser</p>
      }

      <div
        class="unsectioned-box__content"
        cdkDropList
        [id]="getDropListId(null)"
        [cdkDropListData]="tab.unsectionedItems"
        [cdkDropListConnectedTo]="allDropListIds"
        (cdkDropListDropped)="onDrop($event, null)">

        @if (tab.unsectionedItems.length === 0 && tab.sections.length === 0) {
          <div class="unsectioned-box__empty">
            <mat-icon class="empty-icon">note_add</mat-icon>
            <p>Aucun document dans cet onglet</p>
            <span class="empty-hint">Glissez des documents ici depuis la zone "Non organisés"</span>
          </div>
        } @else if (tab.unsectionedItems.length === 0 && tab.sections.length > 0) {
          <div class="unsectioned-box__drop-zone">
            <mat-icon>add_circle_outline</mat-icon>
            <span>Glissez des documents ici</span>
          </div>
        } @else {
          <div class="unsectioned-box__documents">
            @for (item of tab.unsectionedItems; track trackItem($index, item)) {
              @if (getDocumentForItem(item); as doc) {
                <div
                  class="unsectioned-doc-card"
                  cdkDrag
                  [cdkDragData]="item"
                  (click)="onDocumentClick(doc.id)">

                  <!-- Drag Preview -->
                  <div *cdkDragPreview class="document-drag-preview">
                    <mat-icon>description</mat-icon>
                    <span>{{ doc.title || 'Sans titre' }}</span>
                  </div>

                  <!-- Drag Placeholder -->
                  <div *cdkDragPlaceholder class="unsectioned-doc-placeholder"></div>

                  <div class="unsectioned-doc-card__drag-handle" cdkDragHandle>
                    <mat-icon>drag_indicator</mat-icon>
                  </div>
                  <div class="unsectioned-doc-card__content">
                    <mat-icon class="unsectioned-doc-card__icon">description</mat-icon>
                    <div class="unsectioned-doc-card__info">
                      <span class="unsectioned-doc-card__title">{{ doc.title || 'Sans titre' }}</span>
                      <span class="unsectioned-doc-card__date">{{ doc.updated_at | date:'dd/MM' }}</span>
                    </div>
                  </div>
                  <button
                    mat-icon-button
                    class="unsectioned-doc-card__delete"
                    (click)="onDocumentDelete({ event: $event, documentId: doc.id })"
                    title="Supprimer">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            }
          </div>
        }
      </div>
    </div>

    <!-- Main Content (Right): Sections -->
    <div class="tab-content-main">
      <!-- Sections Drop List -->
      <div
        class="sections-list"
        cdkDropList
        cdkDropListOrientation="vertical"
        [cdkDropListData]="tab.sections"
        (cdkDropListDropped)="onSectionDrop($event)">

        @for (section of tab.sections; track trackSection($index, section)) {
        <div
          class="section-wrapper"
          cdkDrag
          [cdkDragData]="section">

          <!-- Section Drag Handle (outside the card) -->
          <div class="section-drag-handle" cdkDragHandle matTooltip="Glisser pour réorganiser">
            <mat-icon>drag_indicator</mat-icon>
          </div>

          <!-- Section Drag Preview -->
          <div *cdkDragPreview class="section-drag-preview">
            <mat-icon [style.color]="section.color || '#6366f1'">{{ section.icon || 'folder_open' }}</mat-icon>
            <span>{{ section.title }}</span>
          </div>

          <!-- Section Drag Placeholder -->
          <div *cdkDragPlaceholder class="section-placeholder"></div>

          <!-- Section Card Component -->
          <app-document-section-card
            [section]="section"
            [items]="section.items"
            [documents]="documents"
            [storageFiles]="storageFiles"
            [dropListId]="getDropListId(section.id)"
            [connectedDropListIds]="allDropListIds"
            (titleChange)="onSectionTitleChange(section.id, $event)"
            (sectionUpdate)="onSectionFullUpdate(section.id, $event)"
            (toggleCollapse)="onSectionToggleCollapse(section.id)"
            (delete)="onSectionDelete(section.id)"
            (documentClick)="onDocumentClick($event)"
            (documentDelete)="onDocumentDelete($event)"
            (drop)="onDrop($event, section.id)">
          </app-document-section-card>
        </div>
        }
      </div>

      <!-- Add Section Button -->
      <div class="add-section-container">
        <button mat-stroked-button class="add-section-btn" (click)="onAddSection()">
          <mat-icon>add</mat-icon>
          <span>Ajouter une section</span>
        </button>
      </div>
    </div>
  </div>
} @else {
  <div class="no-tab-selected">
    <mat-icon>tab</mat-icon>
    <p>Sélectionnez ou créez un onglet pour organiser vos documents</p>
  </div>
}
