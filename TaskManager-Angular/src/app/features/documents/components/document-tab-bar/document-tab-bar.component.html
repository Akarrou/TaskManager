<div class="tab-bar">
  <div class="tabs-container">
    <!-- Groups Container (for drag & drop reorder) -->
    <div
      class="groups-container"
      cdkDropList
      id="groups-list"
      [cdkDropListData]="tabsByGroup"
      cdkDropListOrientation="horizontal"
      (cdkDropListDropped)="onGroupDrop($event)">
      @for (group of tabsByGroup; track trackGroup($index, group)) {
        <div class="group-wrapper" cdkDrag [cdkDragData]="group" [cdkDragDisabled]="isDraggingTab">
          <!-- Group Drag Preview -->
          <div *cdkDragPreview class="group-drag-preview" [style.border-color]="group.color">
            <mat-icon [style.color]="group.color">folder</mat-icon>
            <span>{{ group.name }}</span>
            <span class="group-count-preview">{{ group.tabs.length }}</span>
          </div>

          <!-- Group Drag Placeholder -->
          <div *cdkDragPlaceholder class="group-placeholder"></div>

          <app-tab-group-header
            [group]="group"
            [tabs]="group.tabs"
            [selectedTabId]="selectedTabId"
            [tabItemCounts]="tabItemCounts"
            [connectedDropListIds]="getTabDragDropListIds()"
            (toggleCollapse)="onGroupToggleCollapse(group.id)"
            (editGroup)="onGroupUpdate(group.id, $event)"
            (deleteGroup)="onGroupDelete(group.id)"
            (tabSelect)="tabSelect.emit($event)"
            (tabEdit)="onEditTabFromGroup($event)"
            (tabDelete)="tabDelete.emit($event)"
            (tabRemoveFromGroup)="onTabRemoveFromGroup($event)"
            (tabDroppedInGroup)="onTabDroppedInGroup(group.id, $event)"
            (tabDragStarted)="onTabDragStart($event)"
            (tabDragEnded)="onTabDragEnd()">
          </app-tab-group-header>
        </div>
      }
    </div>

    <!-- Ungrouped Tabs -->
    <div
      class="ungrouped-tabs-container"
      [class.empty]="ungroupedTabs.length === 0 && tabsByGroup.length > 0"
      [class.drag-active]="isDraggingTab"
      cdkDropList
      id="ungrouped-tabs"
      [cdkDropListConnectedTo]="getTabDragDropListIds()"
      cdkDropListOrientation="horizontal"
      (cdkDropListDropped)="onUngroupedTabDrop($event)"
      (cdkDropListEntered)="onUngroupedDragEnter()"
      (cdkDropListExited)="onUngroupedDragLeave()">

      <!-- Empty state placeholder when no ungrouped tabs but groups exist -->
      @if (ungroupedTabs.length === 0 && tabsByGroup.length > 0) {
        <div class="ungrouped-empty-placeholder">
          <mat-icon>tab_unselected</mat-icon>
          <span>Déposer ici</span>
        </div>
      }

      @for (tab of ungroupedTabs; track trackTab($index, tab)) {
        <!-- Tab item with drag capability -->
        <div
          class="tab-item-wrapper"
          cdkDrag
          [cdkDragData]="tab"
          (cdkDragStarted)="onTabDragStart(tab)"
          (cdkDragEnded)="onTabDragEnd()">

          <!-- Drag Preview -->
          <div *cdkDragPreview class="tab-drag-preview" [style.border-color]="tab.color">
            <mat-icon [style.color]="tab.color">{{ tab.icon }}</mat-icon>
            <span>{{ tab.name }}</span>
          </div>

          <!-- Drag Placeholder -->
          <div *cdkDragPlaceholder class="tab-placeholder"></div>

          <!-- Tab with document drop zone -->
          <div
            class="tab-item"
            [class.selected]="isSelected(tab.id)"
            [class.drag-over]="dragOverTabId === tab.id"
            [class.drag-target]="draggedTab && draggedTab.id !== tab.id"
            [style.--tab-color]="tab.color"
            cdkDropList
            [id]="getTabDropListId(tab.id)"
            [cdkDropListConnectedTo]="allDropListIds"
            (cdkDropListDropped)="onDocumentDropOnTab($event, tab.id)"
            (cdkDropListEntered)="onDragEnterTab(tab.id)"
            (cdkDropListExited)="onDragLeaveTab()"
            (click)="onTabClick(tab.id)">

            <!-- Tab Content -->
            <div class="tab-content">
              <mat-icon class="tab-icon" [style.color]="isSelected(tab.id) ? tab.color : null">
                {{ tab.icon }}
              </mat-icon>
              <span class="tab-name">{{ tab.name }}</span>

              <!-- Tab Menu -->
              <button
                mat-icon-button
                class="tab-menu-btn"
                [matMenuTriggerFor]="tabMenu"
                (click)="$event.stopPropagation()">
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #tabMenu="matMenu">
                <button mat-menu-item (click)="onEditTab(tab, $event)">
                  <mat-icon>edit</mat-icon>
                  <span>Modifier</span>
                </button>
                <button
                  mat-menu-item
                  [disabled]="!canDeleteTab(tab.id)"
                  (click)="onDeleteTab(tab, $event)"
                  class="delete-option"
                  [matTooltip]="!canDeleteTab(tab.id) ? 'Déplacez d\'abord les documents pour supprimer cet onglet' : ''">
                  <mat-icon [color]="canDeleteTab(tab.id) ? 'warn' : ''">delete</mat-icon>
                  <span>Supprimer</span>
                </button>
              </mat-menu>
            </div>

            <!-- Selection Indicator -->
            @if (isSelected(tab.id)) {
              <div class="selection-indicator" [style.background-color]="tab.color"></div>
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <button
      mat-icon-button
      class="add-tab-btn"
      (click)="onAddTab()"
      matTooltip="Nouvel onglet">
      <mat-icon>add</mat-icon>
    </button>

    <button
      mat-icon-button
      class="add-group-btn"
      (click)="onAddGroup()"
      matTooltip="Nouveau groupe">
      <mat-icon>create_new_folder</mat-icon>
    </button>
  </div>
</div>
