<div class="document-container">
  <!-- Navigation Header with breadcrumb -->
  <div class="document-header">
    <button class="back-button" (click)="navigateBack()" title="Retour">
      <span class="material-icons-outlined">arrow_back</span>
    </button>

    <div class="breadcrumb">
      <a [routerLink]="breadcrumbRoot().route" class="breadcrumb-item">{{ breadcrumbRoot().label }}</a>
      <span class="breadcrumb-separator">/</span>

      <!-- Display parent hierarchy -->
      @for (crumb of breadcrumbs(); track crumb.id; let isLast = $last) {
        @if (!isLast) {
          <a [routerLink]="['/documents', crumb.id]" class="breadcrumb-item">{{ crumb.title }}</a>
          <span class="breadcrumb-separator">/</span>
        } @else {
          <!-- Editable title in breadcrumb -->
          @if (!isEditingTitle()) {
            <button class="breadcrumb-current" (click)="startEditingTitle()">
              {{ crumb.title }}
              <mat-icon class="edit-icon">edit</mat-icon>
            </button>
          } @else {
            <input
              #titleInput
              type="text"
              class="breadcrumb-title-input"
              [value]="tempTitle()"
              (input)="tempTitle.set($any($event.target).value)"
              (blur)="saveTitle()"
              (keydown.enter)="saveTitle()"
              (keydown.escape)="cancelEditTitle()"
            />
          }
        }
      }
    </div>

    <!-- Comment toggle button -->
    <button
      class="comment-toggle-button"
      (click)="openCommentPanel(null)"
      [class.active]="commentPanelOpen()"
      title="Ajouter un commentaire"
    >
      <mat-icon>add_comment</mat-icon>
    </button>

    <!-- Properties toggle button (only for task documents) -->
    @if (isDatabaseRowDocument()) {
      <button
        class="properties-toggle-button"
        (click)="togglePropertiesPanel()"
        [class.active]="propertiesPanelOpen()"
        title="Ouvrir les propriétés"
      >
        <mat-icon>tune</mat-icon>
      </button>
    }
  </div>

  <!-- Pinned Properties & Save Status Row -->
  <div class="properties-status-row">
    <!-- Task Number (fixed on the left) -->
    @if (isDatabaseRowDocument() && getTaskNumber()) {
      <div class="task-number-display">
        <mat-icon class="task-number-icon">tag</mat-icon>
        <span class="task-number-value">{{ getTaskNumber() }}</span>
      </div>
    }

    <!-- Pinned Properties (left side, only for task documents) -->
    @if (isDatabaseRowDocument() && databaseRow() && getPinnedColumns().length > 0) {
      <div class="pinned-properties">
        @for (column of getPinnedColumns(); track column.id) {
          <div
            class="pinned-property-item"
            [style.background-color]="getColumnColor(column).bg"
          >
            <span
              class="pinned-property-label"
              [style.color]="getColumnColor(column).text"
            >
              {{ column.name }}
            </span>
            <span
              class="pinned-property-value"
              [style.color]="getColumnColor(column).text"
            >
              {{ getPropertyDisplayValue(column, databaseRow()!.cells[column.id]) }}
            </span>
            <button
              class="unpin-button"
              (click)="toggleColumnPin(column.id)"
              title="Désépingler"
            >
              <mat-icon [style.color]="getColumnColor(column).text">close</mat-icon>
            </button>
          </div>
        }
      </div>
    }

    <!-- Save Status Indicator (right side) -->
    <div class="save-status">
      <span *ngIf="documentState().isSaving">
        <span class="save-indicator"></span>
        Sauvegarde...
      </span>
      <span *ngIf="!documentState().isSaving && documentState().lastSaved">
        Dernière modification : {{ documentState().lastSaved | date:'HH:mm' }}
      </span>
      <span *ngIf="isDirty()" class="text-orange-500 text-xs ml-2">
        • Non sauvegardé
      </span>
    </div>
  </div>

  <!-- Editor Content -->
  <div
    class="editor-wrapper"
    (click)="focusEditor($event); onEditorClick($event)"
    appTaskSectionRenderer
    appDatabaseTableRenderer
    appMindmapRenderer
    appSpreadsheetRenderer
    appCommentIndicator
    [documentId]="documentState().id || ''"
    [editor]="editor"
    [blocksWithComments]="blocksWithComments()"
    [blockCommentCounts]="blockCommentCounts()">
    <tiptap-editor
      [editor]="editor"
      class="editor-content">
    </tiptap-editor>
  </div>

  <!-- Slash Menu -->
  <app-slash-menu
    *ngIf="showSlashMenu()"
    [items]="menuItems"
    [selectedIndex]="slashMenuIndex()"
    [filterText]="slashFilterText()"
    (commandSelected)="executeCommand($event)"
    (closeMenu)="closeSlashMenu()"
    [style.top.px]="slashMenuPosition().top"
    [style.left.px]="slashMenuPosition().left"
    class="slash-menu">
  </app-slash-menu>

  <!-- Bubble Menu (text selection) -->
  <app-bubble-menu
    *ngIf="showBubbleMenu() && !isDragging() && !bubbleMenuDisabled()"
    [editor]="editor"
    [style.top.px]="bubbleMenuPosition().top"
    [style.left.px]="bubbleMenuPosition().left"
    class="bubble-menu-wrapper">
  </app-bubble-menu>

  <!-- Image Bubble Menu -->
  <app-image-bubble-menu [editor]="editor"></app-image-bubble-menu>

  <!-- Table Bubble Menu -->
  <app-table-bubble-menu [editor]="editor"></app-table-bubble-menu>

  <!-- Properties Panel Backdrop (overlay semi-transparent) -->
  @if (propertiesPanelOpen() && isDatabaseRowDocument()) {
    <div
      class="properties-backdrop"
      (click)="togglePropertiesPanel()"
    ></div>
  }

  <!-- Properties Panel (overlay fixe à droite) -->
  @if (isDatabaseRowDocument()) {
    <div
      class="properties-panel"
      [class.open]="propertiesPanelOpen()"
    >
      <!-- Header du panel -->
      <div class="properties-panel-header">
        <h3 class="properties-panel-title">Propriétés de la tâche</h3>
        <button
          class="properties-panel-close"
          (click)="togglePropertiesPanel()"
          title="Fermer"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Content du panel -->
      <div class="properties-panel-content">
        @if (isLoadingDatabaseProperties()) {
          <div class="properties-loading">
            <span class="loading-spinner"></span>
            Chargement des propriétés...
          </div>
        } @else if (databaseMetadata() && databaseRow()) {
          <div class="properties-list">
            <!-- Task Number Property (First in list, readonly) -->
            @if (getTaskNumber()) {
              <div class="property-item property-item--readonly">
                <div class="property-label-container">
                  <mat-icon class="property-icon">tag</mat-icon>
                  <span class="property-label">ID</span>
                </div>
                <div class="property-value-display property-value--readonly">
                  {{ getTaskNumber() }}
                </div>
              </div>
            }

            @for (column of databaseMetadata()!.config.columns; track column.id) {
              @if (column.visible !== false && !isTitleColumn(column.name) && column.name !== 'Task Number') {
                <div class="property-item">
                  <div class="property-label-container">
                    <mat-icon class="property-icon">{{ getPropertyIcon(column.type) }}</mat-icon>
                    <span class="property-label">{{ column.name }}</span>
                    <button
                      class="pin-button"
                      (click)="toggleColumnPin(column.id)"
                      [class.pinned]="isColumnPinned(column.id)"
                      [title]="isColumnPinned(column.id) ? 'Désépingler' : 'Épingler'"
                    >
                      <mat-icon>{{ isColumnPinned(column.id) ? 'push_pin' : 'push_pin' }}</mat-icon>
                    </button>
                  </div>

                  <!-- Click-to-edit: Display value or edit input -->
                  @if (!isEditingProperty(column.id)) {
                    <button
                      class="property-value-display"
                      (click)="startEditingProperty(column.id, databaseRow()!.cells[column.id])"
                    >
                      {{ getPropertyDisplayValue(column, databaseRow()!.cells[column.id]) }}
                    </button>
                  } @else {
                    @if (column.type === 'select') {
                      <select
                        #propertyInput
                        class="property-input-edit"
                        [value]="tempPropertyValue() || ''"
                        (change)="tempPropertyValue.set($any($event.target).value); saveProperty(column.id)"
                        (blur)="saveProperty(column.id)"
                        (keydown.escape)="cancelPropertyEdit()"
                      >
                        <option value="">Sélectionner...</option>
                        @for (choice of column.options?.choices || []; track choice.id) {
                          <option [value]="choice.id">{{ choice.label }}</option>
                        }
                      </select>
                    } @else if (column.type === 'checkbox') {
                      <input
                        type="checkbox"
                        class="property-checkbox-edit"
                        [checked]="!!tempPropertyValue()"
                        (change)="tempPropertyValue.set($any($event.target).checked); saveProperty(column.id)"
                      />
                    } @else {
                      <input
                        #propertyInput
                        [type]="column.type === 'number' ? 'number' : column.type === 'date' ? 'date' : column.type === 'url' ? 'url' : column.type === 'email' ? 'email' : 'text'"
                        class="property-input-edit"
                        [value]="tempPropertyValue() || ''"
                        (input)="tempPropertyValue.set(column.type === 'number' ? toNumber($any($event.target).value) : $any($event.target).value)"
                        (blur)="saveProperty(column.id)"
                        (keydown.enter)="saveProperty(column.id)"
                        (keydown.escape)="cancelPropertyEdit()"
                      />
                    }
                  }
                </div>
              }
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- Accordion Settings Popover -->
  @if (showAccordionPopover()) {
    <app-accordion-settings-popover
      [currentIcon]="accordionCurrentIcon()"
      [currentIconColor]="accordionCurrentIconColor()"
      [currentTitleColor]="accordionCurrentTitleColor()"
      [positionTop]="accordionPopoverPosition().top"
      [positionLeft]="accordionPopoverPosition().left"
      (settingsChanged)="onAccordionSettingsChanged($event)"
      (closePopover)="closeAccordionPopover()"
    />
  }

  <!-- Comment Thread Panel -->
  <app-comment-thread-panel
    [isOpen]="commentPanelOpen()"
    [documentId]="documentState().id"
    [blockId]="selectedBlockId()"
    [currentUserId]="currentUserId()"
    (close)="closeCommentPanel()"
    (commentAdded)="onCommentAdded($event)"
    (commentUpdated)="onCommentUpdated($event)"
    (commentDeleted)="onCommentDeleted($event)"
  />
</div>
