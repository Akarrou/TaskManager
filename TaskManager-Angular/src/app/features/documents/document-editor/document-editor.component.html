<div class="document-container">
  <!-- Navigation Header -->
  <div class="document-header">
    <button class="back-button" (click)="navigateBack()" title="Retour">
      <span class="material-icons-outlined">arrow_back</span>
    </button>
    <div class="breadcrumb">
      <a routerLink="/documents" class="breadcrumb-item">Documents</a>
      <span class="breadcrumb-separator">/</span>

      <!-- Display parent hierarchy -->
      @for (crumb of breadcrumbs(); track crumb.id; let isLast = $last) {
        @if (!isLast) {
          <a [routerLink]="['/documents', crumb.id]" class="breadcrumb-item">{{ crumb.title }}</a>
          <span class="breadcrumb-separator">/</span>
        } @else {
          <span class="breadcrumb-current">{{ crumb.title }}</span>
        }
      }
    </div>
  </div>

  <!-- Title Header -->
  <div class="title-container">
    <input
      type="text"
      [ngModel]="documentState().title"
      (ngModelChange)="onTitleChange($event)"
      placeholder="Nouvelle page"
      class="title-input"
    />
  </div>

  <!-- Save Status Indicator -->
  <div class="save-status">
    <span *ngIf="documentState().isSaving">
      <span class="save-indicator"></span>
      Sauvegarde...
    </span>
    <span *ngIf="!documentState().isSaving && documentState().lastSaved">
      Dernière modification : {{ documentState().lastSaved | date:'HH:mm' }}
    </span>
    <span *ngIf="isDirty()" class="text-orange-500 text-xs ml-2">
      • Non sauvegardé
    </span>
  </div>

  <!-- Database Properties Section -->
  @if (isDatabaseRowDocument()) {
    <div class="database-properties-section">
      <div class="properties-header" (click)="togglePropertiesExpanded()">
        <h3 class="properties-title">Propriétés de la tâche</h3>
        <div class="properties-toggle" [class.expanded]="propertiesExpanded()">
          <span class="toggle-icon">▼</span>
        </div>
      </div>

      @if (propertiesExpanded()) {
        <div class="properties-content">
          @if (isLoadingDatabaseProperties()) {
            <div class="properties-loading">
              <span class="loading-spinner"></span>
              Chargement des propriétés...
            </div>
          } @else if (databaseMetadata() && databaseRow()) {
            <div class="properties-grid">
          @for (column of databaseMetadata()!.config.columns; track column.id) {
            @if (column.visible !== false && !isTitleColumn(column.name)) {
              <div class="property-row" [class.property-row-narrow]="isNarrowColumn(column.name)" [class.property-row-wide]="isDescriptionColumn(column.name)">
                <label class="property-label">{{ column.name }}</label>
                <div class="property-value">
                  @switch (column.type) {
                    @case ('text') {
                      @if (isDescriptionColumn(column.name)) {
                        <!-- Description column: use textarea -->
                        <textarea
                          [value]="databaseRow()!.cells[column.id] || ''"
                          (change)="onUpdateDatabaseProperty(column.id, $any($event.target).value)"
                          class="property-textarea"
                          rows="3"
                          placeholder="Saisir une description..."
                        ></textarea>
                      } @else {
                        <!-- Regular text input -->
                        <input
                          type="text"
                          [value]="databaseRow()!.cells[column.id] || ''"
                          (change)="onUpdateDatabaseProperty(column.id, $any($event.target).value)"
                          class="property-input"
                          placeholder="Saisir du texte..."
                        />
                      }
                    }
                    @case ('number') {
                      <input
                        type="number"
                        [value]="databaseRow()!.cells[column.id] || 0"
                        (change)="onUpdateDatabaseProperty(column.id, toNumber($any($event.target).value))"
                        class="property-input"
                        placeholder="0"
                      />
                    }
                    @case ('select') {
                      <select
                        [value]="databaseRow()!.cells[column.id] || ''"
                        (change)="onUpdateDatabaseProperty(column.id, $any($event.target).value)"
                        class="property-select"
                      >
                        <option value="">Sélectionner...</option>
                        @for (choice of column.options?.choices || []; track choice.id) {
                          <option [value]="choice.id">{{ choice.label }}</option>
                        }
                      </select>
                    }
                    @case ('date') {
                      <input
                        type="date"
                        [value]="databaseRow()!.cells[column.id] || ''"
                        (change)="onUpdateDatabaseProperty(column.id, $any($event.target).value)"
                        class="property-input"
                      />
                    }
                    @case ('checkbox') {
                      <input
                        type="checkbox"
                        [checked]="!!databaseRow()!.cells[column.id]"
                        (change)="onUpdateDatabaseProperty(column.id, $any($event.target).checked)"
                        class="property-checkbox"
                      />
                    }
                    @case ('url') {
                      <input
                        type="url"
                        [value]="databaseRow()!.cells[column.id] || ''"
                        (change)="onUpdateDatabaseProperty(column.id, $any($event.target).value)"
                        class="property-input"
                        placeholder="https://..."
                      />
                    }
                    @case ('email') {
                      <input
                        type="email"
                        [value]="databaseRow()!.cells[column.id] || ''"
                        (change)="onUpdateDatabaseProperty(column.id, $any($event.target).value)"
                        class="property-input"
                        placeholder="email@exemple.com"
                      />
                    }
                    @case ('multi-select') {
                      <div class="multi-select-container">
                        <span class="multi-select-placeholder">
                          {{ getCellAsArray(databaseRow()!.cells[column.id]).join(', ') || 'Aucune sélection' }}
                        </span>
                      </div>
                    }
                    @default {
                      <span class="property-text">{{ databaseRow()!.cells[column.id] }}</span>
                    }
                  }
                </div>
              </div>
            }
          }
        </div>
          }
        </div>
      }
    </div>
  }

  <!-- Editor Content -->
  <div
    class="editor-wrapper"
    (click)="focusEditor($event)"
    appTaskSectionRenderer
    appDatabaseTableRenderer
    [documentId]="documentState().id || ''"
    [editor]="editor">
    <tiptap-editor
      [editor]="editor"
      class="editor-content">
    </tiptap-editor>
  </div>

  <!-- Slash Menu -->
  <app-slash-menu
    *ngIf="showSlashMenu()"
    [items]="menuItems"
    [selectedIndex]="slashMenuIndex()"
    [filterText]="slashFilterText()"
    (commandSelected)="executeCommand($event)"
    [style.top.px]="slashMenuPosition().top"
    [style.left.px]="slashMenuPosition().left"
    class="slash-menu">
  </app-slash-menu>

  <!-- Bubble Menu (text selection) -->
  <app-bubble-menu
    *ngIf="showBubbleMenu() && !isDragging() && !bubbleMenuDisabled()"
    [editor]="editor"
    [style.top.px]="bubbleMenuPosition().top"
    [style.left.px]="bubbleMenuPosition().left"
    class="bubble-menu-wrapper">
  </app-bubble-menu>
</div>
