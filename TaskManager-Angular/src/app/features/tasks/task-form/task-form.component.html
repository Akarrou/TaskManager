<div class="task-form-container">
  <div class="form-header">
    <h2>{{ pageTitle() }}</h2>
  </div>

  <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="task-form">
    <!-- Task Number -->
    <div class="c-form__field" *ngIf="isEditMode()">
      <label for="task_number" class="c-form__label">Numéro de la Tâche</label>
      <input id="task_number" type="text" formControlName="task_number" class="c-form__input" readonly>
    </div>

    <!-- Titre -->
    <div class="form-group">
      <label for="title">Titre de la tâche *</label>
      <input 
        id="title"
        type="text" 
        formControlName="title"
        placeholder="ex: Plantation de tomates"
        [class.error]="taskForm.get('title')?.invalid && taskForm.get('title')?.touched">
      <div class="error-message" *ngIf="taskForm.get('title')?.invalid && taskForm.get('title')?.touched">
        Le titre est obligatoire
      </div>
    </div>

    <!-- Description -->
    <div class="form-group">
      <label for="description">Description</label>
      <textarea 
        id="description"
        formControlName="description"
        placeholder="Décrivez la tâche en détail..."
        rows="3"></textarea>
    </div>

    <!-- Statut et Priorité -->
    <div class="form-row">
      <div class="form-group">
        <label for="status">Statut *</label>
        <select id="status" formControlName="status">
          <option value="pending">En attente</option>
          <option value="in_progress">En cours</option>
          <option value="completed">Terminée</option>
          <option value="cancelled">Annulée</option>
        </select>
      </div>

      <div class="form-group">
        <label for="priority">Priorité *</label>
        <select id="priority" formControlName="priority">
          <option value="low">Faible</option>
          <option value="medium">Moyenne</option>
          <option value="high">Élevée</option>
          <option value="urgent">Urgente</option>
        </select>
      </div>
    </div>

    <!-- Assignation et Date -->
    <div class="form-row">
      <div class="form-group">
        <label for="assigned_to">Assigné à</label>
        <select id="assigned_to" formControlName="assigned_to">
          <option [ngValue]="null">Non assigné</option>
          @for (user of users(); track user.id) {
            <option [value]="user.id">{{ user.email }}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <label for="due_date">Date d'échéance</label>
        <input 
          id="due_date"
          type="date" 
          formControlName="due_date">
      </div>
    </div>

    <!-- Tags -->
    <div class="form-group">
      <label for="tags">Tags (séparés par des virgules)</label>
      <input 
        id="tags"
        type="text" 
        formControlName="tagsInput"
        placeholder="ex: urgent, serre, irrigation">
    </div>

    <!-- Sous-tâches -->
    <div class="form-group">
      <label>Sous-tâches</label>
      <div formArrayName="subtasks">
        <div *ngFor="let subtaskCtrl of subtasksFormArray.controls; let i = index" [formGroupName]="i" class="subtask-item">
          <div class="subtask-fields">
            <input type="text" formControlName="title" placeholder="Titre de la sous-tâche" [class.error]="subtaskCtrl.get('title')?.invalid && subtaskCtrl.get('title')?.touched">
            <input type="text" formControlName="description" placeholder="Description (optionnelle)">
            <select formControlName="status">
              <option value="pending">En attente</option>
              <option value="in_progress">En cours</option>
              <option value="completed">Terminée</option>
              <option value="cancelled">Annulée</option>
            </select>
            <button type="button" (click)="removeSubtask(i)" class="btn-secondary" aria-label="Supprimer la sous-tâche"><span class="material-icons">delete</span></button>
          </div>
          <div class="error-message" *ngIf="subtaskCtrl.get('title')?.invalid && subtaskCtrl.get('title')?.touched">
            Le titre de la sous-tâche est obligatoire
          </div>
        </div>
        <button type="button" (click)="addSubtask()" class="btn-primary mt-2" aria-label="Ajouter une sous-tâche"><span class="material-icons">add</span> Ajouter une sous-tâche</button>
      </div>
    </div>

    <!-- Boutons d'action -->
    <div class="form-actions" role="group" aria-label="Actions du formulaire">
      <button 
        type="button" 
        class="btn-secondary" 
        (click)="handleCancel()"
        aria-label="Annuler et fermer le formulaire">
        Annuler
      </button>
      <button 
        type="submit" 
        class="btn-primary"
        [disabled]="taskForm.invalid"
        [attr.aria-label]="currentTaskId() ? 'Sauvegarder les modifications de la tâche' : 'Créer une nouvelle tâche'">
        <span>
          {{ currentTaskId() ? 'Sauvegarder' : 'Créer' }}
        </span>
      </button>
    </div>
  </form>

  <!-- Section des Commentaires -->
  <div *ngIf="currentTaskId()" class="comments-section">
    <h4>Commentaires ({{ taskComments().length }})</h4>

    <div class="comments-list" *ngIf="taskComments().length > 0; else noComments">
      <div *ngFor="let comment of taskComments(); trackBy: commentTrackByFn" class="comment-item">
        <div class="comment-header">
          <span class="comment-author">
            Utilisateur: {{ comment.users?.email || 'Utilisateur inconnu' }}
          </span>
          <span class="comment-date">{{ comment.created_at | date:'dd/MM/yyyy à HH:mm' }}</span>
        </div>
        <p class="comment-body">{{ comment.comment }}</p>
      </div>
    </div>
    <ng-template #noComments>
      <p class="no-comments-message">Aucun commentaire pour cette tâche pour le moment.</p>
    </ng-template>

    <div class="add-comment-form">
      <h5>Ajouter un commentaire</h5>
      <div class="form-group">
        <label for="new-comment">Votre commentaire</label>
        <textarea 
          id="new-comment"
          rows="3"
          [value]="newCommentText()" 
          (input)="newCommentText.set($any($event.target).value)"
          placeholder="Écrivez votre commentaire ici..."></textarea>
      </div>
      <div class="form-actions">
        <button 
          type="button"
          class="btn-primary"
          (click)="submitComment()"
          [disabled]="!canSubmitComment()">
          <span class="material-icons-outlined">add_comment</span>
          <span>Ajouter le commentaire</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Tableau des sous-tâches (vue détail, style dashboard strict) -->
  <div class="subtasks-table-section" *ngIf="subtasksFormArray.length > 0">
   
    <div class="c-tasks-container">
      <h3 class="mt-8 mb-4 text-lg font-semibold">Liste des sous-tâches</h3>
      <div class="c-tasks-table-wrapper">
        <table class="c-table">
          <thead class="c-table__head">
            <tr class="c-table__row">
              <th class="c-table__header c-table-column--task" scope="col">Titre</th>
              <th class="c-table__header c-table-column--subtask-desc" scope="col">Description</th>
              <th class="c-table__header" scope="col">Statut</th>
            </tr>
          </thead>
          <tbody class="c-table__body">
            <tr class="c-table__row" *ngFor="let subtaskCtrl of subtasksFormArray.controls; let i = index" [formGroupName]="i">
              <td class="c-table__cell c-table-column--subtask-title">{{ subtaskCtrl.get('title')?.value }}</td>
              <td class="c-table__cell c-table-column--subtask-desc">{{ subtaskCtrl.get('description')?.value }}</td>
              <td class="c-table__cell">
                <span class="c-badge c-badge--status-{{ subtaskCtrl.get('status')?.value }}">
                  <mat-icon *ngIf="subtaskCtrl.get('status')?.value === 'pending'">hourglass_empty</mat-icon>
                  <mat-icon *ngIf="subtaskCtrl.get('status')?.value === 'in_progress'">sync</mat-icon>
                  <mat-icon *ngIf="subtaskCtrl.get('status')?.value === 'completed'">check_circle_outline</mat-icon>
                  <mat-icon *ngIf="subtaskCtrl.get('status')?.value === 'cancelled'">cancel</mat-icon>
                  <span>
                    {{ subtaskCtrl.get('status')?.value === 'pending' ? 'En attente' :
                       subtaskCtrl.get('status')?.value === 'in_progress' ? 'En cours' :
                       subtaskCtrl.get('status')?.value === 'completed' ? 'Terminée' :
                       subtaskCtrl.get('status')?.value === 'cancelled' ? 'Annulée' : '' }}
                  </span>
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div> 