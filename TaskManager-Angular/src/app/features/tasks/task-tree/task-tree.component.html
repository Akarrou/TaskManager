<div class="task-tree-container">
  <ng-container *ngIf="loading">
    <div class="loading">Chargement de l'arborescence...</div>
  </ng-container>
  <ng-container *ngIf="!loading && error">
    <div class="error-message">{{ error }}</div>
  </ng-container>
  <ng-container *ngIf="!loading && !error">
    <ng-container *ngIf="treeData.length > 0; else emptyTree">
      <div
        cdkDropList
        [id]="'dropList-root'"
        [cdkDropListData]="treeData"
        [cdkDropListConnectedTo]="getAllDropListIds()"
        (cdkDropListDropped)="drop($event, null)"
      >
        <div *ngFor="let node of treeData" cdkDrag [cdkDragData]="node">
          <div class="tree-node" (dblclick)="onNodeClick(node)">
            <div class="tree-node-content">
              <mat-icon class="type-icon">{{ getTypeIcon(node.type) }}</mat-icon>
              <span class="badge badge-{{ node.type }}">{{ node.type }}</span>
              <mat-icon class="status-icon status-{{ node.status }}">{{ getStatusIcon(node.status) }}</mat-icon>
              <span class="badge-status badge-status-{{ node.status }}">{{ getStatusLabel(node.status) }}</span>
              <span class="title">{{ node.title }}</span>
              <span class="slug">({{ node.slug }})</span>
              <span *ngIf="node.estimated_hours" class="estimation">~{{ node.estimated_hours }}h</span>
            </div>
            <div class="btn-actions">
              <button *ngIf="node.type === 'epic'" class="c-icon-button" (click)="onAddChild(node, 'feature'); $event.stopPropagation();">
                <mat-icon>add</mat-icon>
              </button>
              <button *ngIf="node.type === 'feature'" class="c-icon-button"  (click)="onAddChild(node, 'task'); $event.stopPropagation();">
                <mat-icon>add</mat-icon>
              </button>
              <button  class="c-icon-button"  (click)="onNodeClick(node); $event.stopPropagation();">
                <mat-icon>edit</mat-icon>
              </button>
              <button *ngIf="canDeleteNode(node)" class="c-icon-button"  (click)="onDeleteNode(node); $event.stopPropagation();">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <!-- Drop list enfant, toujours rendue, même si children est vide -->
          <div
            cdkDropList
            [id]="'dropList-' + node.id"
            [cdkDropListData]="node.children && node.children.length > 0 ? node.children : []"
            [cdkDropListConnectedTo]="getAllDropListIds()"
            (cdkDropListDropped)="drop($event, node)"
            class="children"
          >
            <ng-container *ngIf="node.children && node.children.length > 0; else emptyChildren">
              <div *ngFor="let child of node.children" cdkDrag [cdkDragData]="child">
                <div class="tree-node" (dblclick)="onNodeClick(child)">
                  <div class="tree-node-content">
                    <mat-icon class="type-icon">{{ getTypeIcon(child.type) }}</mat-icon>
                    <span class="badge badge-{{ child.type }}">{{ child.type }}</span>
                    <mat-icon class="status-icon status-{{ child.status }}">{{ getStatusIcon(child.status) }}</mat-icon>
                    <span class="badge-status badge-status-{{ child.status }}">{{ getStatusLabel(child.status) }}</span>
                    <span class="title">{{ child.title }}</span>
                    <span class="slug">({{ child.slug }})</span>
                    <span *ngIf="child.estimated_hours" class="estimation">~{{ child.estimated_hours }}h</span>
                  </div>
                  <div class="btn-actions">
                    <button *ngIf="child.type === 'epic'" class="c-icon-button" (click)="onAddChild(child, 'feature'); $event.stopPropagation();">
                      <mat-icon>add</mat-icon>
                    </button>
                    <button *ngIf="child.type === 'feature'" class="c-icon-button"  (click)="onAddChild(child, 'task'); $event.stopPropagation();">
                      <mat-icon>add</mat-icon>
                    </button>
                    <button  class="c-icon-button"  (click)="onNodeClick(child); $event.stopPropagation();">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button *ngIf="canDeleteNode(child)" class="c-icon-button"  (click)="onDeleteNode(child); $event.stopPropagation();">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
                <!-- Récursivité pour les enfants de la feature -->
                <div
                  cdkDropList
                  [id]="'dropList-' + child.id"
                  [cdkDropListData]="child.children && child.children.length > 0 ? child.children : []"
                  [cdkDropListConnectedTo]="getAllDropListIds()"
                  (cdkDropListDropped)="drop($event, child)"
                  class="children"
                >
                  <ng-container *ngIf="child.children && child.children.length > 0; else emptyGrandChildren">
                    <div *ngFor="let grandChild of child.children" cdkDrag [cdkDragData]="grandChild">
                      <div class="tree-node" (dblclick)="onNodeClick(grandChild)">
                        <div class="tree-node-content">
                          <mat-icon class="type-icon">{{ getTypeIcon(grandChild.type) }}</mat-icon>
                          <span class="badge badge-{{ grandChild.type }}">{{ grandChild.type }}</span>
                          <mat-icon class="status-icon status-{{ grandChild.status }}">{{ getStatusIcon(grandChild.status) }}</mat-icon>
                          <span class="badge-status badge-status-{{ grandChild.status }}">{{ getStatusLabel(grandChild.status) }}</span>
                          <span class="title">{{ grandChild.title }}</span>
                          <span class="slug">({{ grandChild.slug }})</span>
                          <span *ngIf="grandChild.estimated_hours" class="estimation">~{{ grandChild.estimated_hours }}h</span>
                        </div>
                        <div class="btn-actions">
                          <button *ngIf="grandChild.type === 'epic'" class="c-icon-button" (click)="onAddChild(grandChild, 'feature'); $event.stopPropagation();">
                            <mat-icon>add</mat-icon>
                          </button>
                          <button *ngIf="grandChild.type === 'feature'" class="c-icon-button"  (click)="onAddChild(grandChild, 'task'); $event.stopPropagation();">
                            <mat-icon>add</mat-icon>
                          </button>
                          <button  class="c-icon-button"  (click)="onNodeClick(grandChild); $event.stopPropagation();">
                            <mat-icon>edit</mat-icon>
                          </button>
                          <button *ngIf="canDeleteNode(grandChild)" class="c-icon-button"  (click)="onDeleteNode(grandChild); $event.stopPropagation();">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      </div>
                      <!-- ... récursivité supplémentaire si besoin ... -->
                    </div>
                  </ng-container>
                  <ng-template #emptyGrandChildren></ng-template>
                </div>
              </div>
            </ng-container>
            <ng-template #emptyChildren></ng-template>
          </div>
        </div>
      </div>
    </ng-container>
    <ng-template #emptyTree>
      <div class="empty-message">Aucune tâche à afficher.</div>
    </ng-template>
  </ng-container>
</div> 