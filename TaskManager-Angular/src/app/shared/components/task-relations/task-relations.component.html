<div class="task-relations">
  <!-- Header -->
  <div class="relations-header">
    <h4 class="relations-title">
      <mat-icon>link</mat-icon>
      Relations ({{ localRelations().length }})
    </h4>
    <button
      type="button"
      mat-stroked-button
      (click)="toggleAddRelation()"
      class="add-relation-btn">
      <mat-icon>{{ isAddingRelation() ? 'close' : 'add' }}</mat-icon>
      {{ isAddingRelation() ? 'Annuler' : 'Ajouter' }}
    </button>
  </div>

  <!-- Add relation form -->
  @if (isAddingRelation()) {
    <div class="add-relation-form">
      <div class="form-row">
        <mat-form-field appearance="outline" class="relation-type-field">
          <mat-label>Type de relation</mat-label>
          <mat-select
            [value]="selectedRelationType()"
            (selectionChange)="onRelationTypeChange($event.value)">
            @for (type of relationTypes; track type.value) {
              <mat-option [value]="type.value">
                <mat-icon>{{ type.icon }}</mat-icon>
                {{ type.label }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="task-search-field">
          <mat-label>Rechercher une tâche</mat-label>
          <input
            matInput
            type="text"
            [value]="searchQuery()"
            (input)="onSearchChange($any($event.target).value)"
            [matAutocomplete]="taskAuto"
            placeholder="Tapez pour rechercher..." />
          <mat-icon matSuffix>search</mat-icon>

          <mat-autocomplete #taskAuto="matAutocomplete" class="task-autocomplete">
            @for (task of filteredTasks(); track task.id) {
              <mat-option (click)="addRelation(task)">
                <div class="task-option">
                  <span class="task-option__number">
                    @if (task.task_number) { #{{ task.task_number }} }
                  </span>
                  <span class="task-option__title">{{ task.title }}</span>
                  <span class="task-option__status {{ getStatusClass(task.status) }}">
                    {{ getStatusLabel(task.status) }}
                  </span>
                </div>
              </mat-option>
            } @empty {
              <mat-option disabled>
                <span class="no-results">Aucune tâche trouvée</span>
              </mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>
      </div>
    </div>
  }

  <!-- Relations list grouped by type -->
  @if (groupedRelations().length > 0) {
    <div class="relations-groups">
      @for (group of groupedRelations(); track group.type.value) {
        <div class="relation-group">
          <div class="group-header">
            <mat-icon>{{ group.type.icon }}</mat-icon>
            <span class="group-label">{{ group.type.label }}</span>
            <span class="group-count">{{ group.relations.length }}</span>
          </div>

          <div class="group-items">
            @for (relation of group.relations; track trackByRelation($index, relation)) {
              <div class="relation-item">
                <div class="relation-item__info">
                  @if (relation.targetTask?.task_number) {
                    <span class="relation-item__number">#{{ relation.targetTask?.task_number }}</span>
                  }
                  <span class="relation-item__title">{{ relation.targetTask?.title || 'Tâche inconnue' }}</span>
                </div>

                @if (relation.targetTask) {
                  <span class="relation-item__status {{ getStatusClass(relation.targetTask.status) }}">
                    {{ getStatusLabel(relation.targetTask.status) }}
                  </span>
                }

                <button
                  type="button"
                  class="relation-item__remove"
                  (click)="removeRelation(relation)"
                  matTooltip="Supprimer la relation">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
          </div>
        </div>
      }
    </div>
  } @else if (!isAddingRelation()) {
    <div class="relations-empty">
      <mat-icon>link_off</mat-icon>
      <p>Aucune relation définie</p>
      <button type="button" mat-stroked-button (click)="toggleAddRelation()">
        <mat-icon>add</mat-icon>
        Ajouter une relation
      </button>
    </div>
  }
</div>
