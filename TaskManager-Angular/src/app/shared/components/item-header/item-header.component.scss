@use "sass:color";
@use "../../../styles/variables" as v;
@use "../../../styles/mixins" as m;

// ============================================================================
// EPIC HEADER - Component Styles
// Author: TaskManager AI
// Date: 2024-07-30
// Refactor: T019 - UI Color & Style Harmonization (Header)
// ============================================================================

// ============================================================================
// Expansion Panel Root
// ============================================================================
:host ::ng-deep .epic-header-panel {
  margin-bottom: v.$space-6;
  border-radius: v.$border-radius-xl;
  box-shadow: v.$shadow-md;
  border: 1px solid v.$border-color-light;
  background-color: v.$background-color-light;
  overflow: hidden;

  .mat-expansion-panel-header {
    padding: v.$space-4 v.$space-6;
    background: linear-gradient(
      135deg,
      v.$background-color-light 0%,
      v.$background-color-page 100%
    );

    &:hover {
      background: linear-gradient(
        135deg,
        v.$background-color-page 0%,
        color.adjust(v.$background-color-page, $lightness: -3%) 100%
      );
    }

    .mat-expansion-panel-header-title {
      align-items: center;
      gap: v.$space-3;
      font-weight: v.$font-weight-semibold;
      color: v.$text-color-dark;

      mat-icon {
        color: v.$primary-color;
        font-size: v.$font-size-xl;
      }

      .epic-number {
        background-color: v.$background-color-page;
        color: v.$primary-color;
        padding: v.$space-1 v.$space-2;
        border-radius: v.$border-radius-md;
        font-size: v.$font-size-xs;
        font-weight: v.$font-weight-bold;
        border: 1px solid v.$border-color-light;
      }

      .epic-title {
        font-weight: v.$font-weight-semibold;
        color: v.$text-color-darkest;
        font-size: v.$font-size-md;
        max-width: 600px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .epic-status-chip {
        margin-left: auto;
        font-size: 11px;
        font-weight: 500;
        padding: 4px 8px;
        border-radius: 6px;

        &.status-completed {
          background-color: #dcfce7;
          color: #166534;
        }

        &.status-in_progress {
          background-color: #fef3c7;
          color: #d97706;
        }

        &.status-pending {
          background-color: #f3f4f6;
          color: #6b7280;
        }

        &.status-cancelled {
          background-color: #fecaca;
          color: #dc2626;
        }

        &.status-unknown {
          background-color: #e5e7eb;
          color: #6b7280;
        }
      }
    }

    .mat-expansion-panel-header-description {
      color: #6b7280;
      font-size: 13px;
      margin-right: 16px;
    }
  }

  .mat-expansion-panel-content .mat-expansion-panel-body {
    padding: 0 !important; // Override default padding
  }

  &.mat-expanded .mat-expansion-panel-header {
    border-bottom: 1px solid v.$border-color-light;
    border-radius: v.$border-radius-xl v.$border-radius-xl 0 0;
  }

  &:not(.mat-expanded) .mat-expansion-panel-header {
    border-radius: v.$border-radius-xl;
  }
}

// ============================================================================
// Main Header Content inside Panel
// ============================================================================
.epic-header {
  padding: 16px;
  background-color: #f9f9f9;
}

// Header Actions (Back, Refresh, More...)
// ============================================================================
.header-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: v.$space-4;

  .left-actions,
  .right-actions {
    display: flex;
    align-items: center;
    gap: v.$space-2;
  }

  .action-button {
    @include m.button-icon-reset;
    color: v.$text-color-medium;

    &:hover {
      background-color: v.$background-color-hover;
      color: v.$primary-color;
    }
  }

  .delete-action {
    color: v.$danger-color;

    mat-icon {
      color: v.$danger-color;
    }

    &:hover {
      color: color.adjust(v.$danger-color, $lightness: -10%);
      mat-icon {
        color: color.adjust(v.$danger-color, $lightness: -10%);
      }
    }
  }
}

// ============================================================================
// Epic Info Card
// ============================================================================
.epic-info-card {
  box-shadow: none;
  border-radius: 0;
  background-color: transparent;

  .epic-description {
    color: v.$text-color-medium;
    font-size: v.$font-size-sm;
    margin-top: v.$space-2;
    max-width: 80ch;
  }

  // Title editing form
  .title-edit-field {
    width: 100%;
  }
}

// ============================================================================
// Progress Section
// ============================================================================
.progress-section {
  background-color: v.$background-color-form;
  padding: v.$space-4;
  border-radius: v.$border-radius-lg;
  border: 1px solid v.$border-color-light;
  margin-top: v.$space-4;

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: v.$space-3;
  }

  .progress-info {
    .progress-label {
      font-size: v.$font-size-sm;
      color: v.$text-color-medium;
      font-weight: v.$font-weight-medium;
    }
    .progress-value {
      font-size: v.$font-size-lg;
      font-weight: v.$font-weight-bold;
      margin-left: v.$space-2;

      // Colors are applied via class binding in TS
    }
  }

  .progress-actions .action-btn {
    @include m.button-icon-reset;
  }

  .progress-bar {
    border-radius: v.$border-radius-full;
    height: 8px;
    margin-bottom: v.$space-3;
  }

  .metrics-details {
    display: flex;
    justify-content: space-around;
    gap: v.$space-4;
    text-align: center;

    .metric-item {
      .count {
        display: block;
        font-size: v.$font-size-xl;
        font-weight: v.$font-weight-bold;
      }
      .label {
        font-size: v.$font-size-xs;
        color: v.$text-color-medium;
        text-transform: uppercase;
      }

      &.completed .count {
        color: v.$success-color;
      }
      &.in-progress .count {
        color: v.$warning-color;
      }
      &.pending .count {
        color: v.$text-color-light;
      }
      &.total .count {
        color: v.$text-color-dark;
      }
    }
  }
}

// ============================================================================
// Meta Info & Tags Section
// ============================================================================
.epic-meta,
.tags-section {
  margin-top: v.$space-5;
  padding-top: v.$space-4;
  border-top: 1px solid v.$border-color-light;
}

.epic-meta {
  display: flex;
  flex-wrap: wrap;
  gap: v.$space-5;
  color: v.$text-color-medium;

  .meta-item {
    display: flex;
    align-items: center;
    gap: v.$space-2;
    font-size: v.$font-size-sm;

    mat-icon {
      font-size: v.$font-size-lg;
      color: v.$text-color-light;
    }

    &.is-overdue {
      color: v.$danger-color;
      font-weight: v.$font-weight-semibold;
      mat-icon {
        color: v.$danger-color;
      }
    }
  }
}

.tags-section {
  .tags-header {
    display: flex;
    align-items: center;
    gap: v.$space-2;
    margin-bottom: v.$space-3;
    color: v.$text-color-dark;
    font-weight: v.$font-weight-medium;

    mat-icon {
      color: v.$text-color-light;
    }
  }
  .tags-list {
    .tag-chip {
      background-color: v.$background-color-page;
      color: v.$text-color-dark;
      border: 1px solid v.$border-color-light;
    }
  }
}

// ============================================================================
// RESPONSIVE DESIGN
// ============================================================================
@media (max-width: 768px) {
  .epic-header {
    .header-actions {
      gap: 8px;

      .right-actions {
        gap: 4px;
      }
    }

    .epic-info-card {
      .epic-header-content {
        .epic-number-badge {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }

        .epic-title-section {
          .title-row {
            flex-direction: row;
            align-items: flex-start;
            gap: 8px;

            .epic-title {
              font-size: 20px;
            }

            .status-badge {
              align-self: flex-end;
            }
          }
        }
      }

      mat-card-content {
        .progress-section {
          .progress-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
          }

          .progress-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
          }
        }

        .meta-info {
          grid-template-columns: repeat(1, 1fr);
        }
      }
    }
  }
}

// ============================================================================
// ANIMATIONS ET TRANSITIONS
// ============================================================================
@keyframes pulse-soft {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

@keyframes scale-in {
  0% {
    transform: scale(0.95);
    opacity: 0;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

// Animations pour les statuts en cours
.status-icon.text-orange-500 {
  animation: pulse-soft 2s infinite;
}

// Animation d'apparition pour la carte
.epic-info-card {
  animation: scale-in 0.3s ease-out;
}

// Hover effects pour les éléments interactifs
.epic-title.editable:hover,
.meta-item:hover,
.tag-chip:hover,
.breakdown-item:hover {
  transform: translateY(-1px);
}

// ============================================================================
// DARK MODE SUPPORT (préparation)
// ============================================================================
@media (prefers-color-scheme: dark) {
  .epic-header {
    .epic-info-card {
      background-color: #1f2937;
      border-color: #374151;

      .epic-header-content {
        .epic-title-section {
          .title-row {
            .epic-title {
              color: #f9fafb;

              &.editable:hover {
                color: #60a5fa;
                background-color: #1e3a8a;
              }
            }
          }

          .epic-description {
            background-color: #374151;
            color: #d1d5db;
          }
        }
      }

      mat-card-content {
        .meta-info {
          .meta-item {
            background-color: #374151;
            color: #d1d5db;

            &:hover {
              background-color: #4b5563;
            }
          }
        }

        .time-tracking-section {
          background-color: #1e3a8a;
          color: #dbeafe;
        }

        .tags-section {
          .tag-chip {
            background-color: #1e3a8a;
            color: #bfdbfe;
            border-color: #1e40af;

            &:hover {
              background-color: #1e40af;
            }
          }
        }
      }
    }
  }
}

// ============================================================================
// CUSTOM PROPERTIES POUR THEMING
// ============================================================================
.epic-header {
  --epic-primary-color: #2563eb;
  --epic-bg-color: #ffffff;
  --epic-text-color: #1f2937;
  --epic-border-color: #e5e7eb;
}

// Epic number colors par type
.epic-number-chip {
  // Epic (rouge)
  &.text-red-700.bg-red-100 {
    box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1);
  }
}

.panel-title-header {
  display: flex;
  align-items: center;
  gap: v.$space-2;
  justify-content: space-between;
}

.panel-title-header-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

.title-and-desc {
  display: flex;
  flex-direction: column;

  .epic-title {
    font-weight: 500;
  }

  .epic-description {
    font-size: 0.85rem;
    color: #666;
    margin: 0;
    font-weight: 400;
  }
}
