<div class="popup-overlay" (click)="onOverlayClick()" (keydown.enter)="onOverlayClick()" tabindex="0">
  <div class="popup-content" (click)="$event.stopPropagation()" (keydown.enter)="$event.stopPropagation()" tabindex="0">
    <!-- Fixed Header -->
    <div class="popup-header fixed-header">
      <div class="header-content">
        <div class="header-badges">
          <mat-chip class="type-chip"
            [ngClass]="[typeConfig.bgColor, typeConfig.color, typeConfig.borderColor]">
            {{ typeConfig.label }}
          </mat-chip>
          <span class="item-number"
            [ngClass]="[itemNumberConfig.color, itemNumberConfig.bgColor]">
            #{{ itemNumberConfig.icon }}{{ item.task_number }}
          </span>
          <div class="status-badge" [ngClass]="statusConfig.color">
            <mat-icon>{{ statusConfig.icon }}</mat-icon>
            <span>{{ statusConfig.label }}</span>
          </div>
          <div class="priority-badge" [ngClass]="priorityConfig.color">
            <mat-icon>{{ priorityConfig.icon }}</mat-icon>
            <span>{{ priorityConfig.label }}</span>
          </div>
        </div>
        <h2 class="popup-title">{{ item.title }}</h2>
      </div>
      <button mat-icon-button (click)="onClose()" class="close-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Scrollable Content -->
    <div class="popup-body">

      <!-- Description -->
      <div class="description-section" *ngIf="item.description">
        <h3>Description</h3>
        <p class="description-text">{{ item.description }}</p>
      </div>

      <!-- Metadata Grid -->
      <div class="metadata-grid">
        <div class="metadata-item" *ngIf="item.assignee">
          <span class="label">Assigné à</span>
          <div class="assignee-info">
            <div class="avatar-placeholder">
              {{ item.assignee.charAt(0).toUpperCase() }}
            </div>
            <span>{{ item.assignee }}</span>
          </div>
        </div>

        <div class="metadata-item" *ngIf="item.dueDate">
          <span class="label">Échéance</span>
          <div class="date-info" [class.is-overdue]="isOverdue">
            <mat-icon>event</mat-icon>
            <span>{{ formatDate(item.dueDate) }}</span>
          </div>
        </div>

        <div class="metadata-item" *ngIf="item.environment">
          <span class="label">Environnement</span>
          <div class="environment-info">
            <mat-icon>settings</mat-icon>
            <span>{{ item.environment }}</span>
          </div>
        </div>
      </div>

      <!-- Tags -->
      <div class="tags-section" *ngIf="item.tags && item.tags.length > 0">
        <h3>Tags</h3>
        <div class="tags-container">
          <mat-chip class="tag-chip" *ngFor="let tag of item.tags">
            {{ tag }}
          </mat-chip>
        </div>
      </div>

      <!-- Progress -->
      <div class="progress-section" *ngIf="showProgress">
        <h3>Progression</h3>
        <div class="progress-info">
          <div class="progress-stats">
            <span class="progress-text">{{ itemProgress.completed }}/{{ itemProgress.total }} terminées</span>
            <span class="progress-percentage">{{ itemProgress.percentage }}%</span>
          </div>
          <mat-progress-bar 
            mode="determinate" 
            [value]="itemProgress.percentage"
            class="progress-bar">
          </mat-progress-bar>
        </div>
      </div>

      <!-- Metrics -->
      <div class="metrics-section">
        <h3>Métriques</h3>
        <div class="metrics-grid">
          <div class="metric-card">
            <mat-icon>checklist</mat-icon>
            <div class="metric-info">
              <span class="metric-value">{{ itemProgress.total }}</span>
              <span class="metric-label">Sous-tâches</span>
            </div>
          </div>
          <div class="metric-card" *ngIf="item.commentCount && item.commentCount > 0">
            <mat-icon>comment</mat-icon>
            <div class="metric-info">
              <span class="metric-value">{{ item.commentCount }}</span>
              <span class="metric-label">Commentaires</span>
            </div>
          </div>
          <div class="metric-card" *ngIf="item.attachmentCount && item.attachmentCount > 0">
            <mat-icon>attachment</mat-icon>
            <div class="metric-info">
              <span class="metric-value">{{ item.attachmentCount }}</span>
              <span class="metric-label">Pièces jointes</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fixed Footer -->
    <div class="popup-footer fixed-footer">
      <div class="actions-section">
        <button mat-raised-button color="primary" (click)="onEdit()">
          <mat-icon>edit</mat-icon>
          Modifier
        </button>
        <button mat-raised-button (click)="onAddTask()" *ngIf="item.type !== 'task'">
          <mat-icon>add_task</mat-icon>
          Ajouter une tâche
        </button>
        <button mat-raised-button 
          color="primary" 
          *ngIf="item.type === 'feature'"
          (click)="onNavigateToKanban()">
          <mat-icon>view_kanban</mat-icon>
          Voir le Kanban
        </button>
      </div>
    </div>
  </div>
</div>