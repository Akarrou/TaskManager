<mat-card class="feature-card"
  [class.is-expanded]="isExpanded"
  [class.is-dragging]="isDragging"
  [class.priority-low]="item.priority === 'low'"
  [class.priority-medium]="item.priority === 'medium'"
  [class.priority-high]="item.priority === 'high'"
  [class.priority-urgent]="item.priority === 'urgent'"
  [class.overdue]="isOverdue"
  [class.has-active-tasks]="hasActiveTasks"
  (click)="onCardClick()"
  [attr.aria-label]="'Card for ' + item.title"
  role="button"
  tabindex="0">

  <mat-card-header class="feature-header">
    <div mat-card-avatar
      class="header-avatar">
      <mat-icon [matTooltip]="'Priorité: ' + priorityConfig.label"
        [ngClass]="priorityConfig.color">{{ priorityConfig.icon }}</mat-icon>
    </div>
    <mat-card-title class="feature-title-container">
      <span class="feature-title"
        [matTooltip]="item.title">{{ item.title }}</span>
    </mat-card-title>
    <div class="feature-actions">
      <button mat-icon-button
        *ngIf="item.type === 'feature'"
        (click)="onNavigateToTasksKanban($event)"
        matTooltip="Voir le Kanban des tâches">
        <mat-icon>view_kanban</mat-icon>
      </button>
      <button mat-icon-button
        (click)="onEditClick($event)"
        matTooltip="Modifier l'élément">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button
        (click)="onAddTaskClick($event)"
        matTooltip="Ajouter une tâche">
        <mat-icon>add_task</mat-icon>
      </button>
      <button mat-icon-button
        (click)="onDeleteClick($event)"
        matTooltip="Supprimer l'élément">
        <mat-icon>delete</mat-icon>
      </button>
      <button mat-icon-button
        (click)="onToggleExpansion($event)"
        matTooltip="{{ isExpanded ? 'Réduire' : 'Étendre' }} les tâches">
        <mat-icon>{{ isExpanded ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</mat-icon>
      </button>
    </div>
  </mat-card-header>

  <mat-card-content>

    <h4 class="feature-card__title line-clamp-2"
      [matTooltip]="item.title.length > 60 ? item.title : null">
      {{ item.title }}
    </h4>

    <p *ngIf="item.description"
      class="feature-card__description line-clamp-2"
      [matTooltip]="item.description.length > 100 ? item.description : null">
      {{ item.description }}
    </p>

    <div class="feature-card__metadata">

      <div class="flex items-center gap-3">
        <div class="meta-item"
          [style.color]="statusConfig.color"
          [matTooltip]="statusConfig.label">
          <mat-icon>{{ statusConfig.icon }}</mat-icon>
          <span class="sr-only">{{ statusConfig.label }}</span>
        </div>

        <div class="meta-item"
          [style.color]="priorityConfig.color"
          [matTooltip]="'Priorité: ' + priorityConfig.label">
          <mat-icon>{{ priorityConfig.icon }}</mat-icon>
          <span class="sr-only">Priorité {{ priorityConfig.label }}</span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <span *ngIf="item.assignee"
          class="meta-item max-w-20 truncate"
          [matTooltip]="'Assigné à: ' + item.assignee">
          <mat-icon>person</mat-icon>
          <span class="truncate">{{ formatAssignee(item.assignee) }}</span>
        </span>

        <span *ngIf="item.dueDate"
          class="meta-item"
          [class.meta-item--overdue]="isOverdue"
          [matTooltip]="'Échéance: ' + formatDate(item.dueDate)">
          <mat-icon>event</mat-icon>
          <span>{{ formatDate(item.dueDate) }}</span>
        </span>
      </div>
    </div>

    <div *ngIf="showProgress && tasks.length > 0"
      class="progress-section">
      <div class="progress-header">
        <span class="progress-label">Progression</span>
        <div class="progress-actions">
          <span class="progress-count"
            [matTooltip]="completionRate">
            {{ itemProgress.completed }}/{{ itemProgress.total }}
            ({{ itemProgress.percentage }}%)
          </span>
          <button mat-icon-button
            class="expand-button"
            (click)="onToggleExpansion($event)"
            [matTooltip]="isExpanded ? 'Réduire les tâches' : 'Voir les tâches (' + tasks.length + ')'"
            [attr.aria-label]="isExpanded ? 'Réduire les tâches' : 'Développer les tâches'"
            [attr.aria-expanded]="isExpanded">
            <mat-icon class="expand-icon"
              [class.expanded]="isExpanded">
              {{ isExpanded ? 'expand_less' : 'expand_more' }}
            </mat-icon>
          </button>
        </div>
      </div>
      <mat-progress-bar mode="determinate"
        [value]="itemProgress.percentage"
        class="progress-bar"
        [class.progress-completed]="itemProgress.percentage === 100"
        [class.progress-active]="hasActiveTasks"
        [attr.aria-label]="'Progression: ' + itemProgress.percentage + '%'">
      </mat-progress-bar>
    </div>

    <div *ngIf="item.tags && item.tags.length > 0"
      class="feature-card__tags">
      <mat-chip *ngFor="let tag of item.tags.slice(0, 3); trackBy: trackTag"
        class="tag-chip"
        [matTooltip]="tag">
        {{ tag }}
      </mat-chip>
      <span *ngIf="item.tags.length > 3"
        class="more-tags-indicator"
        [matTooltip]="'Tags supplémentaires: ' + item.tags.slice(3).join(', ')">
        +{{ item.tags.length - 3 }}
      </span>
    </div>

  </mat-card-content>

  <div class="feature-card__tasks"
    [@expandCollapse]="isExpanded ? 'expanded' : 'collapsed'">
    <div class="feature-card__tasks-header">
      <h4 class="feature-card__tasks-title">
        <mat-icon>assignment</mat-icon>
        Tâches associées ({{ tasks.length }})
      </h4>
      <p class="feature-card__tasks-subtitle">Cliquez sur une tâche pour voir les détails</p>
    </div>

    <div class="feature-card__tasks-list"
      *ngIf="tasks.length > 0; else noTasks">
      <app-task-badge *ngFor="let task of tasks; trackBy: trackTask"
        [task]="task"
        [showQuickActions]="true"
        [enableNavigation]="true"
        (taskClick)="onTaskClick($event)"
        (statusChange)="onStatusChange(task, $event)"
        (priorityChange)="onPriorityChange(task, $event)"
        (taskEdit)="onTaskEdit($event)"
        (taskDelete)="onTaskDelete($event)"
        class="feature-card__task-item"
        [ngClass]="{'highlighted-task': highlightedTaskIds.includes(task.id || '')}">
      </app-task-badge>
    </div>

    <ng-template #noTasks>
      <div class="feature-card__no-tasks">
        <mat-icon class="feature-card__no-tasks-icon">inbox</mat-icon>
        <p class="feature-card__no-tasks-text">Aucune tâche associée à cet élément</p>
      </div>
    </ng-template>
  </div>

</mat-card>
