<mat-card class="kanban-card"
  [class.is-dragging]="isDragging"
  [class.is-expanded]="isExpanded"
  [class.is-overdue]="isOverdue"
  (click)="onCardClick()"
  (dblclick)="onCardDoubleClick()"
  role="button"
  tabindex="0">
  <!-- Priority Indicator -->
  <div class="priority-indicator"
    [attr.data-priority]="item.priority"></div>

  <div class="card-content">
    <!-- Header: Type and Menu -->
    <div class="card-header">
      <div class="header-left">
        <mat-chip-listbox aria-label="Item type">
          <mat-chip class="type-chip"
            [ngClass]="[typeConfig.bgColor, typeConfig.color, typeConfig.borderColor]"
            selected>
            {{ typeConfig.label }}
          </mat-chip>
        </mat-chip-listbox>
        @if (item.task_number) {
        <span class="item-number"
          [ngClass]="[itemNumberConfig.color, itemNumberConfig.bgColor]"
          [matTooltip]="itemNumberConfig.label">
          #{{ itemNumberConfig.icon }}{{ item.task_number }}
        </span>
        }
      </div>

      <button mat-icon-button
        class="menu-button"
        [matMenuTriggerFor]="cardMenu"
        (click)="$event.stopPropagation()">
        <mat-icon>more_horiz</mat-icon>
      </button>
    </div>

    <!-- Title -->
    <div class="card-header-content">
      <div class="card-title-row">
        <h3 class="kanban-card-title"
          [matTooltip]="item.title">{{ item.title }}</h3>
      </div>
    </div>

    <!-- Tags -->
    <div *ngIf="item.tags && item.tags.length > 0"
      class="tags-container">
      <mat-chip-listbox aria-label="Tags">
        <mat-chip class="tag-chip"
          *ngFor="let tag of item.tags.slice(0, 3)">
          {{ tag }}
        </mat-chip>
        <mat-chip *ngIf="item.tags.length > 3"
          class="tag-chip more-tags">
          +{{ item.tags.length - 3 }}
        </mat-chip>
      </mat-chip-listbox>
    </div>

    <!-- Kanban Button for Features -->
    <div *ngIf="item.type === 'feature'" class="kanban-action">
      <button mat-raised-button 
        color="primary"
        class="kanban-button"
        (click)="onNavigateToTasksKanban($event)"
        matTooltip="Voir le Kanban des tâches">
        <mat-icon>view_kanban</mat-icon>
        <span>Voir le Kanban</span>
      </button>
    </div>

    <!-- Footer: Metrics and Assignee -->
    <div class="card-footer">
      <div class="metrics">
        <span class="metric-item"
          matTooltip="Sous-tâches">
          <mat-icon>checklist</mat-icon>
          <span>{{ itemProgress.completed }}/{{ itemProgress.total }}</span>
        </span>
        <span *ngIf="item.commentCount && item.commentCount > 0"
          class="metric-item"
          matTooltip="Commentaires">
          <mat-icon>comment</mat-icon>
          <span>{{ item.commentCount }}</span>
        </span>
        <span *ngIf="item.attachmentCount && item.attachmentCount > 0"
          class="metric-item"
          matTooltip="Pièces jointes">
          <mat-icon>attachment</mat-icon>
          <span>{{ item.attachmentCount }}</span>
        </span>
        <span *ngIf="item.dueDate"
          class="metric-item date"
          [class.is-overdue]="isOverdue"
          [matTooltip]="'Échéance: ' + formatDate(item.dueDate)">
          <mat-icon>event</mat-icon>
          <span>{{ formatDate(item.dueDate) }}</span>
        </span>
      </div>
      <div class="assignee"
        matTooltip="Assigné à: {{ item.assignee }}">
        <!-- Placeholder for avatar -->
        <div class="avatar-placeholder">
          {{ item.assignee ? item.assignee.charAt(0).toUpperCase() : '?' }}
        </div>
      </div>
    </div>
  </div>
</mat-card>

<!-- Menu Definition -->
<mat-menu #cardMenu="matMenu"
  class="kanban-card-menu">
  <button mat-menu-item
    (click)="onEditClick($event)">
    <mat-icon>edit</mat-icon>
    <span>Modifier</span>
  </button>
  <button mat-menu-item
    (click)="onAddTaskClick($event)">
    <mat-icon>add_task</mat-icon>
    <span>Ajouter une tâche</span>
  </button>
  <mat-divider></mat-divider>
  <button mat-menu-item
    color="warn"
    (click)="onDeleteClick($event)">
    <mat-icon color="warn">delete</mat-icon>
    <span>Supprimer</span>
  </button>
</mat-menu>

<!-- Detail Popup -->
<app-item-detail-popup
  *ngIf="showDetailPopup"
  [item]="item"
  [tasks]="tasks"
  [showProgress]="showProgress"
  (close)="onCloseDetailPopup()"
  (edit)="onEditFromPopup($event)"
  (addTask)="onAddTaskFromPopup($event)">
</app-item-detail-popup>
