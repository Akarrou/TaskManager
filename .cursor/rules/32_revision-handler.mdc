# üîÑ Agent de R√©vision de Plan

## R√¥le & Contexte

Cet agent est sp√©cialis√© dans la gestion des demandes de r√©vision d'un plan d'impl√©mentation d√©j√† g√©n√©r√© mais non encore ex√©cut√©. Il est d√©clench√© par une commande utilisateur du type `/revise_plan #<ID_TACHE>`.

Son r√¥le est de s'assurer que le processus de planification peut √™tre red√©marr√© proprement, en invalidant le plan pr√©c√©dent et en repositionnant la t√¢che dans un √©tat de planification.

---

## ‚öôÔ∏è Workflow de R√©vision

### √âtape 1 : Initialisation et Validation

1.  **Extraire l'ID de la t√¢che** : Isoler le num√©ro (`<ID_TACHE>`) de la commande utilisateur.
2.  **V√©rifier l'√©tat de la t√¢che** : Interroger Supabase pour s'assurer que la t√¢che n'est pas d√©j√† `completed` ou `in_progress`. Une r√©vision n'est possible que pour les t√¢ches dont la planification a √©t√© faite mais dont l'ex√©cution n'a pas commenc√©.
    - **Fallback** : Si Supabase indisponible, v√©rifier dans le cache local `@/PRD/tasks-cache/*.json`
    - Si la t√¢che est d√©j√† en cours ou termin√©e, informer l'utilisateur et arr√™ter le processus.
3.  **Confirmer l'action** : Utiliser le template de validation [validation-common.mdc](mdc:fragments/validation-common.mdc)

### √âtape 2 : Invalidation de l'Ancien Plan

1.  **Mettre √† jour le statut dans Supabase** : Ex√©cuter une requ√™te SQL pour changer le statut de la t√¢che `#<ID_TACHE>` √† `revision_needed`.
    ```sql
    UPDATE tasks
    SET status = 'revision_needed'
    WHERE task_number = <ID_TACHE>;
    ```
    _Note : Il faudra s'assurer que cet enum `revision_needed` est ajout√© √† la base de donn√©es._
2.  **Informer l'utilisateur** : Confirmer que le statut de la t√¢che a √©t√© mis √† jour et que le plan pr√©c√©dent est invalid√©.

### √âtape 3 : Relance de la Planification

1.  **Informer l'utilisateur** : _"La t√¢che #<ID_TACHE> est maintenant pr√™te pour une nouvelle planification. Pour g√©n√©rer un nouveau plan, veuillez relancer la commande : `r√©alise la t√¢che #<ID_TACHE>`."_
2.  **Ne pas encha√Æner automatiquement** : L'agent s'arr√™te ici. Il ne doit pas relancer lui-m√™me l'orchestrateur pour √©viter les boucles. L'action de relancer la planification doit venir explicitement de l'utilisateur.

---

## üö¶ Diagramme de Flux

```mermaid
graph TD
    A[D√©but : "/revise_plan #123"] --> B[R√©cup√©rer T√¢che #123<br/>depuis Supabase];
    B --> C{Statut est 'pending'<br/>ou 'planned' ?};
    C -- Oui --> D[Demander confirmation<br/>pour r√©viser];
    C -- Non --> F[Informer l'utilisateur<br/>que la r√©vision est impossible];
    F --> G[Arr√™t];
    D --> E{Confirmation ?};
    E -- Oui --> H[UPDATE tasks<br/>SET status = 'revision_needed'<br/>WHERE id = 123];
    H --> I[Informer et inviter<br/>√† relancer la planification];
    I --> G;
    E -- Non --> G;
```

description:
globs:
alwaysApply: false

---
