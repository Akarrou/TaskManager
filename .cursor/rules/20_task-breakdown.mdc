---
description: 
globs: 
alwaysApply: false
---
# 20_task-breakdown.mdc (version enrichie & alignÃ©e TaskMaster)

## ğŸ¯ RÃ´le & Contexte

Cette rÃ¨gle dÃ©finit la mÃ©thode officielle pour transformer un PRD (Product Requirements Document) en tickets de travail structurÃ©s (epics, features, tasks, sub-tasks) dans AgroFlow, en garantissantâ€¯:
- la traÃ§abilitÃ© contractuelle,
- la cohÃ©rence des slugs,
- lâ€™enregistrement systÃ©matique dans Supabase via le MCP,
- la conformitÃ© avec le protocole TaskMaster.
- **Lâ€™IA doit analyser et exploiter activement la structure rÃ©elle du projet (architecture, modules, patterns) et le contenu des guidelines pour adapter le dÃ©coupage, la formulation et la granularitÃ© des tÃ¢ches, et non se contenter de rÃ©fÃ©rencer les guidelines.**

---

## 1. ğŸ—‚ï¸ Mapping PRD â†’ Tickets

| Section PRD                   | Niveau ticket | Champs obligatoires                                         | Notes                            |
| ----------------------------- | ------------- | ----------------------------------------------------------- | -------------------------------- |
| **User Story**                | Epic          | `title`, `slug`, `type = 'epic'`, `tags += ['user-story']`  | Slug hÃ©rite du PRD (kebabâ€‘case). |
| **Description fonctionnelle** | Feature       | `title`, `slug`, `type = 'feature'`, `parent_task_id`, `environment` | Un Feature â†” module fonctionnel. |
| **CritÃ¨re dâ€™acceptation**     | Subâ€‘task      | `title`, `slug`, `task_id`, `environment`, `estimated_hours` | 1 scÃ©nario Gherkin = 1 subâ€‘task. |
| **Contrainte ou risque**      | Task          | `title`, `slug`, `type = 'task'`, `parent_task_id`, `priority = high`, `tags += ['risk']` | Si risqueÂ : tag `risk`.          |

- **DÃ©coupage par environnement**â€¯:  
  Si une demande concerne plusieurs environnements (frontend, backend, OPS), crÃ©er une tÃ¢che ou sous-tÃ¢che par environnement.
- **Lâ€™IA doit, pour chaque tÃ¢che, analyser la structure du projet (ex : existence de modules, composants, services, patterns) et le contenu des guidelines pour proposer un dÃ©coupage pertinent, conforme et adaptÃ© Ã  la rÃ©alitÃ© technique du projet.**

---

## 2. ğŸ·ï¸ Conventions de slug / ID et hiÃ©rarchie

```text
<prd-slug>      ::= kebab-case du titre PRD (sans accents)
<epic-slug>     ::= <prd-slug>
<feature-slug>  ::= <epic-slug>:<environment>:<num>
<task-slug>     ::= <feature-slug>:<num>
<subtask-slug>  ::= <task-slug>:<num>
```
- Les slugs sont utilisÃ©s pourâ€¯: branches Git (`prd/<slug>`), commits (`PRD:<slug>`), tags (`PRD:<slug>`).
- **HiÃ©rarchie**â€¯: chaque ligne de la table `tasks` doit comporter un champ `type` (`epic`, `feature`, `task`) et un champ `parent_task_id` (uuid) pour relier chaque niveau Ã  son parent. Les sous-tÃ¢ches utilisent le champ `task_id` pour pointer vers leur tÃ¢che parente.

---

## 3. ğŸ“„ SchÃ©ma JSON TaskPlan

```json
{
  "tasks": [
    {
      "title": "Gestion des rÃ´les",
      "slug": "gestion-roles",
      "type": "epic",
      "guideline_refs": [],
      "environment": [],
      "tags": ["user-story", "PRD:gestion-roles"]
    },
    {
      "title": "API RÃ´les",
      "slug": "gestion-roles:backend:1",
      "type": "feature",
      "parent_task_id": "<uuid-epic>",
      "guideline_refs": ["BG", "PG", "TA"],
      "environment": ["backend"],
      "tags": ["feature", "PRD:gestion-roles"]
    },
    {
      "title": "Endpoint POST /roles",
      "slug": "gestion-roles:backend:1:1",
      "type": "task",
      "parent_task_id": "<uuid-feature>",
      "guideline_refs": ["BG", "PG", "TA"],
      "environment": ["backend"],
      "tags": ["task", "PRD:gestion-roles"],
      "estimated_hours": 8
    }
  ],
  "subtasks": [
    {
      "title": "ImplÃ©menter scÃ©nario Â« Ajouter un rÃ´le Â»",
      "slug": "gestion-roles:backend:1:1:1",
      "task_id": "<uuid-task>",
      "guideline_refs": ["BG", "TA"],
      "environment": ["backend"],
      "estimated_hours": 4
    }
  ]
}
```
- Lâ€™IA fournit ce JSON **et** une vue Markdown avant crÃ©ation effective dans Supabase.

---

## 4. â±ï¸ Estimation & capacitÃ©

| Tâ€‘shirt | Heures par dÃ©faut |
| ------- | ----------------- |
| XS      | 2h                |
| S       | 4h                |
| M       | 8h                |
| L       | 16h               |
| XL      | 32h               |

- Lâ€™IA propose un sizing (`XS`â€‘`XL`), convertit en `estimated_hours`, lâ€™utilisateur valide ou ajuste.

---

## 5. ğŸ”— TraÃ§abilitÃ© PRD â†” Tickets

- Chaque ticket reÃ§oit `tags += ['PRD:<slug>']`.
- Le PRD enrichit la section **Roadmap** avec un tableau des slugs gÃ©nÃ©rÃ©s.
- Les liens croisÃ©s sont mis Ã  jour automatiquement lors de la gÃ©nÃ©ration TaskPlan.
- Champ `guideline_refs` (array) rempli automatiquementâ€¯:  
  - frontend â†’ ["FG","PG","TA"]  
  - backend â†’ ["BG","PG","TA"]  
  - ops â†’ ["PG","TA"]

---

## 6. ğŸ—„ï¸ Enregistrement dans Supabase (MCP Supabase)

- **Obligation**â€¯:  
  Chaque ticket gÃ©nÃ©rÃ© (epic, feature, task, sub-task) doit Ãªtre enregistrÃ© dans la base Supabase via le MCP Supabase, qui est la source de vÃ©ritÃ© pour la gestion des tÃ¢ches AgroFlow.
- **VÃ©rification anti-doublon**â€¯:  
  Avant dâ€™enregistrer une nouvelle tÃ¢che, vÃ©rifier si une tÃ¢che similaire (mÃªme slug ou tag PRD) existe dÃ©jÃ  dans Supabase. Si oui, proposer la modification plutÃ´t que la crÃ©ation.
- **Structure**â€¯:  
  Respecter les tables et relations attendues par le MCP Supabase (`tasks`, `subtasks`), en utilisant les bons champs (`type`, `parent_task_id`, `task_id`, etc.).
- **Anti-pattern**â€¯:  
  Ne jamais stocker les tickets uniquement en mÃ©moire locale ou dans un autre systÃ¨me (exâ€¯: Redis). Supabase est la seule source de vÃ©ritÃ©.
- **Fallback**â€¯:  
  Si Supabase nâ€™est pas disponible, stocker temporairement le JSON dans le dossier PRD, mais la synchronisation avec Supabase reste obligatoire dÃ¨s que possible.

---

## 7. ğŸš¦ Protocole dâ€™interaction (TaskMaster)

1. **Clarification**â€¯: demander les sections PRD manquantes.
2. **Proposition**â€¯: envoyer `TaskPlan` JSON + Markdown.
3. **Validation**â€¯: crÃ©er tickets via Supabase.
4. **Feedback**â€¯: confirmer rÃ©ussite ou signaler erreur.

---

## 8. ğŸ›‘ Red Flags & contrÃ´les automatiques

| Code   | Situation                             | Action IA                  |
| ------ | ------------------------------------- | -------------------------- |
| TMâ€‘101 | User Story sans critÃ¨re dâ€™acceptation | Demander scÃ©narios Gherkin |
| TMâ€‘102 | Task sans environnement unique        | Scinder la task            |
| TMâ€‘103 | Estimation manquante                  | Proposer XSÂ =Â 2h           |
| TMâ€‘104 | Slug non conforme                     | Recalculer slug kebabâ€‘case |
| TMâ€‘105 | guideline_refs vide                   | Bloquer crÃ©ation           |

---

## 9. ğŸ“‹ Exemples

### Extrait PRD

```
En tant quâ€™Administrateur,
Je souhaite gÃ©rer les rÃ´les utilisateurs,
Afin de contrÃ´ler lâ€™accÃ¨s aux modules.
```

#### Gherkin

```gherkin
Scenario: Ajouter un rÃ´le
  Given je suis sur la page de gestion des rÃ´les
  When je clique sur Â«Â AjouterÂ Â» et renseigne Â«Â Ã©diteurÂ Â»
  Then le rÃ´le Â«Â Ã©diteurÂ Â» apparaÃ®t dans la liste
```

### Plan de tÃ¢ches gÃ©nÃ©rÃ© (Markdown)

| Niveau   | Slug                         | Titre                                    | Env     | Est. |
| -------- | ---------------------------- | ---------------------------------------- | ------- | ---- |
| Epic     | gestion-roles                | Gestion des rÃ´les                        | â€“       | â€“    |
| Feature  | gestion-roles\:backend:1     | API RÃ´les                                | backend | â€“    |
| Task     | gestion-roles\:backend:1:1   | Endpoint POST /roles                     | backend | 8h   |
| Sub-task | gestion-roles\:backend:1:1:1 | ImplÃ©menter scÃ©nario Â«Â Ajouter un rÃ´leÂ Â» | backend | 4h   |

---

## 10. ğŸ“š Annexes

- SchÃ©ma JSON complet des tables Supabase (voir taskMaster.md).
- Exemples de requÃªtes INSERT/UPDATE/SELECT.
- Historique des versions.

---

**RÃ©sumÃ©**â€¯:  
Cette rÃ¨gle fusionnÃ©e garantit que tout dÃ©coupage de PRD en tÃ¢ches de dÃ©veloppement est fait de faÃ§on structurÃ©e, traÃ§able et centralisÃ©e dans Supabase, selon le protocole TaskMaster.  
**Aucune tÃ¢che ne doit Ãªtre crÃ©Ã©e ou suivie ailleurs que dans Supabase.**  
**Lâ€™IA doit toujours appliquer les contrÃ´les automatiques (Red Flags) et respecter le protocole dâ€™interaction.**
