---
description: 
globs: 
alwaysApply: false
---
# 20_task-breakdown.mdc (version enrichie & alignÃ©e TaskMaster)

## ğŸ¯ RÃ´le & Contexte

Cette rÃ¨gle dÃ©finit la mÃ©thode officielle pour transformer un PRD (Product Requirements Document) en tickets de travail structurÃ©s (epics, features, tasks, sub-tasks) dans AgroFlow, en garantissantâ€¯:
- la traÃ§abilitÃ© contractuelle,
- la cohÃ©rence des slugs,
- l'enregistrement systÃ©matique dans Supabase via le MCP,
- la conformitÃ© avec le protocole TaskMaster.
- **L'IA doit analyser et exploiter activement la structure rÃ©elle du projet (architecture, modules, patterns) et le contenu des guidelines pour adapter le dÃ©coupage, la formulation et la granularitÃ© des tÃ¢ches, et non se contenter de rÃ©fÃ©rencer les guidelines.**

---

## 1. ğŸ—‚ï¸ Mapping PRD â†’ Tickets

| Section PRD                   | Niveau ticket | Champs obligatoires                                         | Notes                            |
| ----------------------------- | ------------- | ----------------------------------------------------------- | -------------------------------- |
| **User Story**                | Epic          | `title`, `slug`, `type = 'epic'`, `tags += ['user-story']`  | Slug hÃ©rite du PRD (kebabâ€‘case). |
| **Description fonctionnelle** | Feature       | `title`, `slug`, `type = 'feature'`, `parent_task_id`, `environment` | Un Feature â†” module fonctionnel. |
| **CritÃ¨re d'acceptation**     | Subâ€‘task      | `title`, `slug`, `task_id`, `environment`, `estimated_hours` | 1 scÃ©nario Gherkin = 1 subâ€‘task. |
| **Contrainte ou risque**      | Task          | `title`, `slug`, `type = 'task'`, `parent_task_id`, `priority = high`, `tags += ['risk']` | Si risqueÂ : tag `risk`.          |

- **DÃ©coupage par environnement**â€¯:  
  Si une demande concerne plusieurs environnements (frontend, backend, OPS), crÃ©er une tÃ¢che ou sous-tÃ¢che par environnement.
- **L'IA doit, pour chaque tÃ¢che, analyser la structure du projet (ex : existence de modules, composants, services, patterns) et le contenu des guidelines pour proposer un dÃ©coupage pertinent, conforme et adaptÃ© Ã  la rÃ©alitÃ© technique du projet.**

---

## 2. ğŸ·ï¸ Conventions de slug / ID et hiÃ©rarchie

```text
<prd-slug>      ::= kebab-case du titre PRD (sans accents)
<epic-slug>     ::= <prd-slug>
<feature-slug>  ::= <epic-slug>:<environment>:<num>
<task-slug>     ::= <feature-slug>:<num>
<subtask-slug>  ::= <task-slug>:<num>
```
- Les slugs sont utilisÃ©s pourâ€¯: branches Git (`prd/<slug>`), commits (`PRD:<slug>`), tags (`PRD:<slug>`).
- **HiÃ©rarchie**â€¯: chaque ligne de la table `tasks` doit comporter un champ `type` (`epic`, `feature`, `task`) et un champ `parent_task_id` (uuid) pour relier chaque niveau Ã  son parent. Les sous-tÃ¢ches utilisent le champ `task_id` pour pointer vers leur tÃ¢che parente.

---

## 3. ğŸ“„ SchÃ©ma JSON TaskPlan

```json
{
  "tasks": [
    {
      "title": "Gestion des rÃ´les",
      "slug": "gestion-roles",
      "type": "epic",
      "guideline_refs": [],
      "environment": [],
      "tags": ["user-story", "PRD:gestion-roles"]
    },
    {
      "title": "API RÃ´les",
      "slug": "gestion-roles:backend:1",
      "type": "feature",
      "parent_task_id": "<uuid-epic>",
      "guideline_refs": ["BG", "PG", "TA"],
      "environment": ["backend"],
      "tags": ["feature", "PRD:gestion-roles"]
    },
    {
      "title": "Endpoint POST /roles",
      "slug": "gestion-roles:backend:1:1",
      "type": "task",
      "parent_task_id": "<uuid-feature>",
      "guideline_refs": ["BG", "PG", "TA"],
      "environment": ["backend"],
      "tags": ["task", "PRD:gestion-roles"],
      "estimated_hours": 8
    }
  ],
  "subtasks": [
    {
      "title": "ImplÃ©menter scÃ©nario Â« Ajouter un rÃ´le Â»",
      "slug": "gestion-roles:backend:1:1:1",
      "task_id": "<uuid-task>",
      "guideline_refs": ["BG", "TA"],
      "environment": ["backend"],
      "estimated_hours": 4
    }
  ]
}
```
- L'IA fournit ce JSON **et** une vue Markdown avant crÃ©ation effective dans Supabase.

---

## 4. â±ï¸ Estimation & capacitÃ©

| Tâ€‘shirt | Heures par dÃ©faut |
| ------- | ----------------- |
| XS      | 2h                |
| S       | 4h                |
| M       | 8h                |
| L       | 16h               |
| XL      | 32h               |

- L'IA propose un sizing (`XS`â€‘`XL`), convertit en `estimated_hours`, l'utilisateur valide ou ajuste.

---

## 5. ğŸ”— TraÃ§abilitÃ© PRD â†” Tickets

- Chaque ticket reÃ§oit `tags += ['PRD:<slug>']`.
- Le PRD enrichit la section **Roadmap** avec un tableau des slugs gÃ©nÃ©rÃ©s.
- Les liens croisÃ©s sont mis Ã  jour automatiquement lors de la gÃ©nÃ©ration TaskPlan.
- Champ `guideline_refs` (array) rempli automatiquementâ€¯:  
  - frontend â†’ ["FG","PG","TA"]  
  - backend â†’ ["BG","PG","TA"]  
  - ops â†’ ["PG","TA"]

---

## 6. ğŸ—„ï¸ Enregistrement dans Supabase (MCP Supabase)

- **Obligation**â€¯:  
  Chaque ticket gÃ©nÃ©rÃ© (epic, feature, task, sub-task) doit Ãªtre enregistrÃ© dans la base Supabase via le MCP Supabase, qui est la source de vÃ©ritÃ© pour la gestion des tÃ¢ches AgroFlow.
- **VÃ©rification anti-doublon**â€¯:  
  Avant d'enregistrer une nouvelle tÃ¢che, vÃ©rifier si une tÃ¢che similaire (mÃªme slug ou tag PRD) existe dÃ©jÃ  dans Supabase. Si oui, proposer la modification plutÃ´t que la crÃ©ation.
- **Structure**â€¯:  
  Respecter les tables et relations attendues par le MCP Supabase (`tasks`, `subtasks`), en utilisant les bons champs (`type`, `parent_task_id`, `task_id`, etc.).
- **Anti-pattern**â€¯:  
  Ne jamais stocker les tickets uniquement en mÃ©moire locale ou dans un autre systÃ¨me (exâ€¯: Redis). Supabase est la seule source de vÃ©ritÃ©.
- **Fallback**â€¯:  
  Si Supabase n'est pas disponible, stocker temporairement le JSON dans le dossier PRD, mais la synchronisation avec Supabase reste obligatoire dÃ¨s que possible.

---

## 6.1. ğŸ”¢ RÃ¨gles d'Ordre Logique et de SÃ©quencement

### âš ï¸ RÃˆGLE CRITIQUE : Ordre de CrÃ©ation = NumÃ©ros de TÃ¢che

Le champ `task_number` dans Supabase est **auto-incrÃ©mentÃ©** (`GENERATED ALWAYS AS IDENTITY`). L'ordre de crÃ©ation des tÃ¢ches dÃ©termine directement les numÃ©ros attribuÃ©s, qui doivent reflÃ©ter l'ordre logique d'exÃ©cution.

### ğŸ“‹ SÃ©quence de CrÃ©ation Obligatoire

#### 1ï¸âƒ£ **CrÃ©er les Epics d'abord** (par ordre de prioritÃ© mÃ©tier)
```sql
-- Epic 1 : FonctionnalitÃ©s critiques (authentification, sÃ©curitÃ©)
-- Epic 2 : FonctionnalitÃ©s principales (gestion mÃ©tier)  
-- Epic 3 : FonctionnalitÃ©s avancÃ©es (rapports, analytics)
```

#### 2ï¸âƒ£ **CrÃ©er les Features par Epic** (par ordre de dÃ©pendance)
Pour chaque Epic, crÃ©er les Features dans l'ordre logique :
```sql
-- Feature 1 : Backend/API d'abord (fondation)
-- Feature 2 : Frontend/UI ensuite (consommation)
-- Feature 3 : Tests/IntÃ©gration en dernier
```

#### 3ï¸âƒ£ **CrÃ©er les Tasks par Feature** (par ordre d'exÃ©cution technique)
Pour chaque Feature, crÃ©er les Tasks selon les dÃ©pendances :
```sql
-- Task 1 : ModÃ¨les/EntitÃ©s (fondation)
-- Task 2 : Services/Logique mÃ©tier  
-- Task 3 : ContrÃ´leurs/API
-- Task 4 : Composants/Interface
-- Task 5 : Tests/Validation
```

### ğŸ”„ Analyse des DÃ©pendances Obligatoire

Avant la crÃ©ation, l'IA DOIT analyser :

#### **DÃ©pendances techniques** :
- Backend avant Frontend
- EntitÃ©s avant Services
- Services avant ContrÃ´leurs
- API avant composants UI

#### **DÃ©pendances fonctionnelles** :
- Authentification avant autorisation
- CRUD de base avant fonctionnalitÃ©s avancÃ©es
- Gestion des utilisateurs avant gestion des rÃ´les
- Configuration avant utilisation

#### **DÃ©pendances de donnÃ©es** :
- Tables de rÃ©fÃ©rence avant tables mÃ©tier
- DonnÃ©es maÃ®tres avant donnÃ©es transactionnelles
- SchÃ©ma de base avant migrations complexes

### ğŸ“Š Exemple Concret : Epic "Gestion des Stocks"

**Ordre de crÃ©ation logique :**
```
1. Epic : Gestion des Stocks                    (task_number: 1)
2. Feature : Backend - EntitÃ©s Stock             (task_number: 2)
3. Feature : Backend - API Stock                 (task_number: 3)  
4. Feature : Frontend - Interface Stock          (task_number: 4)
5. Task : CrÃ©er entitÃ© RawMaterial               (task_number: 5)
6. Task : CrÃ©er service RawMaterialService       (task_number: 6)
7. Task : CrÃ©er contrÃ´leur RawMaterialController (task_number: 7)
8. Task : CrÃ©er composant RawMaterialList        (task_number: 8)
9. Task : CrÃ©er composant RawMaterialForm        (task_number: 9)
```

### âš™ï¸ Algorithme de Tri Automatique

L'IA doit appliquer cet algorithme avant crÃ©ation :

```python
def trier_taches_par_ordre_logique(taches):
    # 1. Trier par type (epic > feature > task)
    # 2. Trier par environnement (backend > frontend > OPS)
    # 3. Trier par dÃ©pendance technique (entitÃ© > service > controller > UI)
    # 4. Trier par prioritÃ© mÃ©tier (critique > normal > optionnel)
    return taches_triees
```

### ğŸš¨ ContrÃ´les de CohÃ©rence

Avant chaque crÃ©ation de tÃ¢che, vÃ©rifier :

- [ ] **DÃ©pendances satisfaites** : Toutes les tÃ¢ches prÃ©requises sont dÃ©jÃ  crÃ©Ã©es
- [ ] **Ordre technique** : Backend avant Frontend
- [ ] **Ordre fonctionnel** : Fondations avant spÃ©cialisation  
- [ ] **NumÃ©rotation cohÃ©rente** : Les numÃ©ros reflÃ¨tent l'ordre d'exÃ©cution

### ğŸ“ Template de Planification

```markdown
## Plan de CrÃ©ation SÃ©quentielle

### Phase 1 : Epics (ordre de prioritÃ© mÃ©tier)
1. Epic A : [Titre] - PrioritÃ© critique
2. Epic B : [Titre] - PrioritÃ© normale

### Phase 2 : Features (ordre de dÃ©pendance par Epic)
Epic A :
1. Feature A1 : Backend - [Titre]
2. Feature A2 : Frontend - [Titre]

### Phase 3 : Tasks (ordre technique par Feature)  
Feature A1 :
1. Task A1.1 : EntitÃ© - [Titre]
2. Task A1.2 : Service - [Titre]
3. Task A1.3 : Controller - [Titre]
```

### âš ï¸ Red Flags - Ordre Logique

| Code   | Situation                                   | Action IA                            |
|--------|---------------------------------------------|--------------------------------------|
| TM-201 | Frontend crÃ©Ã© avant Backend correspondant   | RÃ©organiser l'ordre de crÃ©ation     |
| TM-202 | ContrÃ´leur crÃ©Ã© avant Service               | DÃ©placer le contrÃ´leur aprÃ¨s service|
| TM-203 | Feature crÃ©Ã©e avant Epic parent             | CrÃ©er l'Epic d'abord                |
| TM-204 | TÃ¢ches sans analyse des dÃ©pendances         | Analyser et rÃ©ordonner              |

---

## 7. ğŸš¦ Protocole d'interaction (TaskMaster)

1. **Clarification**â€¯: demander les sections PRD manquantes.
2. **Proposition**â€¯: envoyer `TaskPlan` JSON + Markdown.
3. **Validation**â€¯: crÃ©er tickets via Supabase.
4. **Feedback**â€¯: confirmer rÃ©ussite ou signaler erreur.

---

## 8. ğŸ›‘ Red Flags & contrÃ´les automatiques

| Code   | Situation                             | Action IA                  |
| ------ | ------------------------------------- | -------------------------- |
| TMâ€‘101 | User Story sans critÃ¨re d'acceptation | Demander scÃ©narios Gherkin |
| TMâ€‘102 | Task sans environnement unique        | Scinder la task            |
| TMâ€‘103 | Estimation manquante                  | Proposer XS = 2h           |
| TMâ€‘104 | Slug non conforme                     | Recalculer slug kebabâ€‘case |
| TMâ€‘105 | guideline_refs vide                   | Bloquer crÃ©ation           |
| TMâ€‘201 | Frontend crÃ©Ã© avant Backend correspondant | RÃ©organiser l'ordre de crÃ©ation |
| TMâ€‘202 | ContrÃ´leur crÃ©Ã© avant Service         | DÃ©placer le contrÃ´leur aprÃ¨s service |
| TMâ€‘203 | Feature crÃ©Ã©e avant Epic parent       | CrÃ©er l'Epic d'abord       |
| TMâ€‘204 | TÃ¢ches sans analyse des dÃ©pendances   | Analyser et rÃ©ordonner     |

---

## 9. ğŸ“‹ Exemples

### Extrait PRD

```
En tant qu'Administrateur,
Je souhaite gÃ©rer les rÃ´les utilisateurs,
Afin de contrÃ´ler l'accÃ¨s aux modules.
```

#### Gherkin

```gherkin
Scenario: Ajouter un rÃ´le
  Given je suis sur la page de gestion des rÃ´les
  When je clique sur Â« Ajouter Â» et renseigne Â« Ã©diteur Â»
  Then le rÃ´le Â« Ã©diteur Â» apparaÃ®t dans la liste
```

### Plan de tÃ¢ches gÃ©nÃ©rÃ© (Markdown)

| Niveau   | Slug                         | Titre                                    | Env     | Est. |
| -------- | ---------------------------- | ---------------------------------------- | ------- | ---- |
| Epic     | gestion-roles                | Gestion des rÃ´les                        | â€“       | â€“    |
| Feature  | gestion-roles\:backend:1     | API RÃ´les                                | backend | â€“    |
| Task     | gestion-roles\:backend:1:1   | Endpoint POST /roles                     | backend | 8h   |
| Sub-task | gestion-roles\:backend:1:1:1 | ImplÃ©menter scÃ©nario Â« Ajouter un rÃ´le Â» | backend | 4h   |

---

## 10. ğŸ“š Annexes

- SchÃ©ma JSON complet des tables Supabase (voir taskMaster.md).
- Exemples de requÃªtes INSERT/UPDATE/SELECT.
- Historique des versions.

---

## RÃ©fÃ©rences croisÃ©es

- [50_docs-management.mdc](mdc:50_docs-management.mdc) â€“ Obligation de consultation et de mise Ã  jour de la documentation @/docs lors du dÃ©coupage en tÃ¢ches ou sous-tÃ¢ches.

**RÃ©sumÃ©**â€¯:  
Cette rÃ¨gle fusionnÃ©e garantit que tout dÃ©coupage de PRD en tÃ¢ches de dÃ©veloppement est fait de faÃ§on structurÃ©e, traÃ§able et centralisÃ©e dans Supabase, selon le protocole TaskMaster.  
**Aucune tÃ¢che ne doit Ãªtre crÃ©Ã©e ou suivie ailleurs que dans Supabase.**  
**L'IA doit toujours appliquer les contrÃ´les automatiques (Red Flags) et respecter le protocole d'interaction.**
