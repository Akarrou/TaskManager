# 20_task-breakdown.mdc (version enrichie & align√©e TaskMaster)

## üéØ R√¥le & Contexte

Cette r√®gle d√©finit la m√©thode officielle pour transformer un PRD (Product Requirements Document) en tickets de travail structur√©s (epics, features, tasks, sub-tasks) dans TaskManager, en garantissant‚ÄØ:

- la tra√ßabilit√© contractuelle,
- la coh√©rence des slugs,
- l'enregistrement syst√©matique dans Supabase via le MCP,
- la conformit√© avec le protocole TaskMaster.
- **L'IA doit analyser et exploiter activement la structure r√©elle du projet (architecture, modules, patterns) et le contenu des guidelines pour adapter le d√©coupage, la formulation et la granularit√© des t√¢ches, et non se contenter de r√©f√©rencer les guidelines.**

---

## 1. üóÇÔ∏è Mapping PRD ‚Üí Tickets

| Section PRD                   | Niveau ticket | Champs obligatoires                                                                       | Notes                            |
| ----------------------------- | ------------- | ----------------------------------------------------------------------------------------- | -------------------------------- |
| **User Story**                | Epic          | `title`, `slug`, `type = 'epic'`, `tags += ['user-story']`                                | Slug h√©rite du PRD (kebab‚Äëcase). |
| **Description fonctionnelle** | Feature       | `title`, `slug`, `type = 'feature'`, `parent_task_id`, `environment`                      | Un Feature ‚Üî module fonctionnel. |
| **Crit√®re d'acceptation**     | Sub‚Äëtask      | `title`, `slug`, `task_id`, `environment`, `estimated_hours`                              | 1 sc√©nario Gherkin = 1 sub‚Äëtask. |
| **Contrainte ou risque**      | Task          | `title`, `slug`, `type = 'task'`, `parent_task_id`, `priority = high`, `tags += ['risk']` | Si risque¬†: tag `risk`.          |

- **D√©coupage par environnement**‚ÄØ:  
  Si une demande concerne plusieurs environnements (frontend, backend, OPS), cr√©er une t√¢che ou sous-t√¢che par environnement.
- **L'IA doit, pour chaque t√¢che, analyser la structure du projet (ex : existence de modules, composants, services, patterns) et le contenu des guidelines pour proposer un d√©coupage pertinent, conforme et adapt√© √† la r√©alit√© technique du projet.**

---

## 2. üè∑Ô∏è Conventions de slug / ID et hi√©rarchie

```text
<prd-slug>      ::= kebab-case du titre PRD (sans accents)
<epic-slug>     ::= <prd-slug>
<feature-slug>  ::= <epic-slug>:<environment>:<num>
<task-slug>     ::= <feature-slug>:<num>
<subtask-slug>  ::= <task-slug>:<num>
```

- Les slugs sont utilis√©s pour‚ÄØ: branches Git (`prd/<slug>`), commits (`PRD:<slug>`), tags (`PRD:<slug>`).
- **Hi√©rarchie**‚ÄØ: chaque ligne de la table `tasks` doit comporter un champ `type` (`epic`, `feature`, `task`) et un champ `parent_task_id` (uuid) pour relier chaque niveau √† son parent. Les sous-t√¢ches utilisent le champ `task_id` pour pointer vers leur t√¢che parente.

---

## 3. üìÑ Sch√©ma JSON TaskPlan

```json
{
  "tasks": [
    {
      "title": "Gestion des r√¥les",
      "slug": "gestion-roles",
      "type": "epic",
      "guideline_refs": [],
      "environment": [],
      "tags": ["user-story", "PRD:gestion-roles"]
    },
    {
      "title": "API R√¥les",
      "slug": "gestion-roles:backend:1",
      "type": "feature",
      "parent_task_id": "<uuid-epic>",
      "guideline_refs": ["BG", "PG", "TA"],
      "environment": ["backend"],
      "tags": ["feature", "PRD:gestion-roles"]
    },
    {
      "title": "Endpoint POST /roles",
      "slug": "gestion-roles:backend:1:1",
      "type": "task",
      "parent_task_id": "<uuid-feature>",
      "guideline_refs": ["BG", "PG", "TA"],
      "environment": ["backend"],
      "tags": ["task", "PRD:gestion-roles"],
      "estimated_hours": 8
    }
  ],
  "subtasks": [
    {
      "title": "Impl√©menter sc√©nario ¬´ Ajouter un r√¥le ¬ª",
      "slug": "gestion-roles:backend:1:1:1",
      "task_id": "<uuid-task>",
      "guideline_refs": ["BG", "TA"],
      "environment": ["backend"],
      "estimated_hours": 4
    }
  ]
}
```

- L'IA fournit ce JSON **et** une vue Markdown avant cr√©ation effective dans Supabase.

---

## 4. ‚è±Ô∏è Estimation & capacit√©

| T‚Äëshirt | Heures par d√©faut |
| ------- | ----------------- |
| XS      | 2h                |
| S       | 4h                |
| M       | 8h                |
| L       | 16h               |
| XL      | 32h               |

- L'IA propose un sizing (`XS`‚Äë`XL`), convertit en `estimated_hours`, l'utilisateur valide ou ajuste.

---

## 5. üîó Tra√ßabilit√© PRD ‚Üî Tickets

- Chaque ticket re√ßoit `tags += ['PRD:<slug>']`.
- Le PRD enrichit la section **Roadmap** avec un tableau des slugs g√©n√©r√©s.
- Les liens crois√©s sont mis √† jour automatiquement lors de la g√©n√©ration TaskPlan.
- Champ `guideline_refs` (array) rempli automatiquement‚ÄØ:
  - frontend ‚Üí ["FG","PG","TA"]
  - backend ‚Üí ["BG","PG","TA"]
  - ops ‚Üí ["PG","TA"]

---

### 5.1. üè∑Ô∏è Assignation des Tags de Workflow

Pour pr√©-qualifier une t√¢che et permettre √† l'orchestrateur (`35_task-orchestrator.mdc`) de choisir le bon workflow (standard ou Fast Track), l'IA doit syst√©matiquement ajouter des tags de workflow en plus des tags de structure, en se basant sur la nature de la demande.

**Table de correspondance des tags de workflow :**

| **Si la demande initiale concerne...**           | **Ajouter le(s) tag(s) au champ `tags`** | **Exemple de demande**                              |
| :----------------------------------------------- | :--------------------------------------- | :-------------------------------------------------- |
| Une correction d'anomalie, un bug report         | `bug`, `fix`                             | "Le bouton de sauvegarde ne marche pas"             |
| Une simple modification de texte/libell√©         | `typo`, `content`                        | "Changer le titre de la page d'accueil"             |
| Uniquement la mise √† jour de documentation       | `docs`                                   | "Mettre √† jour le README du backend"                |
| Un remaniement technique sans impact fonctionnel | `refactor`                               | "Extraire la logique de validation dans un service" |
| Une question de performance                      | `performance`                            | "Optimiser la requ√™te de la page des produits"      |

---

## 6. üóÑÔ∏è Enregistrement dans Supabase (MCP Supabase)

- **Obligation**‚ÄØ:  
  Chaque ticket g√©n√©r√© (epic, feature, task, sub-task) doit √™tre enregistr√© dans la base Supabase via le MCP Supabase, qui est la source de v√©rit√© pour la gestion des t√¢ches TaskManager.
- **V√©rification anti-doublon**‚ÄØ:  
  **Validation Anti-Doublon :** Appliquer la proc√©dure [validation-common.mdc](mdc:fragments/validation-common.mdc) - Section Anti-Doublon
- **Structure**‚ÄØ:  
  Respecter les tables et relations attendues par le MCP Supabase (`tasks`, `subtasks`), en utilisant les bons champs (`type`, `parent_task_id`, `task_id`, etc.).
- **Anti-pattern**‚ÄØ:  
  Ne jamais stocker les tickets uniquement en m√©moire locale ou dans un autre syst√®me (ex‚ÄØ: Redis). Supabase est la seule source de v√©rit√©.
- **Fallback**‚ÄØ:  
  **Fallback automatique** : Si Supabase n'est pas disponible, basculer automatiquement vers le mode d√©grad√© :
- Stocker le JSON dans `@/PRD/tasks-cache/<timestamp>_tasks.json`
- Cr√©er un fichier de synchronisation `sync-pending.log`
- Continuer le workflow normalement
- Synchroniser automatiquement d√®s que Supabase est disponible

---

## 6.1. üî¢ R√®gles d'Ordre Logique et de S√©quencement

### ‚ö†Ô∏è R√àGLE CRITIQUE : Ordre de Cr√©ation = Num√©ros de T√¢che

Le champ `task_number` dans Supabase est **auto-incr√©ment√©** (`GENERATED ALWAYS AS IDENTITY`). L'ordre de cr√©ation des t√¢ches d√©termine directement les num√©ros attribu√©s, qui doivent refl√©ter l'ordre logique d'ex√©cution.

### üìã S√©quence de Cr√©ation Obligatoire

#### 1Ô∏è‚É£ **Cr√©er les Epics d'abord** (par ordre de priorit√© m√©tier)

```sql
-- Epic 1 : Fonctionnalit√©s critiques (authentification, s√©curit√©)
-- Epic 2 : Fonctionnalit√©s principales (gestion m√©tier)
-- Epic 3 : Fonctionnalit√©s avanc√©es (rapports, analytics)
```

#### 2Ô∏è‚É£ **Cr√©er les Features par Epic** (par ordre de d√©pendance)

Pour chaque Epic, cr√©er les Features dans l'ordre logique :

```sql
-- Feature 1 : Backend/API d'abord (fondation)
-- Feature 2 : Frontend/UI ensuite (consommation)
-- Feature 3 : Tests/Int√©gration en dernier
```

#### 3Ô∏è‚É£ **Cr√©er les Tasks par Feature** (par ordre d'ex√©cution technique)

Pour chaque Feature, cr√©er les Tasks selon les d√©pendances :

```sql
-- Task 1 : Mod√®les/Entit√©s (fondation)
-- Task 2 : Services/Logique m√©tier
-- Task 3 : Contr√¥leurs/API
-- Task 4 : Composants/Interface
-- Task 5 : Tests/Validation
```

### üîÑ Analyse des D√©pendances Obligatoire

Avant la cr√©ation, l'IA DOIT analyser :

#### **D√©pendances techniques** :

- Backend avant Frontend
- Entit√©s avant Services
- Services avant Contr√¥leurs
- API avant composants UI

#### **D√©pendances fonctionnelles** :

- Authentification avant autorisation
- CRUD de base avant fonctionnalit√©s avanc√©es
- Gestion des utilisateurs avant gestion des r√¥les
- Configuration avant utilisation

#### **D√©pendances de donn√©es** :

- Tables de r√©f√©rence avant tables m√©tier
- Donn√©es ma√Ætres avant donn√©es transactionnelles
- Sch√©ma de base avant migrations complexes

### üìä Exemple Concret : Epic "Gestion des Stocks"

**Ordre de cr√©ation logique :**

```
**R√©sum√©**‚ÄØ:
Cette r√®gle fusionn√©e garantit que tout d√©coupage de PRD en t√¢ches de d√©veloppement est fait de fa√ßon structur√©e, tra√ßable et centralis√©e dans Supabase, selon le protocole TaskMaster.
**Aucune t√¢che ne doit √™tre cr√©√©e ou suivie ailleurs que dans Supabase.**
**L'IA doit toujours appliquer les contr√¥les automatiques (Red Flags) et respecter le protocole d'interaction.**
```

---

## 7. üîÑ Boucle de Validation du Plan (Quality Gate)

**R√àGLE CRITIQUE :** La cr√©ation des t√¢ches dans Supabase ne doit **JAMAIS** √™tre automatique. Elle est conditionn√©e par votre validation explicite.

### √âtape 1 : Pr√©sentation du Plan de T√¢ches

Une fois l'analyse du PRD termin√©e, je dois vous pr√©senter le plan de d√©composition complet sous deux formats :

1.  Une vue **Markdown** claire et lisible.
2.  Le bloc de code **JSON** (`TaskPlan`) qui sera utilis√© pour la cr√©ation.

### √âtape 2 : Demande de Validation Explicite

Apr√®s avoir pr√©sent√© le plan, je dois m'arr√™ter et vous poser la question suivante :

> **Le plan de d√©composition des t√¢ches vous convient-il ? Puis-je proc√©der √† leur cr√©ation dans Supabase ?**

### √âtape 3 : Ex√©cution ou It√©ration

- **Si vous r√©pondez "Oui"** (ou une affirmation √©quivalente) : J'ex√©cute les commandes de cr√©ation des t√¢ches dans Supabase en respectant scrupuleusement l'ordre d√©fini.
- **Si vous r√©pondez "Non"** (ou demandez des modifications) : Je me mets en attente de vos instructions pour r√©viser le plan de t√¢ches. Je ne proc√®de √† aucune cr√©ation.

**R√©sum√©**‚ÄØ:
Cette r√®gle fusionn√©e garantit que tout d√©coupage de PRD en t√¢ches de d√©veloppement est fait de fa√ßon structur√©e, tra√ßable et centralis√©e dans Supabase, selon le protocole TaskMaster.
**Aucune t√¢che ne doit √™tre cr√©√©e ou suivie ailleurs que dans Supabase.**
**L'IA doit toujours appliquer les contr√¥les automatiques (Red Flags) et respecter le protocole d'interaction.**
