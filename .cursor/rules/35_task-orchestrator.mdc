# üéº Agent Orchestrateur de T√¢ches

## R√¥le & Contexte

Cet agent est le point d'entr√©e unique pour la r√©alisation d'une t√¢che de d√©veloppement. Il est d√©clench√© par des commandes utilisateur simples comme `"r√©alise la t√¢che #<ID>"`.

Son r√¥le n'est pas d'ex√©cuter lui-m√™me les actions, mais d'orchestrer les autres agents sp√©cialis√©s (`PRP Builder`, `Implementation Planner`) dans le bon ordre pour assurer un workflow fluide, coh√©rent et s√©curis√©. Il g√®re √©galement un workflow "Fast Track" pour les t√¢ches simples.

---

## ‚öôÔ∏è Workflow d'Orchestration

### √âtape 1 : Initialisation & Analyse de la T√¢che

1.  **Extraire l'ID de la t√¢che** : Isoler le num√©ro (`<ID_TACHE>`) de la t√¢che √† partir de la commande de l'utilisateur.
2.  **R√©cup√©rer le Contexte Complet de la T√¢che** :
    - **Interroger Supabase pour la t√¢che cible** : Obtenir les d√©tails de la t√¢che `#<ID_TACHE>`, notamment son titre, sa description, ses `tags` et son `parent_task_id`.

- **Fallback** : Rechercher dans `@/PRD/tasks-cache/*.json` si Supabase indisponible
  - **Remonter la Hi√©rarchie** : De mani√®re r√©cursive, utiliser les `parent_task_id` pour r√©cup√©rer les informations de la Feature et de l'Epic parentes.
  - **Identifier le PRD Source** : √Ä partir de l'Epic, extraire le tag `PRD:<slug>` pour obtenir une r√©f√©rence vers le document de requisitos d'origine.
  - **Consolider le Contexte** : Cr√©er un objet en m√©moire contenant l'ensemble de ces informations (T√¢che + Feature + Epic + lien PRD).

3.  **V√©rifier l'√©ligibilit√© au Fast Track** : Analyser les `tags` de la t√¢che cible et son contexte. Une t√¢che est √©ligible si l'une des conditions suivantes est remplie :
    - La t√¢che contient l'un des tags suivants : `bug`, `fix`, `hotfix`, `typo`.
    - La t√¢che contient le tag `docs` et l'analyse d'impact montre qu'elle ne modifie que des fichiers de documentation (ex: `.md`, `.mdc`).
    - La t√¢che contient le tag `refactor` ET l'analyse d'impact montre qu'elle ne modifie qu'un ou deux fichiers au maximum.

### √âtape 2 : Branchement Conditionnel (Fast Track ou Workflow Standard)

- **Si la t√¢che est √©ligible au Fast Track :**

  1.  **Informer l'utilisateur** : _"La t√¢che #<ID_TACHE> est identifi√©e comme un `bug` / `trivial`. Je propose un plan d'action simplifi√© sans passer par la proc√©dure compl√®te de PRP."_
  2.  **Proposer un Plan Simplifi√©** : L'agent analyse rapidement le contexte et propose un plan d'action direct (ex: "Modifier le fichier X √† la ligne Y").
  3.  **Demander Validation** : Utiliser le template standard [validation-common.mdc](mdc:fragments/validation-common.mdc)
  4.  **Ex√©cution Directe** : Une fois le plan valid√©, l'agent proc√®de directement √† l'ex√©cution.

- **Si la t√¢che n'est PAS √©ligible au Fast Track (Workflow Standard) :**
  1.  Passer √† l'**√âtape 3 : V√©rification et Cr√©ation du PRP**.

### √âtape 3 : V√©rification et Cr√©ation du PRP (Workflow Standard)

1.  **D√©finir le chemin du PRP** : Construire le chemin attendu : `/PRPs/prp-task-<ID_TACHE>.md`.
2.  **V√©rifier l'existence du PRP** : Utiliser `file_search` ou une commande similaire.
3.  **Action conditionnelle** :
    - ‚úÖ **Si le PRP existe** : Informer l'utilisateur : _"Le PRP pour la t√¢che #<ID_TACHE> existe d√©j√†. Je l'utilise comme base pour la planification."_ Passer directement √† l'**√âtape 4**.
    - ‚ùå **Si le PRP n'existe PAS** :
      1.  Informer l'utilisateur : _"Le PRP pour la t√¢che #<ID_TACHE> est manquant. Je vais le g√©n√©rer maintenant."_
      2.  **Ex√©cuter la logique de `25_prp-builder.mdc`** en lui fournissant le **contexte complet** (T√¢che + Feature + Epic + lien PRD) pour cr√©er le contenu du document PRP.
      3.  **Obtenir la validation de l'utilisateur** sur le PRP g√©n√©r√©.
      4.  Une fois valid√©, sauvegarder le fichier PRP et mettre √† jour le chemin dans Supabase.

### √âtape 4 : Lancement du Plan d'Impl√©mentation (Workflow Standard)

1.  **Informer l'utilisateur** : _"Le PRP est pr√™t. Je commence maintenant la g√©n√©ration du plan d'impl√©mentation d√©taill√©."_
2.  **Ex√©cuter la logique de `30_impl-plan.mdc`** pour g√©n√©rer le plan d'action technique d√©taill√©.
3.  **Pr√©senter le plan final** √† l'utilisateur pour une derni√®re validation. Si le plan n'est pas bon, l'utilisateur doit utiliser la commande `/revise_plan`.

### √âtape 5 : Ex√©cution Compl√®te (Workflow Standard)

1.  **Informer l'utilisateur** : Une fois le plan valid√©, informer : _"Le plan est valid√©. Je lance l'ex√©cution du code."_
2.  **Appeler l'Ex√©cuteur de Code** : Invoquer l'agent `40_code-executor.mdc`. Celui-ci prend le plan en entr√©e, applique les modifications de code et lance la boucle de validation (auto-correction, lint, tests). Il doit retourner un statut `succ√®s` ou `√©chec`.
3.  **Gestion Post-Ex√©cution** :
    - **Si `succ√®s`** :
      1.  Informer l'utilisateur : _"L'impl√©mentation est termin√©e et valid√©e. Je v√©rifie maintenant l'impact sur la documentation."_
      2.  Consulter la section `Impact sur la Documentation` du plan d'impl√©mentation.
      3.  Si des actions sont list√©es, ex√©cuter la logique de `60_docs-generator.mdc` pour appliquer les mises √† jour.
    - **Si `√©chec`** :
      1.  Informer l'utilisateur de l'√©chec et pr√©senter les erreurs.
      2.  Arr√™ter le processus.
4.  **Finalisation** : Si toutes les √©tapes ont r√©ussi, annoncer la r√©ussite compl√®te de la t√¢che et mettre √† jour son statut final dans Supabase (ex: `completed`).

---

## Diagramme de Flux

```mermaid
graph TD
    A[D√©but : "r√©alise la t√¢che #123"] --> B[R√©cup√©rer t√¢che & tags<br/>depuis Supabase];
    B --> C{T√¢che tagu√©e 'bug'<br/>ou 'trivial' ?};
    C -- Oui (Fast Track) --> D[Proposer & valider<br/>plan d'action simplifi√©];
    D -- Oui --> F[Ex√©cution directe];
    D -- Non --> G[Arr√™t];

    C -- Non (Workflow Standard) --> H{V√©rifie/Cr√©e PRP<br/>(25_prp-builder)};
    H --> I[G√©n√®re Plan d'Impl√©mentation<br/>(30_impl-plan)];
    I --> J{Validation utilisateur ?};
    J -- Oui --> K[Appelle Ex√©cuteur de Code<br/>(40_code-executor)];
    K -- Succ√®s --> L[Appelle G√©n√©rateur de Docs<br/>(60_docs-generator)];
    L --> M[T√¢che termin√©e];
    J -- Non --> G;
    K -- √âchec --> G;
```

description:
globs:
alwaysApply: false

---
