---
description: 
globs: 
alwaysApply: false
---
---
description: Guidelines backend Spring Boot, JPA, s√©curit√©, structure et qualit√© pour AgroFlow
globs: ["Back/**/*.java", "Back/**/pom.xml", "Back/src/main/resources/**/*", "Back/src/test/**/*"]
alwaysApply: false
---

# 41_guidelines-backend.mdc

## R√¥le & Contexte
Ce fichier centralise toutes les conventions, patterns, anti-patterns et bonnes pratiques Spring Boot, JPA, s√©curit√©, structure et qualit√© pour le d√©veloppement backend AgroFlow.

---

## üü© Structure recommand√©e

> **Voir l'arborescence compl√®te et les patterns dans [10_project-architecture.mdc](mdc:10_project-architecture.mdc)**

## ‚ö†Ô∏è R√àGLE FONDAMENTALE : Analyse Pr√©alable de la Structure

**AVANT toute cr√©ation de classe, package, service ou contr√¥leur**, l'IA DOIT :

### üîç **Investigation Obligatoire**
1. **Analyser l'architecture existante** : Explorer les packages, les patterns, les conventions d√©j√† en place
2. **Identifier les impl√©mentations similaires** : Chercher des classes/services existants qui peuvent servir de mod√®le
3. **V√©rifier les patterns d'architecture** : S'assurer de respecter la s√©paration des responsabilit√©s (Controller/Service/Repository)
4. **Consulter les exemples de r√©f√©rence** : Utiliser les contr√¥leurs et services existants comme base

### üõ†Ô∏è **Outils √† utiliser syst√©matiquement**
- `codebase_search` : Recherche s√©mantique dans le code Java
- `file_search` : Recherche de classes/interfaces similaires
- `grep_search` : Recherche de patterns sp√©cifiques (annotations, m√©thodes)
- `read_file` : Analyse des classes de r√©f√©rence
- `list_dir` : Exploration de la structure des packages

### üéØ **Questions √† se poser AVANT de cr√©er**
- "Cette classe/service existe-t-elle d√©j√† ?"
- "Quelle est la structure des contr√¥leurs/services similaires ?"
- "Quelles annotations sont utilis√©es dans ce type de classe ?"
- "Quels sont les patterns d'architecture utilis√©s ?"
- "Quelles sont les conventions de nommage dans ce package ?"
- "Quelles permissions `@RequiresPermission` sont n√©cessaires ?"

### üìã **Obligation de Mise √Ä Jour Architecturale**
**APR√àS toute cr√©ation/suppression/d√©placement**, l'IA DOIT automatiquement mettre √† jour `@10_project-architecture.mdc` pour refl√©ter les changements structurels. Voir la section "R√àGLE AUTOMATIQUE : Mise √Ä Jour Obligatoire" dans le fichier d'architecture.

---

## üèóÔ∏è Organisation des Packages

- `config/` : configuration Spring, s√©curit√©, CORS, etc.
- `context/` : contexte d'application (s√©curit√©, JWT)
- `dto/` : objets de transfert de donn√©es
- `dtoMapper/` : mappers entit√©/DTO
- `entity/` : entit√©s JPA
- `enums/` : √©num√©rations m√©tiers
- `exception/` : gestion centralis√©e des exceptions
- `filter/` : filtres HTTP/s√©curit√©
- `repository/` : interfaces JPA (Spring Data)
- `restController/` : endpoints REST
- `service/` : logique m√©tier, organis√©e par domaine

---

## üßë‚Äçüíª Nommage & standards

- Packages : minuscules, structure par couche fonctionnelle
- Classes : PascalCase, nom explicite
- Interfaces : pr√©fixe/suffixe I optionnel, coh√©rence obligatoire
- Variables : camelCase, constantes MAJUSCULES_UNDERSCORE
- Fichiers de configuration : kebab-case

---

## üö¶ Architecture

- Controllers : endpoints REST, validation DTO, pas de logique m√©tier
- Services : logique m√©tier, orchestrateurs, SOLID
- Repositories : acc√®s donn√©es via JPA
- Domain/Entity : mod√®les m√©tiers purs, pas de d√©pendance √† Spring
- Configuration centralis√©e dans `config`
- Exceptions centralis√©es avec `@ControllerAdvice`

---

## üõ°Ô∏è S√©curit√©

### Authentification & Autorisation
- **Authentification JWT** : Utilisation de tokens JWT pour l'authentification
- **Gestion des permissions** : Syst√®me bas√© sur l'annotation `@RequiresPermission`
- **Secrets** : Variables d'environnement pour les informations sensibles
- **Validation** : `@Valid`, `@NotNull`, etc. pour la validation des donn√©es

### Syst√®me de Permissions `@RequiresPermission`

#### Architecture du syst√®me
- **Annotation personnalis√©e** : `@RequiresPermission(PermissionKey.XXX)`
- **Aspect AOP** : `RequiresPermissionAspect` intercepte et v√©rifie les permissions
- **√ânum√©ration** : `PermissionKey` centralise toutes les permissions disponibles
- **Chargement** : `CustomUserDetailsService` charge les permissions dans Spring Security

#### Structure des permissions
Les permissions suivent une nomenclature hi√©rarchique :
```java
// Format : DOMAINE.ACTION ou DOMAINE.SOUS_DOMAINE.ACTION
PRODUCT_CREATE("PRODUCT.CREATE")
PRODUCT_READ("PRODUCT.READ")
RAW_MATERIAL_MANAGE_ALL("RAW.MATERIAL.MANAGE.ALL")
SUPPLIER_MATERIAL_OFFER_READ("SUPPLIER.MATERIAL.OFFER.READ")
```

#### Utilisation dans les contr√¥leurs
```java
@RestController
@RequestMapping("/api/products")
public class ProductController {

    @PostMapping
    @RequiresPermission(PermissionKey.PRODUCT_CREATE)
    public ResponseEntity<ProductDTO> createProduct(@RequestBody ProductDTO dto) {
        // Logique m√©tier
    }

    @GetMapping("/{id}")
    @RequiresPermission(PermissionKey.PRODUCT_READ)
    public ResponseEntity<ProductDTO> getProduct(@PathVariable UUID id) {
        // Logique m√©tier
    }
}
```

#### Types de permissions
- **Actions CRUD** : `CREATE`, `READ`, `UPDATE`, `DELETE`
- **Granularit√©** : permissions sp√©cifiques (`PRODUCT_READ`) et globales (`PRODUCT_READ_ALL`)
- **Permissions sp√©ciales** : `SUPER_ADMIN` pour tous les droits

#### Gestion SUPER_ADMIN
- Le type utilisateur `SUPER_ADMIN` h√©rite automatiquement de toutes les permissions
- V√©rification double : permission sp√©cifique OU statut SUPER_ADMIN
- Chargement automatique de toutes les permissions dans `CustomUserDetailsService`

#### Bonnes pratiques
- **Granularit√©** : Cr√©er des permissions sp√©cifiques plut√¥t que g√©n√©riques
- **Nomenclature** : Respecter le format `DOMAINE.ACTION` ou `DOMAINE.SOUS_DOMAINE.ACTION`
- **Coh√©rence** : Une permission par action m√©tier significative
- **Documentation** : Documenter les permissions dans les contr√¥leurs critiques

#### ‚ö†Ô∏è R√®gles importantes
- **NE PAS utiliser `@PreAuthorize`** : Utiliser exclusivement `@RequiresPermission`
- **Syst√®me unifi√©** : AgroFlow a son propre syst√®me de permissions via AOP
- **Coh√©rence** : Toutes les v√©rifications de permissions doivent passer par `@RequiresPermission`

#### Fichiers d'impl√©mentation
- **Annotation** : `context/security/annotations/RequiresPermission.java`
- **Aspect** : `context/security/annotations/RequiresPermissionAspect.java`
- **√ânum√©ration** : `enums/PermissionKey.java`
- **Service** : `service/user/CustomUserDetailsService.java`
- **Exemples** : Voir les contr√¥leurs dans `restController/`

---

## üß™ Tests & qualit√©

- Couverture minimale 80 %
- JUnit 5, Spring Boot Test, Mockito
- Base de test H2 ou Testcontainers
- Pattern Arrange-Act-Assert
- Noms de tests explicites

---

## ‚öôÔ∏è Performance & maintenabilit√©

- Spring Boot Actuator pour le monitoring
- SLF4J, logs structur√©s, pas de logs sensibles en prod
- Flyway pour les migrations

---

## üìù Documentation

- Javadoc pour classes/services/domaines critiques
- Swagger/OpenAPI pour documentation automatique

---

## üöß CI/CD & workflow

- Branches Git : main, develop, feature/xxx, bugfix/xxx
- Build Maven, gestion stricte des versions
- Pipelines CI (build, tests, sonar, analyse de couverture)
- Pull request obligatoire

---

## üîó R√©f√©rences
- [10_project-architecture.mdc](mdc:10_project-architecture.mdc)
- [00_shared-prompts.mdc](mdc:00_shared-prompts.mdc)
